<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Time Pass</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap');

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  font-family: 'Poppins', sans-serif;
  color: #fff;
  overflow: hidden;
}

#vanta-bg {
  position: fixed;
  width: 100%;
  height: 100%;
  z-index: 0;
}

/* ===== NAVBAR PREMIUM ===== */
.navbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 80px;
  background: linear-gradient(180deg, rgba(10, 15, 35, 0.95), rgba(5, 10, 25, 0.85));
  backdrop-filter: blur(20px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 30px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
  z-index: 10;
  border-bottom: 2px solid rgba(255, 215, 0, 0.2);
}

.navbar .title-section {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.navbar .title {
  font-size: 26px;
  font-weight: 900;
  letter-spacing: 1px;
  background: linear-gradient(135deg, #FFD700, #FFA500, #FF6B6B);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
}

.navbar .subtitle {
  font-size: 11px;
  color: #8B9DC3;
  font-weight: 600;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.navbar .stats {
  display: flex;
  gap: 15px;
  align-items: center;
}

.stat-box {
  display: flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.15));
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255, 215, 0, 0.4);
  padding: 10px 18px;
  border-radius: 20px;
  font-weight: 900;
  font-size: 16px;
  box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3),
              inset 0 2px 5px rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.stat-box:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
}

.stat-icon {
  font-size: 20px;
  filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.8));
}

/* ===== PROGRESS BAR ===== */
.progress-container {
  position: fixed;
  top: 80px;
  left: 0;
  right: 0;
  padding: 20px 30px;
  background: linear-gradient(180deg, rgba(10, 15, 35, 0.9), transparent);
  backdrop-filter: blur(10px);
  z-index: 9;
}

.progress-wrapper {
  max-width: 800px;
  margin: 0 auto;
}

.progress-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 13px;
  font-weight: 700;
  color: #B0C4DE;
}

.progress-bar-bg {
  height: 12px;
  background: rgba(20, 25, 45, 0.8);
  border-radius: 10px;
  overflow: hidden;
  border: 2px solid rgba(255, 215, 0, 0.3);
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.6);
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #FFD700, #FFA500, #FF6B6B);
  border-radius: 8px;
  width: 0%;
  transition: width 0.5s ease;
  box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
  position: relative;
  overflow: hidden;
}

.progress-bar-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { left: -100%; }
  100% { left: 100%; }
}

/* ===== CONTAINER ===== */
.container {
  position: absolute;
  top: 160px;
  bottom: 0;
  left: 0;
  right: 0;
  overflow-y: auto;
  padding: 20px 20px 40px;
  z-index: 1;
}

.container::-webkit-scrollbar {
  width: 10px;
}

.container::-webkit-scrollbar-track {
  background: rgba(10, 15, 35, 0.5);
}

.container::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #FFD700, #FFA500);
  border-radius: 10px;
}

/* ===== PASS LEVELS ===== */
.pass {
  max-width: 900px;
  margin: auto;
  display: grid;
  gap: 16px;
}

.level {
  background: linear-gradient(145deg, rgba(25, 35, 60, 0.9), rgba(15, 25, 50, 0.95));
  backdrop-filter: blur(15px);
  border-radius: 20px;
  padding: 20px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 2px solid rgba(100, 120, 180, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.level::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.1), transparent);
  transition: left 0.5s;
}

.level:hover::before {
  left: 100%;
}

.level:hover {
  transform: translateX(8px) scale(1.02);
  border-color: rgba(255, 215, 0, 0.5);
  box-shadow: 0 12px 40px rgba(255, 215, 0, 0.3);
}

.level.locked {
  opacity: 0.4;
  filter: grayscale(0.8);
}

.level.locked::after {
  content: 'üîí';
  position: absolute;
  right: 24px;
  font-size: 32px;
  opacity: 0.3;
}

.level.unlocked {
  border-color: rgba(255, 215, 0, 0.6);
  box-shadow: 0 8px 32px rgba(255, 215, 0, 0.2);
  opacity: 1;
}

.level.unlock-effect {
  animation: unlockPulse 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes unlockPulse {
  0% { 
    transform: scale(1);
    box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
  }
  50% { 
    transform: scale(1.08);
    box-shadow: 0 0 40px 20px rgba(255, 215, 0, 0.4);
  }
  100% { 
    transform: scale(1);
    box-shadow: 0 8px 32px rgba(255, 215, 0, 0.2);
  }
}

.level-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.level-number {
  font-size: 32px;
  font-weight: 900;
  background: linear-gradient(135deg, #FFD700, #FFA500);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
  min-width: 60px;
  text-align: center;
}

.level-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.level-title {
  font-weight: 700;
  font-size: 16px;
  color: #E8F0FF;
}

.level-hours {
  font-size: 12px;
  color: #8B9DC3;
  font-weight: 600;
}

.reward {
  background: linear-gradient(135deg, #FFD700, #FFA500, #FF6B6B);
  color: #1a1a2e;
  padding: 12px 24px;
  border-radius: 16px;
  font-weight: 900;
  font-size: 15px;
  box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4),
              inset 0 2px 5px rgba(255, 255, 255, 0.3);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  position: relative;
}

.reward:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
}

.reward.claimed {
  background: linear-gradient(135deg, #2ecc71, #27ae60);
  box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4);
  cursor: default;
}

.reward.claimed::after {
  content: '‚úì';
  position: absolute;
  right: -8px;
  top: -8px;
  background: #fff;
  color: #27ae60;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
  font-size: 14px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

.reward.locked {
  opacity: 0.5;
  cursor: not-allowed;
  pointer-events: none;
}

.reward-claim-effect {
  animation: claimReward 0.6s ease-out;
}

@keyframes claimReward {
  0% { 
    transform: scale(1) rotate(0deg);
  }
  25% { 
    transform: scale(1.2) rotate(-5deg);
  }
  50% { 
    transform: scale(1.3) rotate(5deg);
  }
  75% { 
    transform: scale(1.1) rotate(-2deg);
  }
  100% { 
    transform: scale(1) rotate(0deg);
  }
}

.reward-icon {
  font-size: 18px;
}

/* Milestones sp√©ciaux */
.level[data-milestone="true"] {
  background: linear-gradient(145deg, rgba(138, 43, 226, 0.3), rgba(75, 0, 130, 0.4));
  border: 3px solid rgba(186, 85, 211, 0.6);
}

.level[data-milestone="true"] .level-number {
  background: linear-gradient(135deg, #DA70D6, #BA55D3);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.level[data-milestone="true"] .reward {
  background: linear-gradient(135deg, #DA70D6, #BA55D3, #9370DB);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

/* Responsive */
@media (max-width: 768px) {
  .navbar {
    padding: 0 15px;
    height: 70px;
  }
  
  .navbar .title {
    font-size: 20px;
  }
  
  .stat-box {
    padding: 8px 12px;
    font-size: 14px;
  }
  
  .level {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }
  
  .reward {
    width: 100%;
    justify-content: center;
  }
}
</style>
</head>
<body>

<!-- VANTA BACKGROUND -->
<div id="vanta-bg"></div>

<!-- NAVBAR -->
<div class="navbar">
  <div class="title-section">
    <div class="title">TIME PASS</div>
    <div class="subtitle">TIME -> FDPi√®ces</div>
  </div>
  <button class="stat-box" style="color:white" onclick="window.open('../Hub_Shop/base_hub_shop.html','_self')">‚¨Ö retour</button>
  <div class="stats">
    <div class="stat-box">
      <span class="stat-icon">
        <img src="../../Image/FDPrice.png" alt="argent" style="width:1em; height:1em; vertical-align:middle;">
      </span>

      <span id="money">0</span>
    </div>
    <div class="stat-box">
      <span class="stat-icon">‚è±Ô∏è</span>
      <span id="hours-display">0h</span>
    </div>
  </div>
</div>

<!-- PROGRESS BAR -->
<div class="progress-container">
  <div class="progress-wrapper">
    <div class="progress-info">
      <span>Niveau <span id="current-level">0</span> / <span id="total-levels">90</span></span>
      <span id="progress-percent">0%</span>
    </div>
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progress-fill"></div>
    </div>
  </div>
</div>

<!-- CONTENT -->
<div class="container" id="container">
  <div class="pass" id="pass"></div>
</div>

<!-- Scripts -->
<script src="../../script/script_inspecter.js"></script>
<script src="../script/script_affichage_raccourcis.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>

<script>
// =======================
// VANTA.JS BACKGROUND
// =======================
VANTA.WAVES({
  el: "#vanta-bg",
  mouseControls: true,
  touchControls: true,
  gyroControls: false,
  minHeight: 200.00,
  minWidth: 200.00,
  scale: 1.00,
  scaleMobile: 1.00,
  color: 0x1a1f3a,
  shininess: 40.00,
  waveHeight: 15.00,
  waveSpeed: 0.75,
  zoom: 0.65
});

// =======================
// VARIABLES
// =======================
let heures = 0;
URL_SERVER ="https://project-3-api-2bgb.onrender.com"
const username = localStorage.getItem('username');
let argent = 0;
let lastClaimedLevel = 0; // <-- derni√®re r√©compense r√©cup√©r√©e

const TOTAL_LEVELS = 90;
const HOURS_PER_LEVEL = 1;

// =======================
// CHARGER DERNI√àRE RECOMPENSE DE L'UTILISATEUR
// =======================
async function fetchLastClaimed(username) {
  try {
    const response = await fetch(`${URL_SERVER}/get_evo_pass`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username })
    });
    const data = await response.json();
    console.log(data)
    if (data.status === 'success') {
      lastClaimedLevel = data.Pass || 0;
      claimedRewards.length = 0;
      for (let i = 1; i <= lastClaimedLevel; i++) {
        claimedRewards.push(i);
        const rewardDiv = document.querySelector(`.reward[data-level="${i}"]`);
        if (rewardDiv) {
          rewardDiv.classList.add('claimed');
          rewardDiv.classList.remove('locked');
        }
      }
      console.log('reward recup√©r√©s :',lastClaimedLevel);
    }
  } catch (err) {
    console.error('Erreur fetch last claimed:', err);
  }
}




// =======================
// ENVOYER LA DERNI√àRE RECOMPENSE R√âCUP√âR√âE
// =======================
async function sendClaimedLevel(username, level) {
  try {
      await fetch(`${URL_SERVER}/set_evo_pass`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username : username, Pass: level })
    });
  } catch (err) {
    console.error('Erreur send claimed level:', err);
  }
}
async function sendFDPrice(username, value) {
  try {
    const response = await fetch(`${URL_SERVER}/send_FDPrice`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, FDPiece: value }) // value peut √™tre positif ou n√©gatif
    });

    const data = await response.json();
    if (data.status === 'success') {
      argent = data.FDPiece; // nouvelle valeur retourn√©e par le serveur
      moneyUI.textContent = argent.toLocaleString();
      console.log('FDPi√®ces mises √† jour :', argent);
    } else {
      console.error('Erreur serveur :', data.message);
    }

  } catch (err) {
    console.error('Erreur send FDPrice:', err);
  }
}

// correction a faire:
// - lire nombre dans Pass pour pas recuperer 2fois meme recompense
// - gestion argent , pas de remlacement mais une somme
// - ajouter route get_FDPiece


// =======================
// D√âFINITION DES R√âCOMPENSES PAR NIVEAU
// =======================
const LEVEL_REWARDS = [
  { level: 1, icon: '‚≠ê', name: '10 FDPi√®ces', value: 10, onClaim: function() { showNotification('+10 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 10); sendClaimedLevel(username, 1) } },
  { level: 2, icon: '‚≠ê', name: '10 FDPi√®ces', value: 10, onClaim: function() { showNotification('+10 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 10); sendClaimedLevel(username, 2) } },
  { level: 3, icon: '‚≠ê', name: '10 FDPi√®ces', value: 10, onClaim: function() { showNotification('+10 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 10); sendClaimedLevel(username, 3) } },
  { level: 4, icon: '‚≠ê', name: '10 FDPi√®ces', value: 10, onClaim: function() { showNotification('+10 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 10); sendClaimedLevel(username, 4) } },
  { level: 5, icon: '‚≠ê', name: '10 FDPi√®ces', value: 10, onClaim: function() { showNotification('+10 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 10); sendClaimedLevel(username, 5) } },
  { level: 6, icon: '‚≠ê', name: '10 FDPi√®ces', value: 10, onClaim: function() { showNotification('+10 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 10); sendClaimedLevel(username, 6) } },
  { level: 7, icon: '‚≠ê', name: '10 FDPi√®ces', value: 10, onClaim: function() { showNotification('+10 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 10); sendClaimedLevel(username, 7) } },
  { level: 8, icon: '‚≠ê', name: '10 FDPi√®ces', value: 10, onClaim: function() { showNotification('+10 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 10); sendClaimedLevel(username, 8) } },
  { level: 9, icon: '‚≠ê', name: '10 FDPi√®ces', value: 10, onClaim: function() { showNotification('+10 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 10); sendClaimedLevel(username, 9) } },
  { level: 10, icon: '‚≠ê', name: '25 FDPi√®ces', value: 25, onClaim: function() { showNotification('+25 FDPi√®ces r√©cup√©r√©es !', '‚≠ê'); sendFDPrice(username, 25); sendClaimedLevel(username, 10) } },
  
  { level: 11, icon: 'üõ°Ô∏è', name: '15 FDPi√®ces', value: 15, onClaim: function() { showNotification('+15 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 15); sendClaimedLevel(username, 11) } },
  { level: 12, icon: 'üõ°Ô∏è', name: '15 FDPi√®ces', value: 15, onClaim: function() { showNotification('+15 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 15); sendClaimedLevel(username, 12) } },
  { level: 13, icon: 'üõ°Ô∏è', name: '15 FDPi√®ces', value: 15, onClaim: function() { showNotification('+15 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 15); sendClaimedLevel(username, 13) } },
  { level: 14, icon: 'üõ°Ô∏è', name: '15 FDPi√®ces', value: 15, onClaim: function() { showNotification('+15 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 15); sendClaimedLevel(username, 14) } },
  { level: 15, icon: 'üõ°Ô∏è', name: '15 FDPi√®ces', value: 15, onClaim: function() { showNotification('+15 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 15); sendClaimedLevel(username, 15) } },
  { level: 16, icon: 'üõ°Ô∏è', name: '15 FDPi√®ces', value: 15, onClaim: function() { showNotification('+15 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 15); sendClaimedLevel(username, 16) } },
  { level: 17, icon: 'üõ°Ô∏è', name: '15 FDPi√®ces', value: 15, onClaim: function() { showNotification('+15 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 15); sendClaimedLevel(username, 17) } },
  { level: 18, icon: 'üõ°Ô∏è', name: '15 FDPi√®ces', value: 15, onClaim: function() { showNotification('+15 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 15); sendClaimedLevel(username, 18) } },
  { level: 19, icon: 'üõ°Ô∏è', name: '15 FDPi√®ces', value: 15, onClaim: function() { showNotification('+15 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 15); sendClaimedLevel(username, 19) } },
  { level: 20, icon: 'üõ°Ô∏è', name: '30 FDPi√®ces', value: 30, onClaim: function() { showNotification('+30 FDPi√®ces r√©cup√©r√©es !', 'üõ°Ô∏è'); sendFDPrice(username, 30); sendClaimedLevel(username, 20) } },

  { level: 21, icon: 'üíé', name: 'Gemmes', value: 250, onClaim: function() { argent += 2500; moneyUI.textContent = argent.toLocaleString(); showNotification('+2500üí∞ Gemmes r√©cup√©r√©es !', 'üíé'); } },
  { level: 22, icon: 'üíé', name: 'Badge', value: 1, onClaim: function() { showNotification('Badge "Expert" d√©bloqu√© !', 'üéØ'); console.log('Badge Expert d√©bloqu√©'); } },
  { level: 23, icon: 'üíé', name: 'Coffre', value: 1, onClaim: function() { argent += 2500; moneyUI.textContent = argent.toLocaleString(); showNotification('Coffre ouvert ! +2500üí∞', 'üéÅ'); } },
  { level: 24, icon: 'üíé', name: '√âtoiles', value: 125, onClaim: function() { argent += 1000; moneyUI.textContent = argent.toLocaleString(); showNotification('+1000üí∞ √âtoiles r√©cup√©r√©es !', '‚≠ê'); } },
  { level: 25, icon: 'üíé', name: 'R√©compense L√©gendaire', value: 2500, onClaim: function() { argent += 10000; moneyUI.textContent = argent.toLocaleString(); showNotification('L√âGENDAIRE ! +10000üí∞', 'üëë'); } },
  { level: 26, icon: 'üíé', name: 'Gemmes', value: 300, onClaim: function() { argent += 3000; moneyUI.textContent = argent.toLocaleString(); showNotification('+3000üí∞ Gemmes r√©cup√©r√©es !', 'üíé'); } },
  { level: 27, icon: 'üíé', name: 'Troph√©e', value: 250, onClaim: function() { argent += 1250; moneyUI.textContent = argent.toLocaleString(); showNotification('+1250üí∞ Troph√©e r√©cup√©r√© !', 'üèÜ'); } },
  { level: 28, icon: 'üíé', name: 'Boost XP', value: 4, onClaim: function() { showNotification('Boost XP x4 activ√© !', 'üî•'); console.log('Boost XP x4 activ√©'); } },
  { level: 29, icon: 'üíé', name: '√âtoiles', value: 150, onClaim: function() { argent += 1200; moneyUI.textContent = argent.toLocaleString(); showNotification('+1200üí∞ √âtoiles r√©cup√©r√©es !', '‚≠ê'); } },
  { level: 30, icon: 'üíé', name: 'Le droit de te faire enculer', value: 0, onClaim: function() { argent += 5000; moneyUI.textContent = argent.toLocaleString(); showNotification('Coffre √âpique ouvert ! +5000üí∞', 'üéÅ'); } },
  
];


// Fonction pour afficher une notification
function showNotification(text, icon) {
  const notif = document.createElement('div');
  notif.style.cssText = `
    position: fixed;
    top: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: white;
    padding: 16px 32px;
    border-radius: 12px;
    font-weight: 900;
    font-size: 18px;
    box-shadow: 0 8px 32px rgba(46, 204, 113, 0.6);
    z-index: 1000;
    animation: slideDown 0.5s ease-out;
  `;
  notif.textContent = `${icon} ${text}`;
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.style.animation = 'slideUp 0.5s ease-out';
    setTimeout(() => notif.remove(), 500);
  }, 2000);
}

// Animations pour notifications
const style = document.createElement('style');
style.textContent = `
  @keyframes slideDown {
    from { top: -100px; opacity: 0; }
    to { top: 100px; opacity: 1; }
  }
  @keyframes slideUp {
    from { top: 100px; opacity: 1; }
    to { top: -100px; opacity: 0; }
  }
`;
document.head.appendChild(style);

// Paliers sp√©ciaux (milestones)
const milestones = [10, 25, 50, 75, 90];

const pass = document.getElementById("pass");
const moneyUI = document.getElementById("money");
const hoursDisplay = document.getElementById("hours-display");
const currentLevelUI = document.getElementById("current-level");
const totalLevelsUI = document.getElementById("total-levels");
const progressPercentUI = document.getElementById("progress-percent");
const progressFill = document.getElementById("progress-fill");

moneyUI.textContent = argent.toLocaleString();
totalLevelsUI.textContent = TOTAL_LEVELS;

// Niveau actuel bas√© sur les heures
let currentLevel = 0;

// Mise √† jour imm√©diate de l'UI
currentLevelUI.textContent = currentLevel;
const initialProgressPercent = Math.round((currentLevel / TOTAL_LEVELS) * 100);
progressPercentUI.textContent = initialProgressPercent + '%';
progressFill.style.width = initialProgressPercent + '%';
hoursDisplay.textContent = Math.floor(heures) + 'h';

// =======================
// CR√âATION DES NIVEAUX
// =======================
const levels = [];
const claimedRewards = []; // Tableau simple sans localStorage

for (let i = 1; i <= TOTAL_LEVELS; i++) {
  const div = document.createElement("div");
  div.className = i <= currentLevel ? "level unlocked" : "level locked";
  div.id = "level-" + i;
  
  const isMilestone = milestones.includes(i);
  if (isMilestone) {
    div.setAttribute("data-milestone", "true");
  }
  
  const rewardData = LEVEL_REWARDS.find(r => r.level === i);
  
  if (!rewardData) continue;
  
  const rewardText = rewardData.value > 1 
    ? `${rewardData.name} x${rewardData.value}`
    : rewardData.name;
  
  div.innerHTML = `
    <div class="level-left">
      <div class="level-number">${i}</div>
      <div class="level-info">
        <div class="level-title">Niveau ${i}</div>
        <div class="level-hours">${i * HOURS_PER_LEVEL}h requises</div>
      </div>
    </div>
    <div class="reward ${i <= lastClaimedLevel ? 'claimed locked' : i === lastClaimedLevel + 1 && i <= currentLevel ? '' : 'locked'}" data-level="${i}">



      <span class="reward-icon">${rewardData.icon}</span>
      <span>${rewardText}</span>
    </div>
  `;
  
  pass.appendChild(div);
  levels.push(div);
  
  const rewardBtn = div.querySelector('.reward');
  rewardBtn.addEventListener('click', async function() {
    const levelNum = parseInt(this.getAttribute('data-level'));
    
    // V√©rifie ordre des r√©compenses
    if (levelNum <= lastClaimedLevel) return;

    if (levelNum !== lastClaimedLevel + 1) {
      showNotification('Vous devez r√©cup√©rer les r√©compenses dans l‚Äôordre !', '‚ö†Ô∏è');
      return;
    }


    if (claimedRewards.includes(levelNum)) return;

    
    const reward = LEVEL_REWARDS.find(r => r.level === levelNum);
    if (reward && reward.onClaim) {
      reward.onClaim();
      this.classList.add('claimed', 'reward-claim-effect');
      claimedRewards.push(levelNum);
      lastClaimedLevel = levelNum;
      await sendClaimedLevel(username, lastClaimedLevel); // envoyer au serveur
      
      setTimeout(() => this.classList.remove('reward-claim-effect'), 600);
    }
  });
  
  if (claimedRewards.includes(i)) {
    rewardBtn.classList.remove('locked');
    rewardBtn.classList.add('claimed');
  }
}

// =======================
// UPDATE SYST√àME
// =======================
function updateLevels() {
  const newLevel = Math.min(
    TOTAL_LEVELS,
    Math.max(0, Math.floor(heures / HOURS_PER_LEVEL))
  );

  if (newLevel > currentLevel) {
    for (let i = currentLevel + 1; i <= newLevel; i++) {
      const lvl = levels[i - 1];
      lvl.classList.add("unlock-effect");
      setTimeout(() => lvl.classList.remove("unlock-effect"), 800);
    }
  }

  currentLevel = newLevel;

  levels.forEach((lvl, i) => {
    const rewardBtn = lvl.querySelector('.reward');
    if (i + 1 <= currentLevel) {
      lvl.classList.remove("locked");
      lvl.classList.add("unlocked");
      if (!claimedRewards.includes(i + 1)) rewardBtn.classList.remove('locked');
    } else {
      lvl.classList.remove("unlocked");
      lvl.classList.add("locked");
      if (!rewardBtn.classList.contains('claimed')) rewardBtn.classList.add('locked');
    }
  });

  currentLevelUI.textContent = currentLevel;
  const progressPercent = Math.round((currentLevel / TOTAL_LEVELS) * 100);
  progressPercentUI.textContent = progressPercent + '%';
  progressFill.style.width = progressPercent + '%';
  
  hoursDisplay.textContent = Math.floor(heures) + 'h';
}

function autoScroll() {
  if (currentLevel > 0) {
    const target = document.getElementById("level-" + currentLevel);
    if (target) target.scrollIntoView({ behavior: "smooth", block: "center" });
  } else if (currentLevel === 0) {
    const container = document.getElementById("container");
    container.scrollTop = 0;
  }
}

// =======================
// CHECK CONTINU
// =======================
setInterval(() => { updateLevels(); }, 500);

// =======================
// INITIALISATION IMM√âDIATE
// =======================

updateLevels();
console.log("init");
fetchLastClaimed(username);
setTimeout(() => { autoScroll(); }, 100);

// =======================
// TEST (√† d√©commenter pour tester)
// =======================
setInterval(() => {const heure = Math.floor(window.elapsedTime / 3600); heures = heure}, 3000);
setInterval(() => {FDPiece = window.FDPiece; document.getElementById('money').value = window.FDPiece.toLocaleString() }, 3000);
</script>

</body>
</html>