<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Level Devil</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
    background:radial-gradient(circle at top,#1a1a1a,#000);
    font-family:Arial;
    overflow:hidden;
}
canvas{
    display:block;
    margin:auto;
    background:#0d0d0d;
    border:2px solid #ff0033;
    box-shadow:0 0 40px #ff0033;
}
#ui{
    position:absolute;
    top:15px;
    left:20px;
    color:white;
    font-weight:bold;
}
</style>
</head>
<body>

<div id="ui">Niveau 1</div>
<canvas id="game" width="900" height="500"></canvas>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
const ui=document.getElementById("ui");

let audioCtx=new (window.AudioContext||window.webkitAudioContext)();

function sound(freq,duration){
    let osc=audioCtx.createOscillator();
    let gain=audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value=freq;
    osc.type="square";
    gain.gain.value=0.1;
    osc.start();
    osc.stop(audioCtx.currentTime+duration);
}

let keys={},gravity=0.7,levelNumber=1,windForce=0;
let particles=[],trails=[];
let animTime=0;
let facing=1;
let turnAnim=0;

document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);

let player,level;

function initLevel(){
    player={x:60,y:400,w:24,h:42,dx:0,dy:0,grounded:false};
    windForce = levelNumber>15 ? (Math.random()<0.5?-0.3:0.3) : 0;
    level={platforms:[],fragile:[],spikes:[],fireballs:[],lasers:[],goal:{x:820,y:400,w:40,h:70}};
    generateLevel();
    ui.innerText="Niveau "+levelNumber;
    sound(300,0.1);
}

function generateLevel(){
    let d=levelNumber;
    for(let i=0;i<5+d;i++)
        level.platforms.push({x:Math.random()*750+50,y:Math.random()*350+80,w:80,h:10});
    for(let i=0;i<d+2;i++)
        level.spikes.push({x:Math.random()*850,y:470,size:22});
    if(d>5)
        for(let i=0;i<d/2;i++)
            level.fireballs.push({x:Math.random()*800,y:Math.random()*300+50,r:10,dir:Math.random()<0.5?1:-1});
    if(d>10)
        level.lasers.push({y:Math.random()*350+50,active:true,timer:0});
    if(d>8)
        for(let i=0;i<d/3;i++)
            level.fragile.push({x:Math.random()*800,y:Math.random()*350+80,w:70,h:10,timer:0});
}

function reset(){
    sound(80,0.2);
    for(let i=0;i<20;i++)
        particles.push({x:player.x,y:player.y,dx:(Math.random()-0.5)*6,dy:(Math.random()-0.5)*6,life:30});
    initLevel();
}

function nextLevel(){
    levelNumber++;
    sound(600,0.15);
    initLevel();
}

function update(){
    animTime+=0.15;

    player.dx=0;
    if(keys["ArrowLeft"]) player.dx=-4;
    if(keys["ArrowRight"]) player.dx=4;

    if(player.dx!==0){
        let newFacing = player.dx<0?-1:1;
        if(newFacing!==facing){
            facing=newFacing;
            turnAnim=10;
        }
    }

    if(turnAnim>0) turnAnim--;

    if(keys["ArrowUp"] && player.grounded){
        player.dy=-14;
        player.grounded=false;
        sound(500,0.1);
        for(let i=0;i<8;i++)
            particles.push({x:player.x+10,y:player.y+40,dx:(Math.random()-0.5)*4,dy:Math.random()*3,life:20});
    }

    player.dy+=gravity;
    player.x+=player.dx+windForce;
    player.y+=player.dy;
    player.grounded=false;

    if(player.y+player.h>=470){
        if(player.dy>10) sound(120,0.05);
        player.y=470-player.h;
        player.dy=0;
        player.grounded=true;
    }

    for(let p of level.platforms)
        if(collide(player,p)&&player.dy>=0){
            player.y=p.y-player.h;
            player.dy=0;
            player.grounded=true;
        }

    for(let f of level.fragile)
        if(collide(player,f)){
            f.timer++;
            if(f.timer>25) f.y+=5;
            else{
                player.y=f.y-player.h;
                player.dy=0;
                player.grounded=true;
            }
        }

    for(let s of level.spikes)
        if(rectTriangleCollide(player,s)) reset();

    for(let fb of level.fireballs){
        fb.x+=2*fb.dir;
        if(fb.x<0||fb.x>900) fb.dir*=-1;
        trails.push({x:fb.x,y:fb.y,life:15});
        if(circleRectCollision(fb,player)) reset();
    }

    for(let l of level.lasers){
        l.timer++;
        if(l.timer>120){l.active=!l.active;l.timer=0;sound(200,0.05);}
        if(l.active&&player.y<l.y+5&&player.y+player.h>l.y-5) reset();
    }

    if(collide(player,level.goal)) nextLevel();

    particles.forEach(p=>{p.x+=p.dx;p.y+=p.dy;p.life--;});
    particles=particles.filter(p=>p.life>0);

    trails.forEach(t=>t.life--);
    trails=trails.filter(t=>t.life>0);
}

function collide(a,b){
    return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;
}

function rectTriangleCollide(rect,spike){
    return rect.x<spike.x+spike.size&&
           rect.x+rect.w>spike.x&&
           rect.y+rect.h>spike.y-spike.size&&
           rect.y<spike.y;
}

function circleRectCollision(circle,rect){
    let dx=circle.x-(rect.x+rect.w/2);
    let dy=circle.y-(rect.y+rect.h/2);
    return Math.abs(dx)<rect.w/2+circle.r &&
           Math.abs(dy)<rect.h/2+circle.r;
}

/* PERSONNAGE — animations améliorées */

function drawPlayer(){
    let x=player.x;
    let y=player.y;

    let walkCycle=Math.sin(animTime*10);
    let speedFactor=Math.abs(player.dx)/4;

    let legSwing=walkCycle*12*speedFactor;
    let armSwing=-walkCycle*15*speedFactor;

    let jumpTilt = !player.grounded ? player.dy*0.8 : 0;
    let squash = player.grounded ? 1 : 1.1;
    let stretch = player.grounded ? 1 : 0.9;

    ctx.save();
    ctx.translate(x+player.w/2,y);
    
    let flipScale = turnAnim>0 ? (1 - turnAnim/10) : 1;
    ctx.scale(facing*flipScale,1);

    ctx.rotate(jumpTilt*Math.PI/180);

    ctx.shadowColor="#00ffff";
    ctx.shadowBlur=25;

    // Corps
    ctx.scale(stretch,squash);
    ctx.fillStyle="#00ffff";
    ctx.fillRect(-8,-6,16,28);
    ctx.setTransform(1,0,0,1,0,0);

    ctx.save();
    ctx.translate(x+player.w/2,y);
    ctx.scale(facing*flipScale,1);
    ctx.rotate(jumpTilt*Math.PI/180);

    // Tête
    let headBob = player.grounded ? Math.abs(walkCycle)*2 : 0;
    ctx.beginPath();
    ctx.arc(0,-18-headBob,12,0,Math.PI*2);
    ctx.fill();

    ctx.shadowBlur=0;
    ctx.fillStyle="black";
    ctx.beginPath();
    ctx.arc(-4,-20-headBob,2,0,Math.PI*2);
    ctx.arc(4,-20-headBob,2,0,Math.PI*2);
    ctx.fill();

    ctx.shadowBlur=20;
    ctx.fillStyle="#00ffff";

    // Bras
    ctx.save();
    ctx.translate(-8,-4);
    ctx.rotate((armSwing*Math.PI)/180);
    ctx.fillRect(-3,0,6,20);
    ctx.restore();

    ctx.save();
    ctx.translate(8,-4);
    ctx.rotate((-armSwing*Math.PI)/180);
    ctx.fillRect(-3,0,6,20);
    ctx.restore();

    // Jambes
    ctx.save();
    ctx.translate(-4,22);
    ctx.rotate((legSwing*Math.PI)/180);
    ctx.fillRect(-3,0,6,20);
    ctx.restore();

    ctx.save();
    ctx.translate(4,22);
    ctx.rotate((-legSwing*Math.PI)/180);
    ctx.fillRect(-3,0,6,20);
    ctx.restore();

    ctx.restore();
}

/* FIN PERSONNAGE */

function draw(){
    ctx.clearRect(0,0,900,500);

    ctx.fillStyle="#222";
    ctx.fillRect(0,470,900,5);

    ctx.fillStyle="#666";
    level.platforms.forEach(p=>ctx.fillRect(p.x,p.y,p.w,p.h));

    ctx.fillStyle="#aa5500";
    level.fragile.forEach(f=>ctx.fillRect(f.x,f.y,f.w,f.h));

    level.spikes.forEach(s=>{
        ctx.shadowColor="red";
        ctx.shadowBlur=15;
        ctx.fillStyle="#ff0033";
        ctx.beginPath();
        ctx.moveTo(s.x,470);
        ctx.lineTo(s.x+s.size/2,470-s.size);
        ctx.lineTo(s.x+s.size,470);
        ctx.fill();
        ctx.shadowBlur=0;
    });

    trails.forEach(t=>{
        ctx.globalAlpha=t.life/15;
        ctx.fillStyle="orange";
        ctx.beginPath();
        ctx.arc(t.x,t.y,8,0,Math.PI*2);
        ctx.fill();
        ctx.globalAlpha=1;
    });

    ctx.fillStyle="orange";
    level.fireballs.forEach(f=>{
        ctx.beginPath();
        ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
        ctx.fill();
    });

    ctx.strokeStyle="magenta";
    ctx.lineWidth=4;
    level.lasers.forEach(l=>{
        if(l.active){
            ctx.shadowColor="magenta";
            ctx.shadowBlur=20;
            ctx.beginPath();
            ctx.moveTo(0,l.y);
            ctx.lineTo(900,l.y);
            ctx.stroke();
            ctx.shadowBlur=0;
        }
    });

    ctx.fillStyle="#00ff00";
    ctx.shadowColor="#00ff00";
    ctx.shadowBlur=20;
    ctx.fillRect(level.goal.x,level.goal.y,level.goal.w,level.goal.h);
    ctx.shadowBlur=0;

    drawPlayer();

    ctx.fillStyle="white";
    particles.forEach(p=>ctx.fillRect(p.x,p.y,3,3));
}

function loop(){
    update();
    draw();
    requestAnimationFrame(loop);
}

initLevel();
loop();
</script>
</body>
</html>
