<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kingdom Defense: Vanguard</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=MedievalSharp&display=swap" rel="stylesheet">
    <style>
        :root { --gold: #ffd700; --blood: #990000; --stone: #2c2c2c; --paper: #f4e4bc; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #050505; color: white; font-family: 'MedievalSharp', cursive; overflow: hidden; }
        #game-container { display: flex; width: 100vw; height: 100vh; }
        #viewport { flex-grow: 1; position: relative; background: #111; overflow: hidden; cursor: crosshair; }
        canvas { display: block; }
        
        /* UI Style */
        #ui-panel { width: 300px; background: var(--paper); border-left: 5px solid var(--gold); display: flex; flex-direction: column; padding: 20px; box-shadow: -10px 0 30px rgba(0,0,0,0.5); color: #2c1b0e; z-index: 10; }
        .stat-box { display: flex; justify-content: space-around; background: #1a1a1a; padding: 12px; border: 2px solid var(--gold); border-radius: 8px; margin-bottom: 20px; color: var(--gold); font-size: 1.2rem; }
        .tower-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tower-card { background: rgba(255,255,255,0.7); border: 2px solid #5d4037; padding: 10px; cursor: pointer; text-align: center; transition: 0.2s; }
        .tower-card:hover { transform: translateY(-3px); background: #fff; }
        .tower-card.active { border-color: var(--gold); box-shadow: 0 0 15px var(--gold); background: #fff; }
        .btn { width: 100%; padding: 15px; margin-top: 10px; background: var(--blood); color: white; border: 2px solid var(--gold); cursor: pointer; font-family: 'Cinzel'; font-size: 1rem; }
        .btn:hover:not(:disabled) { filter: brightness(1.3); }
        #upgrade-menu { margin-top: auto; padding: 15px; border: 2px dashed #5d4037; display: none; background: #eee5d0; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="viewport"><canvas id="canvas"></canvas></div>
    <div id="ui-panel">
        <h2 style="font-family:'Cinzel'; text-align:center; margin-top:0;">VANGUARD</h2>
        <div class="stat-box">
            <span>üè∞ <b id="hp-val">25</b></span>
            <span>üí∞ <b id="gold-val">300</b></span>
        </div>
        <div class="tower-grid" id="tower-list"></div>
        <div id="upgrade-menu">
            <b id="up-name">Tour</b><br>
            <small id="up-stats"></small>
            <button class="btn" id="up-btn" style="padding:5px; font-size:0.8rem;"></button>
        </div>
        <button id="wave-btn" class="btn" onclick="startWave()">SONNER LE COR (VAGUE 1)</button>
    </div>
</div>

<script>
const TOWER_TYPES = [
    { name: "Guet", cost: 60, range: 160, rate: 30, dmg: 5, color: "#4ade80", type: "bolt" },
    { name: "Givre", cost: 120, range: 130, rate: 45, dmg: 3, color: "#38bdf8", type: "ice" },
    { name: "Canon", cost: 200, range: 180, rate: 80, dmg: 20, color: "#fb923c", type: "aoe" },
    { name: "Mystique", cost: 400, range: 220, rate: 10, dmg: 2, color: "#a855f7", type: "beam" }
];

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let w, h, scale, gold = 300, hp = 25, wave = 0;
let towers = [], enemies = [], projectiles = [], particles = [], shake = 0;
let selectedIdx = 0, activeT = null, mx = 0, my = 0;

const path = [{x:-50,y:500}, {x:250,y:500}, {x:250,y:200}, {x:750,y:200}, {x:750,y:800}, {x:1050,y:800}];

function resize() {
    w = canvas.parentElement.clientWidth; h = canvas.parentElement.clientHeight;
    canvas.width = w; canvas.height = h; scale = w / 1000;
}
window.addEventListener('resize', resize);
resize();

class Enemy {
    constructor(wNum) {
        this.prog = 0;
        this.wNum = wNum;
        // Difficult√©e punitive : HP augmente de fa√ßon exponentielle apr√®s la vague 5
        this.maxHp = 20 + Math.pow(wNum, 2.2) * 4;
        this.hp = this.maxHp;
        this.speed = (1.5 + wNum * 0.1) * scale;
        this.slowed = 0;
        this.anim = 0; // Pour l'animation de marche
    }
    update() {
        if(this.slowed > 0) this.slowed--;
        this.prog += (this.slowed > 0 ? this.speed * 0.4 : this.speed);
        this.anim += 0.15;
        if(this.prog >= 1000) this.die(true);
    }
    draw() {
        const p = getPoint(this.prog);
        ctx.save();
        ctx.translate(p.x, p.y);
        
        // Animation de "bobbing" (marche)
        const walkY = Math.sin(this.anim) * 5 * scale;
        
        // Corps du monstre (Ombre)
        ctx.fillStyle = "rgba(0,0,0,0.3)";
        ctx.beginPath(); ctx.ellipse(0, 15*scale, 12*scale, 6*scale, 0, 0, Math.PI*2); ctx.fill();

        // Corps
        ctx.fillStyle = this.slowed > 0 ? "#38bdf8" : "#991b1b";
        ctx.beginPath();
        ctx.moveTo(-15*scale, 10*scale);
        ctx.quadraticCurveTo(0, -25*scale + walkY, 15*scale, 10*scale);
        ctx.fill();

        // Yeux
        ctx.fillStyle = "white";
        ctx.beginPath(); ctx.arc(-5*scale, -5*scale + walkY, 3*scale, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(5*scale, -5*scale + walkY, 3*scale, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "black";
        ctx.beginPath(); ctx.arc(-5*scale, -5*scale + walkY, 1.5*scale, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(5*scale, -5*scale + walkY, 1.5*scale, 0, Math.PI*2); ctx.fill();

        // Barre de vie stylis√©e
        ctx.fillStyle = "#000"; ctx.fillRect(-20*scale, -35*scale, 40*scale, 5*scale);
        ctx.fillStyle = "#22c55e"; ctx.fillRect(-20*scale, -35*scale, (this.hp/this.maxHp)*40*scale, 5*scale);
        ctx.restore();
    }
    die(end) {
        if(end) { hp--; shake = 15; } else { gold += 15 + Math.floor(this.wNum/2); spawnExplosion(this.prog, "#991b1b"); }
        enemies = enemies.filter(e => e !== this);
        updateUI();
        if(hp <= 0) { alert("Le Royaume est tomb√© √† la vague " + wave); location.reload(); }
    }
}

class Tower {
    constructor(x, y, type) {
        this.x = x; this.y = y; this.type = {...type};
        this.lvl = 1; this.cd = 0;
    }
    update() {
        if(this.cd > 0) this.cd--;
        else {
            let target = enemies.find(e => Math.hypot(getPoint(e.prog).x - this.x, getPoint(e.prog).y - this.y) < this.type.range * scale);
            if(target) {
                projectiles.push(new Projectile(this.x, this.y, target, this.type));
                this.cd = this.type.rate;
            }
        }
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        
        // Base de la tour (Pierre)
        ctx.fillStyle = "#444";
        ctx.fillRect(-22*scale, -20*scale, 44*scale, 40*scale);
        // Cr√©neaux
        ctx.fillStyle = "#333";
        for(let i=-22; i<20; i+=15) ctx.fillRect(i*scale, -28*scale, 8*scale, 10*scale);
        
        // Cristal magique / Ornement
        ctx.fillStyle = this.type.color;
        ctx.shadowBlur = 15; ctx.shadowColor = this.type.color;
        ctx.beginPath();
        ctx.moveTo(0, -15*scale); ctx.lineTo(10*scale, 0); ctx.lineTo(0, 15*scale); ctx.lineTo(-10*scale, 0);
        ctx.closePath(); ctx.fill();
        
        if(activeT === this) {
            ctx.strokeStyle = "rgba(255,255,255,0.3)"; ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.arc(0, 0, this.type.range * scale, 0, Math.PI*2); ctx.stroke();
        }
        ctx.restore();
    }
}

class Projectile {
    constructor(x, y, target, data) { this.x = x; this.y = y; this.target = target; this.data = data; }
    update() {
        const tp = getPoint(this.target.prog);
        const angle = Math.atan2(tp.y - this.y, tp.x - this.x);
        this.x += Math.cos(angle) * 15 * scale; this.y += Math.sin(angle) * 15 * scale;
        if(Math.hypot(tp.x - this.x, tp.y - this.y) < 20*scale) {
            this.target.hp -= this.data.dmg;
            if(this.data.type === "ice") this.target.slowed = 50;
            if(this.data.type === "aoe") {
                spawnExplosion(this.target.prog, "orange", 10);
                enemies.forEach(e => { if(Math.hypot(getPoint(e.prog).x - this.x, getPoint(e.prog).y - this.y) < 80*scale) e.hp -= 8; });
            }
            if(this.target.hp <= 0) this.target.die(false);
            projectiles = projectiles.filter(p => p !== this);
        }
    }
    draw() {
        ctx.fillStyle = this.data.color; ctx.shadowBlur = 10; ctx.shadowColor = this.data.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, 5*scale, 0, Math.PI*2); ctx.fill();
    }
}

function getPoint(prog) {
    const segments = path.length - 1;
    const idx = Math.min(Math.floor(prog / 1000 * segments), segments - 1);
    const sub = (prog / 1000 * segments) - idx;
    return { x: (path[idx].x + (path[idx+1].x - path[idx].x) * sub) * scale, y: (path[idx].y + (path[idx+1].y - path[idx].y) * sub) * scale };
}

function spawnExplosion(prog, color, count=15) {
    const p = getPoint(prog);
    for(let i=0; i<count; i++) particles.push({x:p.x, y:p.y, vx:(Math.random()-0.5)*8, vy:(Math.random()-0.5)*8, life:30, color});
}

function updateUI() {
    document.getElementById('hp-val').innerText = hp;
    document.getElementById('gold-val').innerText = gold;
    document.getElementById('wave-btn').innerText = `SONNER LE COR (VAGUE ${wave+1})`;
}

function startWave() {
    if(enemies.length > 0) return;
    wave++; updateUI();
    document.getElementById('wave-btn').disabled = true;
    let count = 8 + wave * 3;
    let timer = setInterval(() => {
        enemies.push(new Enemy(wave));
        if(--count <= 0) {
            clearInterval(timer);
            let check = setInterval(() => { if(enemies.length === 0) { document.getElementById('wave-btn').disabled = false; clearInterval(check); } }, 1000);
        }
    }, 800 - Math.min(wave * 20, 400));
}

canvas.addEventListener('mousemove', e => { const r = canvas.getBoundingClientRect(); mx = e.clientX - r.left; my = e.clientY - r.top; });
canvas.addEventListener('mousedown', () => {
    let clicked = towers.find(t => Math.hypot(t.x - mx, t.y - my) < 30 * scale);
    if(clicked) { activeT = clicked; showUp(clicked); return; }
    
    let type = TOWER_TYPES[selectedIdx];
    if(gold >= type.cost) {
        // Emp√™cher sur le chemin
        let onPath = false;
        for(let i=0; i<path.length-1; i++) {
            let d = distToSeg({x:mx/scale, y:my/scale}, path[i], path[i+1]);
            if(d < 45) onPath = true;
        }
        if(!onPath && !towers.some(t => Math.hypot(t.x-mx, t.y-my) < 50*scale)) {
            towers.push(new Tower(mx, my, type));
            gold -= type.cost; updateUI();
        }
    }
    activeT = null; document.getElementById('upgrade-menu').style.display = 'none';
});

function distToSeg(p, v, w) {
    let l2 = Math.pow(v.x - w.x, 2) + Math.pow(v.y - w.y, 2);
    if (l2 == 0) return Math.hypot(p.x - v.x, p.y - v.y);
    let t = Math.max(0, Math.min(1, ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2));
    return Math.hypot(p.x - (v.x + t * (w.x - v.x)), p.y - (v.y + t * (w.y - v.y)));
}

function showUp(t) {
    const m = document.getElementById('upgrade-menu'); m.style.display = 'block';
    const cost = t.lvl * 150;
    document.getElementById('up-name').innerText = `${t.type.name} (Rang ${t.lvl})`;
    document.getElementById('up-stats').innerText = `D√©g√¢ts: ${Math.round(t.type.dmg)} | Port√©e: ${Math.round(t.type.range)}`;
    document.getElementById('up-btn').innerText = `FORGER : ${cost}üí∞`;
    document.getElementById('up-btn').onclick = () => { if(gold >= cost) { gold -= cost; t.lvl++; t.type.dmg *= 1.4; t.type.range *= 1.15; updateUI(); showUp(t); } };
}

function loop() {
    ctx.fillStyle = "#111"; ctx.fillRect(0,0,w,h);
    if(shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.9; }

    // Chemin
    ctx.strokeStyle = "#222"; ctx.lineWidth = 70*scale; ctx.lineCap = "round"; ctx.lineJoin = "round";
    ctx.beginPath(); path.forEach((p, i) => { if(i===0) ctx.moveTo(p.x*scale, p.y*scale); else ctx.lineTo(p.x*scale, p.y*scale); }); ctx.stroke();
    ctx.strokeStyle = "#1a1a1a"; ctx.lineWidth = 60*scale; ctx.stroke();

    // Range preview placement
    if(!activeT) {
        ctx.fillStyle = "rgba(255,255,255,0.05)"; ctx.beginPath(); ctx.arc(mx, my, TOWER_TYPES[selectedIdx].range*scale, 0, Math.PI*2); ctx.fill();
    }

    towers.forEach(t => { t.update(); t.draw(); });
    enemies.forEach(e => { e.update(); e.draw(); });
    projectiles.forEach(p => { p.update(); p.draw(); });
    particles.forEach((p, i) => {
        p.x += p.vx; p.y += p.vy; p.life--;
        ctx.globalAlpha = p.life/30; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 3*scale, 3*scale);
        if(p.life <= 0) particles.splice(i, 1);
    });
    ctx.globalAlpha = 1; ctx.setTransform(1,0,0,1,0,0);
    requestAnimationFrame(loop);
}

const list = document.getElementById('tower-list');
TOWER_TYPES.forEach((t, i) => {
    const c = document.createElement('div'); c.className = `tower-card ${i===0?'active':''}`;
    c.innerHTML = `<b>${t.name}</b><br><span style="color:#1b5e20">${t.cost}üí∞</span>`;
    c.onclick = () => { selectedIdx = i; document.querySelectorAll('.tower-card').forEach(x => x.classList.remove('active')); c.classList.add('active'); };
    list.appendChild(c);
});

updateUI(); loop();
</script>
</body>
</html>