<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tableau de Bord Admin - Console de Jeu</title>
<style>
/* R√©utilisation et adaptation du style de connecte.html pour un look coh√©rent */
:root {
    --bg-color: #0b0c10;
    --card-bg: rgba(255, 255, 255, 0.05);
    --primary-color: #00bfff;
    --secondary-color: #1de9b6;
    --text-color: #fff;
    --light-text: #aaa;
    --border-color: #333;
    --shadow-color: rgba(0, 0, 0, 0.6);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif;}
body{background:var(--bg-color);color:var(--text-color);min-height:100vh;display:flex;flex-direction:column;}

/* Structure principale */
.dashboard-container {
    display: flex;
    flex-grow: 1;
    padding-top: 60px;
}

/* En-t√™te (style Search Console) */
.header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    padding: 0 20px;
    border-bottom: 1px solid var(--border-color);
    z-index: 1000;
}
.header-logo {
    font-size: 24px;
    font-weight: bold;
    color: var(--primary-color);
    margin-right: 40px;
}
.header-title {
    font-size: 18px;
    color: var(--light-text);
}

/* Barre Lat√©rale (Navigation) */
.sidebar {
    width: 250px;
    background: rgba(0, 0, 0, 0.3);
    padding: 20px 0;
    border-right: 1px solid var(--border-color);
    flex-shrink: 0;
    transition: width 0.3s ease;
}
.nav-group-title {
    color: var(--light-text);
    padding: 10px 20px 5px;
    font-size: 12px;
    text-transform: uppercase;
    font-weight: 600;
}
.nav-item {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 15px;
    transition: background 0.2s, color 0.2s;
    color: var(--light-text);
    border-left: 3px solid transparent;
}
.nav-item:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--text-color);
}
.nav-item.active {
    background: rgba(0, 191, 255, 0.1);
    color: var(--primary-color);
    border-left-color: var(--primary-color);
    font-weight: 600;
}
.nav-item i {
    margin-right: 10px;
    font-size: 18px;
}

/* Contenu Principal */
.main-content {
    flex-grow: 1;
    padding: 20px;
    overflow-y: auto;
}
.content-section {
    display: none;
    animation: fadeIn 0.5s ease-out;
}
.content-section.active {
    display: block;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

h2 {
    font-size: 28px;
    margin-bottom: 20px;
    color: var(--primary-color);
}

/* Style des cartes/panneaux */
.card {
    background: var(--card-bg);
    backdrop-filter: blur(20px);
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 25px;
    box-shadow: 0 5px 15px var(--shadow-color);
}

/* Formulaires et entr√©es */
.form-group {
    margin-bottom: 15px;
}
.form-group label {
    display: block;
    margin-bottom: 8px;
    font-size: 14px;
    color: var(--light-text);
}
.form-control, .select-control {
    width: 100%;
    padding: 10px 15px;
    border-radius: 10px;
    color: var(--text-color);
    font-size: 15px;
    transition: all 0.3s;
    -webkit-appearance: none;
    appearance: none;
}
.form-control {
    background: rgba(255, 255, 255, 0.1); 
    border: 1px solid rgba(255, 255, 255, 0.2);
}
.select-control {
    background: rgba(29, 233, 182, 0.15); 
    border: 1px solid var(--secondary-color);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231de9b6'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 10px;
    padding-right: 35px;
}
.form-control:focus, .select-control:focus {
    border-color: var(--primary-color); 
    box-shadow: 0 0 10px rgba(0, 191, 255, 0.4);
    outline: none;
}

/* Boutons */
.btn {
    padding: 12px 25px;
    border: none;
    border-radius: 15px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    background: var(--primary-color);
    color: var(--text-color);
    box-shadow: 0 5px 15px rgba(0, 191, 255, 0.4);
}
.btn:hover {
    background: var(--secondary-color);
    box-shadow: 0 0 20px rgba(29, 233, 182, 0.6);
    transform: translateY(-2px);
}

/* Tableaux */
.ranking-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}
.ranking-table tbody tr {
    cursor: pointer; 
}
.ranking-table tbody tr:hover {
    background: rgba(0, 191, 255, 0.05);
}
.ranking-table th, .ranking-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}
.ranking-table th {
    color: var(--primary-color);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 14px;
    background: rgba(0, 191, 255, 0.05);
}

/* Stats results */
.stats-results div {
    background: rgba(255, 255, 255, 0.08);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    font-size: 15px;
    display: flex;
    justify-content: space-between;
}
.stats-results strong {
    color: var(--secondary-color);
}

#logContent {
    background: #111;
    color: #fff;
    padding: 15px;
    border-radius: 10px;
    font-family: 'Consolas', 'Courier New', monospace;
    white-space: pre-wrap;
    max-height: 500px;
    overflow-y: auto;
    font-size: 12px;
}

/* Style Ajout√© pour les Versions */
.version-item {
    border-left: 3px solid var(--primary-color);
    background: rgba(255, 255, 255, 0.03);
    padding: 15px;
    margin-bottom: 15px;
    border-radius: 0 10px 10px 0;
}
.version-item h4 { color: var(--primary-color); margin-bottom: 5px; }
.version-item p { color: #ccc; font-size: 0.95em; }

.error-message { color: #ff5555; background: rgba(255, 85, 85, 0.1); padding: 15px; border-radius: 10px; text-align: center; }
.loading-message { color: var(--primary-color); text-align: center; padding: 20px; }
</style>
</head>
<body>

<div class="header">
    <div class="header-logo">üéÆ Console</div>
    <div class="header-title">Tableau de Bord</div>
</div>

<div class="dashboard-container">
    <div class="sidebar">
        <div class="nav-group-title">Analytics & Donn√©es</div>
        <div class="nav-item active" data-tab="ranking">
            <i class="fas fa-trophy">üèÜ</i> Classement
        </div>
        <div class="nav-item" data-tab="player-stats">
            <i class="fas fa-user-chart">üìà</i> Statistiques de Joueur
        </div>
        <div class="nav-group-title" style="margin-top: 20px;">Gestion</div>
        <div class="nav-item" data-tab="users">
            <i class="fas fa-users">üë•</i> Gestion des Utilisateurs
        </div>
        <div class="nav-item" data-tab="versions">
            <i class="fas fa-rocket">üöÄ</i> Mises √† jour
        </div>
        <div class="nav-item" data-tab="content">
            <i class="fas fa-cogs">‚öôÔ∏è</i> Param√®tres
        </div>
        <div class="nav-item" data-tab="reports">
            <i class="fas fa-bug">üö®</i> Logs Serveur
        </div>
    </div>

    <div class="main-content">
        <div class="content-section active" id="ranking">
            <h2>Classement Global</h2>
            <div class="card">
                <p>classement des meilleurs joueurs</p>
                <div class="form-group">
                    <label for="rankingGameSelect">S√©lectionner un Jeu :</label>
                    <select id="rankingGameSelect" class="select-control"></select>
                </div>
                <button class="btn" id="loadRankingBtn">Charger le Classement</button>
            </div>
            <div class="card" id="rankingResultCard" style="display:none;">
                <h3>Top 10 : <span id="rankingGameTitle"></span></h3>
                <div id="rankingTableContainer"></div>
                <div id="rankingMessage" class="loading-message" style="display:none;">Chargement...</div>
                <div id="rankingError" class="error-message" style="display:none;"></div>
            </div>
        </div>

        <div class="content-section" id="player-stats">
            <h2>Statistiques de Joueur</h2>
            <div class="card">
                <p>statistiques d√©taill√©es d'un joueur</p>
                <div class="form-group">
                    <label for="playerUsername">Nom d'utilisateur :</label>
                    <input type="text" id="playerUsername" class="form-control" placeholder="Entrez l'ID du joueur">
                </div>
                <button class="btn" id="loadPlayerStatsBtn">Charger les Statistiques</button>
            </div>
            <div class="card" id="statsResultCard" style="display:none;">
                <h3>Statistiques pour <span id="statsPlayerTitle"></span></h3>
                <div id="statsResultsContainer"></div>
                <div id="statsMessage" class="loading-message" style="display:none;">Chargement...</div>
                <div id="statsError" class="error-message" style="display:none;"></div>
            </div>
        </div>
        
        <div class="content-section" id="users">
            <h2>Gestion des Utilisateurs</h2>
            <div class="card">
                <p>Affichez la liste de tous les utilisateurs</p>
                <button class="btn" id="loadUsersBtn">Actualiser la Liste</button>
            </div>
            <div class="card" id="usersResultCard" style="display:none;">
                <h3>Liste des Joueurs</h3>
                <div id="usersTableContainer"></div>
                <div id="usersMessage" class="loading-message" style="display:none;">Chargement...</div>
                <div id="usersError" class="error-message" style="display:none;"></div>
            </div>
        </div>

        <div class="content-section" id="versions">
            <h2>Mises √† jour</h2>
            <div class="card">
                <h3>Publier une mise √† jour</h3>
                <div class="form-group">
                    <label>Version (Chiffre) :</label>
                    <input type="number" id="vNumber" class="form-control" placeholder="Ex: 1">
                </div>
                <div class="form-group">
                    <label>Titre :</label>
                    <input type="text" id="vTitle" class="form-control" placeholder="Ex: Nouvelle Map">
                </div>
                <div class="form-group">
                    <label>Description :</label>
                    <textarea id="vDesc" class="form-control" rows="3" placeholder="Ex: Ajout de..."></textarea>
                </div>
                <button class="btn" id="submitVersionBtn">Publier la Version</button>
            </div>
            <div class="card">
                <h3>Historique des versions</h3>
                <div id="versionsMessage" class="loading-message" style="display:none;">Chargement...</div>
                <div id="versionsList"></div>
            </div>
        </div>

        <div class="content-section" id="content">
            <h2>Param√®tres</h2>
            <div class="card">
                <a href="stay_server_alive.html" class="btn" style="text-decoration: none;">Ouvrir Mode *stay_alive*</a>
            </div>
        </div>
        
        <div class="content-section" id="reports">
            <h2>Logs Serveur</h2>
            <div class="card">
                <p>Configuration pas encore termin√©e</p>
                <button class="btn" id="loadLogsBtn">Actualiser les Logs</button>
                <div id="logsMessage" class="loading-message" style="display:none;">Chargement...</div>
                <div id="logContent" style="margin-top:20px;">Attente d'action...</div>
                <div id="logsError" class="error-message" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = "https://project-3-api-2bgb.onrender.com";
    
    const AVAILABLE_GAMES = {
        'astro_dodge': 'Astro Dodge', 
        'stickman_runner': 'Stickman Runner',
        'skull_arena': 'Skull Arena' 
    };
    
    const navItems = document.querySelectorAll('.nav-item');
    const contentSections = document.querySelectorAll('.content-section');
    const playerUsernameInput = document.getElementById('playerUsername');

    function switchTab(targetId) {
        navItems.forEach(i => i.classList.remove('active'));
        contentSections.forEach(s => s.classList.remove('active'));

        const targetNavItem = document.querySelector(`.nav-item[data-tab="${targetId}"]`);
        if (targetNavItem) {
            targetNavItem.classList.add('active');
            document.getElementById(targetId).classList.add('active');
        }
        
        if (targetId === 'ranking') {
            populateRankingGameSelector();
        } else if (targetId === 'users') {
            loadAllUsers(); 
        } else if (targetId === 'versions') {
            loadAllVersions();
        }
    }

    navItems.forEach(item => {
        item.addEventListener('click', () => {
            switchTab(item.getAttribute('data-tab'));
        });
    });

    switchTab('ranking'); 

    async function fetchData(endpoint, method = 'GET', body = null) {
        const url = `${API_BASE_URL}/${endpoint}`; 
        const options = { method: method, headers: {} };
        if (body !== null) { 
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }
        if (method === 'GET') { delete options.body; delete options.headers['Content-Type']; }
        
        try {
            const response = await fetch(url, options);
            if (!response.ok) throw new Error(`Erreur HTTP ${response.status}`);
            return await response.json();
        } catch (error) { throw error; }
    }

    // CLASSEMENT
    function populateRankingGameSelector() {
        const rankingGameSelect = document.getElementById('rankingGameSelect');
        if (rankingGameSelect.options.length > 0) return;
        for (const [key, value] of Object.entries(AVAILABLE_GAMES)) {
            const option = new Option(value, key);
            rankingGameSelect.add(option);
        }
    }
    
    document.getElementById('loadRankingBtn').addEventListener('click', async () => {
        const gameId = document.getElementById('rankingGameSelect').value;
        const rankingResultCard = document.getElementById('rankingResultCard');
        const rankingMessage = document.getElementById('rankingMessage');
        const rankingTableContainer = document.getElementById('rankingTableContainer');

        rankingResultCard.style.display = 'none';
        rankingMessage.style.display = 'block';

        try {
            const data = await fetchData(`${gameId}_get_leaderboard`, 'GET'); 
            let html = '<table class="ranking-table"><thead><tr><th>#</th><th>Joueur</th><th>Score</th></tr></thead><tbody>';
            (data.data || []).forEach((p, i) => {
                const score = p.score || p.distance || p.wave || 0;
                html += `<tr onclick="goToPlayer('${p.username}')"><td>${i+1}</td><td>${p.username}</td><td>${score}</td></tr>`;
            });
            rankingTableContainer.innerHTML = html + '</tbody></table>';
            document.getElementById('rankingGameTitle').textContent = AVAILABLE_GAMES[gameId];
            rankingResultCard.style.display = 'block';
        } catch (e) { alert(e.message); }
        rankingMessage.style.display = 'none';
    });

    function goToPlayer(user) {
        switchTab('player-stats');
        playerUsernameInput.value = user;
        loadAllPlayerStats(user);
    }

    // STATS JOUEUR
    document.getElementById('loadPlayerStatsBtn').addEventListener('click', () => {
        const user = playerUsernameInput.value.trim();
        if (user) loadAllPlayerStats(user);
    });

    async function loadAllPlayerStats(username) {
        const container = document.getElementById('statsResultsContainer');
        document.getElementById('statsResultCard').style.display = 'block';
        document.getElementById('statsMessage').style.display = 'block';
        container.innerHTML = '';
        document.getElementById('statsPlayerTitle').textContent = username;

        for (const [gameId, gameName] of Object.entries(AVAILABLE_GAMES)) {
            try {
                const data = await fetchData(`${gameId}_get_data`, 'POST', { username: username });
                const stats = data.data || data;
                let html = `<div class="card"><h4>${gameName}</h4><div class="stats-results">`;
                for (const k in stats) {
                    if (!['id','username','created_at','updated_at'].includes(k)) {
                        html += `<div><span>${k} :</span><strong>${stats[k]}</strong></div>`;
                    }
                }
                container.innerHTML += html + `</div></div>`;
            } catch (e) { }
        }
        document.getElementById('statsMessage').style.display = 'none';
    }

    // UTILISATEURS
    async function loadAllUsers() {
        const container = document.getElementById('usersTableContainer');
        document.getElementById('usersMessage').style.display = 'block';
        try {
            const data = await fetchData('get_all_players_status', 'GET');
            let html = '<table class="ranking-table"><thead><tr><th>ID</th><th>Statut</th><th>Derni√®re Activit√©</th></tr></thead><tbody>';
            (data.data || []).forEach(p => {
                html += `<tr><td>${p.id}</td><td>${p.status}</td><td>${p.last_seen || 'N/A'}</td></tr>`;
            });
            container.innerHTML = html + '</tbody></table>';
            document.getElementById('usersResultCard').style.display = 'block';
        } catch (e) { }
        document.getElementById('usersMessage').style.display = 'none';
    }

    // LOGIQUE VERSIONS (NOUVEAU)
    async function loadAllVersions() {
        const container = document.getElementById('versionsList');
        const msg = document.getElementById('versionsMessage');
        msg.style.display = 'block';
        container.innerHTML = '';
        try {
            const data = await fetchData('get_all_versions', 'GET');
            (data.data || []).forEach(v => {
                container.innerHTML += `
                    <div class="version-item">
                        <h4>Version ${v.Version} : ${v.Title || 'Sans titre'}</h4>
                        <p>${v.Description || 'Aucune description.'}</p>
                    </div>`;
            });
        } catch (e) { console.error(e); }
        msg.style.display = 'none';
    }

    document.getElementById('submitVersionBtn').addEventListener('click', async () => {
        const v = document.getElementById('vNumber').value;
        const t = document.getElementById('vTitle').value;
        const d = document.getElementById('vDesc').value;
        if (!v) return alert("Version requise");
        try {
            const query = `add_version?version=${v}&title=${encodeURIComponent(t)}&description=${encodeURIComponent(d)}`;
            await fetchData(query, 'GET');
            alert("Mise √† jour publi√©e !");
            loadAllVersions();
        } catch (e) { alert("Erreur: " + e.message); }
    });

    // LOGS
    document.getElementById('loadLogsBtn').addEventListener('click', async () => {
        const logContent = document.getElementById('logContent');
        document.getElementById('logsMessage').style.display = 'block';
        try {
            const data = await fetchData('admin_access', 'GET');
            logContent.textContent = JSON.stringify(data, null, 4); 
        } catch (error) { logContent.textContent = "Erreur: " + error.message; }
        document.getElementById('logsMessage').style.display = 'none';
    });
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</body>
</html>