<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Clicker Game</title>
    <style>
        /* --- Styles CSS --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #232323; overflow: hidden; }

        .container { display: flex; width: 100vw; height: 100vh; position: relative; overflow: hidden; }

        .main-area { flex: 1; background: #1b1b1b; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; min-width: 0; }

        .title { color: #ffffff; font-size: clamp(32px, 6vw, 60px); font-weight: bold; margin-bottom: 15px; text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); }

        .score-counter { color: #ffffff; font-size: clamp(20px, 3vw, 32px); font-weight: bold; margin-bottom: 10px; opacity: 0.9; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); background: rgba(255, 255, 255, 0.1); padding: 8px 25px; border-radius: 20px; backdrop-filter: blur(10px); }

        .to-send { color: #ffffff; font-size: clamp(14px, 2vw, 20px); margin-bottom: 30px; opacity: 0.9; }

        .click-button { width: min(30vh, 30vw, 220px); height: min(30vh, 30vw, 220px); max-width: 220px; max-height: 220px; aspect-ratio: 1/1; border-radius: 50%; background: linear-gradient(145deg, #ffd966, #ffb84d); border: 6px solid #ff6b35; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4); position: relative; overflow: hidden; flex-shrink: 0; }

        .click-button::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 85%; border-radius: 50%; background-size: cover; background-position: center; }

        .click-button:hover { transform: scale(1.1); box-shadow: 0 15px 40px rgba(255, 107, 53, 0.6); }

        .click-button:active { transform: scale(0.95); box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3); }

        .timer-counter { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #FFFFFF; font-size: clamp(12px, 1.5vw, 16px); font-weight: bold; background: rgba(0, 0, 0, 0.3); padding: 10px 25px; border-radius: 30px; backdrop-filter: blur(10px); min-width: 200px; max-width: 90%; text-align: center; }

        .timer-bar { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: min(250px, 80%); height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; overflow: hidden; }

        .timer-bar-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); border-radius: 2px; transition: width 0.1s linear; }

        .status-label { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: #FFFFFF; font-size: clamp(11px, 1.5vw, 14px); padding: 6px 14px; border-radius: 8px; background: rgba(0, 0, 0, 0.5); max-width: 90%; text-align: center; }

        .sidebar { width: clamp(280px, 30vw, 350px); max-width: 100vw; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); padding: 20px; position: absolute; right: 0; top: 0; height: 100vh; transform: translateX(0); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; overflow-y: auto; box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3); }

        .sidebar.hidden { transform: translateX(100%); }

        .toggle-sidebar-btn { 
            position: absolute; 
            top: 20px; 
            left: 80px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            width: clamp(40px, 6vw, 50px); 
            height: clamp(40px, 6vw, 50px); 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: clamp(18px, 3vw, 24px); 
            z-index: 101; 
            transition: all 0.3s ease; 
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        .toggle-sidebar-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        
        .close-btn { 
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); 
            color: white; 
            border: none; 
            width: clamp(35px, 5vw, 40px); 
            height: clamp(35px, 5vw, 40px); 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: clamp(18px, 3vw, 24px); 
            font-weight: bold; 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            transition: all 0.2s ease; 
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            line-height: 1;
        }

        .close-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5); }

        .close-btn:disabled { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); cursor: not-allowed; opacity: 0.6; }

        .sidebar-title { color: #f8fafc; font-size: clamp(20px, 3vw, 28px); font-weight: bold; margin-bottom: 25px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }

        .section-title { color: #cbd5e1; font-size: clamp(11px, 1.5vw, 13px); font-weight: bold; margin-top: 20px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

        .session-code { color: #60a5fa; font-size: clamp(22px, 3.5vw, 32px); font-weight: bold; margin-bottom: 18px; text-shadow: 0 2px 8px rgba(96, 165, 250, 0.3); word-break: break-all; }

        .username-label, .player-count { color: #f8fafc; font-size: clamp(14px, 2vw, 16px); margin-bottom: 10px; }

        .player-item { color: #10b981; font-size: clamp(13px, 1.8vw, 15px); margin: 8px 0; padding: 8px 12px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border-left: 3px solid #10b981; transition: all 0.3s ease; word-break: break-word; }

        .player-item:hover { background: rgba(16, 185, 129, 0.2); transform: translateX(5px); }

        .player-item.waiting { color: #64748b; background: rgba(100, 116, 139, 0.1); border-left: 3px solid #64748b; }

        .join-input { width: 100%; height: clamp(40px, 5vh, 45px); border-radius: 12px; border: 2px solid #475569; background: rgba(51, 65, 85, 0.6); color: #f8fafc; padding: 0 14px; font-size: clamp(13px, 1.8vw, 15px); margin-top: 10px; transition: all 0.3s ease; backdrop-filter: blur(5px); }

        .join-input:focus { outline: none; border-color: #60a5fa; background: rgba(51, 65, 85, 0.8); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2); }

        .join-input::placeholder { color: #94a3b8; }

        .join-button { width: 100%; height: clamp(42px, 5.5vh, 48px); border-radius: 12px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-size: clamp(13px, 1.8vw, 15px); font-weight: bold; cursor: pointer; margin-top: 12px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }

        .join-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }

        .join-button:active { transform: translateY(0); }

        .upgrade-button { width: 100%; height: clamp(42px, 5.5vh, 48px); border-radius: 12px; border: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: clamp(13px, 1.8vw, 15px); font-weight: bold; cursor: pointer; margin-top: 12px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }

        .upgrade-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4); background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }

        .upgrade-button:active { transform: translateY(0); }

        .sidebar-status { color: #94a3b8; font-size: clamp(11px, 1.5vw, 12px); margin-top: 10px; min-height: 20px; word-break: break-word; }

        .back-btn { position: absolute; top: 20px; left: 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; width: clamp(40px, 6vw, 50px); height: clamp(40px, 6vw, 50px); border-radius: 50%; cursor: pointer; font-size: clamp(18px, 3vw, 24px); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); transition: all 0.3s ease; z-index: 102; text-decoration: none; }

        .back-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }

        /* Joueur en attente */
        .player-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            background-color: #374151;
            border-left: 3px solid #10b981;
            transition: all 0.2s ease-in-out;
        }

        /* Joueur en attente */
        .player-item.waiting {
            color: #64748b;
            background: #1f2937;
            border-left: 3px solid #64748b;
        }

        /* L'utilisateur courant */
        .player-item-me {
            font-weight: bold;
            color: #fcd34d;
            border-left: 3px solid #fcd34d; 
            background: #3f3f46; 
        }

        /* Le cr√©ateur de la session (la couronne üëë) */
        .player-item-creator {
            color: #ff6b35;
            border-left: 3px solid #ff6b35; 
            background: rgba(255, 107, 53, 0.15); 
        }

        /* -------------------------------------
            üì≤ MODIFICATIONS CSS POUR MOBILE (Max 768px)
            ------------------------------------- */
        @media (max-width: 768px) {
            .sidebar { width: 85vw; }
            .main-area { 
                padding: 15px; 
                display: flex;
                flex-direction: column; 
                justify-content: space-between; 
                align-items: center;
            }
            
            .click-button { width: min(40vw, 40vh, 200px); height: min(40vw, 40vh, 200px); flex-shrink: 0; }
            
            /* Bouton "Rejoindre" pour mobile (visible uniquement sur mobile) */
            #joinButtonMobile {
                display: block; 
                width: 90%;
                height: 50px;
                margin: 10px auto;
                order: 3; 
                border-radius: 12px; border: none; 
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
                color: white; font-size: 15px; font-weight: bold; cursor: pointer; 
                box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
                transition: all 0.3s ease;
            }
            
            #joinButtonMobile:hover { transform: translateY(-2px); }
            #joinButtonMobile:active { transform: translateY(0); }

            /* Input pour mobile (visible uniquement sur mobile) */
            #joinInputMobile {
                display: block; 
                width: 90%;
                height: 45px;
                margin: 0 auto;
                order: 4; 
                border-radius: 12px; border: 2px solid #475569; 
                background: rgba(51, 65, 85, 0.6); color: #f8fafc; 
                padding: 0 14px; font-size: 15px;
                margin-bottom: 20px; 
            }
            
            #joinInputMobile::placeholder { color: #94a3b8; }
            #joinInputMobile:focus { outline: none; border-color: #60a5fa; background: rgba(51, 65, 85, 0.8); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2); }

            /* Ordre des √©l√©ments existants dans main-area */
            .score-counter {
                order: 1; 
                margin-bottom: 30px; 
                margin-top: 50px; 
            }

            .click-button {
                order: 2; 
                margin: 30px 0; 
            }

            /* Cache les contr√¥les originaux (sidebar ou desktop) */
            .join-input:not(#joinInputMobile), .join-button:not(#joinButtonMobile), .upgrade-button {
                display: none !important; 
            }
            
            /* Ajustements divers pour le header */
            .back-btn { top: 10px; left: 10px; }
            .toggle-sidebar-btn { top: 10px; left: 70px; }
            .title { order: -2; margin-top: 0; }
            .to-send { order: -1; margin-bottom: 0; }
            
            /* Simplification de l'affichage pour le mobile */
            .timer-bar, .timer-counter, .status-label { 
                display: none !important; 
            } 
        }
        @media (max-width: 480px) {
            .sidebar { width: 90vw; }
            .click-button { width: min(50vw, 45vh, 180px); height: min(50vw, 45vh, 180px); }
        }
    </style>

</head>
<body onload="initGame()">
    <div class="container">
        <div class="main-area">
            <a href="menu.html" class="back-btn">‚Üê</a>
            <button class="toggle-sidebar-btn" id="toggleSidebar">‚ò∞</button>

            <div class="title">Clicker</div>
            <div class="score-counter" id="scoreCounter">0</div> 
            <div class="to-send" id="toSend">-- 0 --</div>
            <button class="click-button" id="clickButton"></button>

            <!-- Contr√¥les Mobile -->
            <input type="text" class="join-input" id="joinInputMobile" placeholder="Entrer un code ou /cha code" style="display:none;">
            <button class="join-button" id="joinButtonMobile" style="display:none;" onclick="handleJoinSession('joinInputMobile')">Rejoindre/Changer</button> 
            <!-- Fin Contr√¥les Mobile -->

            <div class="timer-bar">
                <div class="timer-bar-fill" id="timerBarFill"></div>
            </div>
            <div class="timer-counter" id="timerCounter">Rafra√Æchissement : lancement</div>
            <div class="status-label" id="statusLabel"></div>
        </div>

        <div class="sidebar hidden" id="sidebar"> 
            <button class="close-btn" id="closeBtn">√ó</button>
            <div class="sidebar-title">Session</div>

            <div class="section-title">Code de session</div>
            <div class="session-code" id="sessionCode">Chargement...</div>

            <div class="section-title">Utilisateur</div>
            <div class="username-label" id="usernameLabel">Utilisateur</div>

            <div class="section-title">Joueurs pr√©sents</div>
            <div class="player-count" id="playerCount">...</div>

            <div id="playersList">
                <!-- Les joueurs seront ins√©r√©s ici par JS -->
            </div>

            <div class="section-title">Rejoindre / Changer session</div>
            <input type="text" class="join-input" id="joinInput" placeholder="Entrer code ou /cha code">
            <button class="join-button" id="joinButton" onclick="handleJoinSession('joinInput')">Rejoindre/Changer</button>
            <a href="upgrade.html" target="_blank"><button class="upgrade-button" id="upgradeButton">‚ö° Am√©lioration</button></a>

            <div class="sidebar-status" id="sidebarStatus"></div>
        </div>
    </div>

    <script>
        // --- VARIABLES GLOBALES ET CONSTANTES ---
        // Remplacez par l'URL de votre API si elle change
        const API_URL = "https://project-3-api-2bgb.onrender.com"; 
        
        // Fr√©quences pour les cycles
        const SCORE_REFRESH_PERIOD_SECONDS = 10; 
        const CLICKS_MIN_SECONDS = 4; 
        const CLICKS_MAX_SECONDS = 8; 
        
        let clickCount = 0;
        let lastClickTime = 0;
        let username = localStorage.getItem("username") || 'Player-' + Math.floor(Math.random() * 10000);
        
        let timerInterval; // Pour le rafra√Æchissement du score (toutes les 10s)
        let clicksTimeout; // Pour l'envoi al√©atoire des clics (4-8s)
        
        // --- FONCTIONS UTILITAIRES ---
        
        function setStatus(message, color = 'blue') {
            const statusLabel = document.getElementById('sidebarStatus');
            if (statusLabel) {
                statusLabel.textContent = message;
                statusLabel.style.color = color;
            }
        }

        // --- GESTION DES CYCLES ET DE L'√âTAT ---
        
        function stopAllCycles() {
            clearInterval(timerInterval);
            clearTimeout(clicksTimeout);
        }
        
        function stopClicksInterval() {
            clearTimeout(clicksTimeout);
        }
        
        function startClicksInterval() {
            stopClicksInterval(); 
            
            const duration = Math.floor(Math.random() * (CLICKS_MAX_SECONDS - CLICKS_MIN_SECONDS + 1)) + CLICKS_MIN_SECONDS;
            
            clicksTimeout = setTimeout(sendClicksRandomly, duration * 1000);
            console.log(`[CLICS] Prochain envoi al√©atoire de clics dans : ${duration}s`);
        }

        function updateDisplay(timeLeft) {
            const timerCounter = document.getElementById('timerCounter');
            const timerBarFill = document.getElementById('timerBarFill');
            
            if (timerCounter) {
                timerCounter.textContent = `Rafra√Æchissement dans : ${timeLeft}s`;
            }
            if (timerBarFill) {
                const percentage = (timeLeft / SCORE_REFRESH_PERIOD_SECONDS) * 100;
                timerBarFill.style.width = `${percentage}%`;
            }
        }

        function startScoreInterval(initialWaitTime = SCORE_REFRESH_PERIOD_SECONDS) {
            clearInterval(timerInterval);
            let timeLeft = initialWaitTime; 
            updateDisplay(timeLeft); 

            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay(timeLeft); 
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    gameCycle(); 
                }
            }, 1000); 
        }

        function launchGameCycle() {
            startScoreInterval(); // Boucle de 10s pour le rafra√Æchissement des donn√©es
            startClicksInterval(); // Boucle de 4-8s pour l'envoi des clics
        }
        
        async function gameCycle() {
            const sessionCode = document.getElementById('sessionCode').textContent;
            
            if (sessionCode === "Aucune session" || sessionCode === "Erreur" || sessionCode === "Chargement..." || sessionCode === "Cr√©ation...") {
                console.warn("[SCORE] Session invalide. Tentative de prochain cycle.");
                startScoreInterval(); 
                return;
            }
            
            console.log(`[SCORE] D√©clenchement du rafra√Æchissement API (10s cycle) pour la session : ${sessionCode}`);

            const counterElement = document.getElementById('timerCounter');
            if (counterElement) {
                counterElement.textContent = "‚è≥";
            }
            
            await fetchGameData(); 
            startScoreInterval(); 
        }
        
        // --- FONCTIONS DE COMMUNICATION ET DE JEU ---

        async function sendClicksRandomly() {
            if (clickCount === 0) {
                console.log("[CLICS] Pas de clics √† envoyer. Relance du minuteur.");
                startClicksInterval(); 
                return;
            }
            
            const clicksToSend = clickCount;
            clickCount = 0; 
            document.getElementById('toSend').textContent = `-- 0 --`;

            const sessionCode = document.getElementById('sessionCode').textContent;
            const statusLabel = document.getElementById('statusLabel');
            
            try {
                statusLabel.textContent = `Envoi de ${clicksToSend} clics...`;
                statusLabel.style.background = 'rgba(255, 165, 0, 0.5)';
                
                const response = await fetch(`${API_URL}/add_clicks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: username, clicks: clicksToSend, session_code: sessionCode })
                });
                const data = await response.json();

                if (data.status === "success") {
                    console.log(`[CLICS] ${clicksToSend} clics envoy√©s avec succ√®s. Score: ${data.total_score}`);
                    document.getElementById('scoreCounter').textContent = data.total_score || '0';
                    statusLabel.textContent = `‚úÖ ${clicksToSend} clics envoy√©s !`;
                    statusLabel.style.background = 'rgba(16, 185, 129, 0.5)';
                } else {
                    console.error(`[CLICS] Erreur lors de l'envoi des clics : ${data.message}`);
                    statusLabel.textContent = `‚ùå √âchec envoi clics: ${data.message || 'Erreur API'}`;
                    statusLabel.style.background = 'rgba(239, 68, 68, 0.5)';
                }
            } catch (e) {
                console.error("[CLICS] Erreur r√©seau lors de l'envoi des clics.", e);
                statusLabel.textContent = "‚ùå Erreur r√©seau lors de l'envoi des clics.";
                statusLabel.style.background = 'rgba(239, 68, 68, 0.5)';
            } finally {
                startClicksInterval(); 
                setTimeout(() => {
                    statusLabel.textContent = ""; 
                    statusLabel.style.background = 'rgba(0, 0, 0, 0.5)';
                }, 3000);
            }
        }

        /**
         * Met √† jour la liste des joueurs dans la barre lat√©rale.
         */
        function updatePlayersList(players, maxPlayers, sessionCreator) {
            const list = document.getElementById('playersList');
            const countElement = document.getElementById('playerCount');
            list.innerHTML = ''; 

            if (!players || players.length === 0) {
                list.innerHTML = `<div class="player-item waiting">Aucun autre joueur.</div>`;
                countElement.textContent = `1/${maxPlayers}`;
                return;
            }

            players.sort((a, b) => b.score - a.score);
            
            players.forEach(player => {
                let className = 'player-item';
                let icon = 'üë§';
                
                if (player.id === username) {
                    className += ' player-item-me';
                    icon = '‚≠ê';
                }
                if (player.id === sessionCreator) {
                    className += ' player-item-creator';
                    icon = 'üëë';
                }
                
                list.innerHTML += `
                    <div class="${className}">
                        ${icon} ${player.id} - Score: ${player.score || 0}
                    </div>
                `;
            });

            // Ajouter des slots d'attente
            for (let i = players.length; i < maxPlayers; i++) {
                list.innerHTML += `<div class="player-item waiting">‚ö™ En attente...</div>`;
            }

            countElement.textContent = `${players.length}/${maxPlayers}`;
        }
        
        /**
         * R√©cup√®re les donn√©es de jeu (score, joueurs) et les affiche.
         */
        async function fetchGameData() {
            const sessionCode = document.getElementById('sessionCode').textContent;

            try {
                const response = await fetch(`${API_URL}/verify_session?id=${encodeURIComponent(username)}`);
                const data = await response.json();

                if (data.status === "success" && data.session_code === sessionCode) {
                    document.getElementById('scoreCounter').textContent = data.score || '0';
                    updatePlayersList(data.players, data.max_players || 5, data.creator_id);
                    document.getElementById('statusLabel').textContent = `Dernier rafra√Æchissement: ${new Date().toLocaleTimeString('fr')}`;
                } else if (data.status === "success" && data.session_code) {
                    // L'utilisateur est dans une session mais ce n'est pas celle affich√©e (via join/cha)
                    document.getElementById('sessionCode').textContent = data.session_code;
                    document.getElementById('scoreCounter').textContent = data.score || '0';
                    updatePlayersList(data.players, data.max_players || 5, data.creator_id);
                    document.getElementById('statusLabel').textContent = `Dernier rafra√Æchissement: ${new Date().toLocaleTimeString('fr')}`;
                } else {
                    document.getElementById('statusLabel').textContent = "Erreur: Session perdue. Reconnexion...";
                    console.error("Session perdue ou invalide. Tentative de reconnexion.", data);
                }
            } catch (e) {
                document.getElementById('statusLabel').textContent = "Erreur r√©seau. V√©rifiez l'API.";
                console.error("Erreur r√©seau lors du rafra√Æchissement des donn√©es:", e);
            }
        }
        
        /**
         * G√®re les commandes /cha et la jonction de session simple.
         * C'est ici que la distinction /cha (change_session) vs. code simple (join_session) est effectu√©e.
         */
        async function handleJoinSession(inputId) {
            const inputElement = document.getElementById(inputId);
            let command = inputElement.value.trim();
            const sessionCodeElement = document.getElementById('sessionCode');
            
            if (!command) {
                setStatus("Veuillez entrer un code ou une commande.", '#ef4444');
                return;
            }

            const parts = command.split(/\s+/);
            const firstPart = parts[0].toLowerCase();
            
            let endpoint = '';
            let bodyData = { id: username }; 
            let successMessage = '';
            let actionType = 'join';
            
            // LOGIQUE CL√â : V√©rifie si c'est la commande /cha
            if (firstPart === '/cha') {
                if (parts.length < 2) {
                     setStatus("Erreur: Sp√©cifiez le code de session apr√®s /cha.", '#ef4444');
                     return;
                }
                const newCode = parts[1];
                endpoint = '/change_session'; // Appel vers /change_session
                bodyData.session_code = newCode;
                successMessage = `Session chang√©e pour ${newCode}.`;
                actionType = 'changer';
            } else {
                // Par d√©faut : simple code de session √† rejoindre
                const code = command;
                endpoint = '/join_session'; // Appel vers /join_session
                bodyData.session_code = code;
                successMessage = `Session rejointe: ${code}.`;
            }
            
            setStatus(`Tentative de ${actionType}...`, '#f59e0b');

            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bodyData)
                });
                const data = await response.json();
                
                if (data.status === "success" && data.session_code) {
                    sessionCodeElement.textContent = data.session_code;
                    document.getElementById('scoreCounter').textContent = data.score || '0';
                    updatePlayersList(data.players, data.max_players || 5, data.creator_id);
                    setStatus(successMessage, '#10b981');
                    
                    // Relance du cycle de jeu pour synchronisation imm√©diate
                    stopAllCycles();
                    launchGameCycle(); 

                    // Vider l'input et cacher la barre lat√©rale sur mobile
                    inputElement.value = '';
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.add('hidden');
                    }

                } else {
                    setStatus(`√âchec ${actionType}: ${data.message || 'Erreur API'}`, '#ef4444');
                    // En cas d'√©chec, on essaie de revenir √† la session pr√©c√©dente
                    await fetchGameData(); 
                }
            } catch (e) {
                setStatus(`Erreur r√©seau lors de la tentative de ${actionType}.`, '#ef4444');
                console.error(`Erreur r√©seau lors de ${endpoint}:`, e);
            }
        }
        
        /**
         * V√©rifie si l'utilisateur a une session existante ou en cr√©e une par d√©faut.
         */
        async function checkAndLoadSession() {
            document.getElementById('usernameLabel').textContent = `ID: ${username}`;
            document.getElementById('sessionCode').textContent = "V√©rification...";

            // 1. V√©rifie si l'utilisateur est d√©j√† dans une session
            const sessionInfo = await getPlayerSessionInfo();

            if (sessionInfo && sessionInfo.session_code) {
                document.getElementById('sessionCode').textContent = sessionInfo.session_code;
                document.getElementById('scoreCounter').textContent = sessionInfo.score || '0';
                updatePlayersList(sessionInfo.players, sessionInfo.max_players || 5, sessionInfo.creator_id);
                setStatus(`Connect√© √† la session : ${sessionInfo.session_code}.`, '#10b981');
            } else {
                // 2. Si non, cr√©e une nouvelle session (ou r√©utilise la session par d√©faut)
                setStatus("Cr√©ation de votre session par d√©faut...", '#f59e0b');
                await loadMySession();
            }
            
            // 3. Lance les cycles de jeu
            launchGameCycle();
        }
        
        async function getPlayerSessionInfo() {
            try {
                const playersResponse = await fetch(`${API_URL}/verify_session?id=${encodeURIComponent(username)}`);
                const playersData = await playersResponse.json();
                return playersData.status === "success" ? playersData : null;
            } catch (e) {
                console.error("Erreur lors de la r√©cup√©ration des infos de session:", e);
                return null;
            }
        }
        
        async function loadMySession() {
            const sessionCodeElement = document.getElementById('sessionCode');
            sessionCodeElement.textContent = "Cr√©ation...";
            
            try {
                const response = await fetch(`${API_URL}/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: username })
                });
                const data = await response.json();
                
                if (data.status === "success" && data.session_code) {
                    sessionCodeElement.textContent = data.session_code;
                    document.getElementById('scoreCounter').textContent = data.score || '0';
                    updatePlayersList(data.players, data.max_players || 5, data.creator_id);
                } else {
                    sessionCodeElement.textContent = "Erreur";
                    console.error("Erreur lors de la cr√©ation/r√©cup√©ration de session:", data.message);
                }
            } catch (e) {
                sessionCodeElement.textContent = "Erreur r√©seau";
                console.error("Erreur r√©seau lors de loadMySession:", e);
            }
        }

        // --- GESTION DES √âV√âNEMENTS ---

        function handleButtonClick() {
            clickCount++;
            document.getElementById('toSend').textContent = `-- ${clickCount} --`;
            
            const now = Date.now();
            // Effet visuel du clic
            const button = document.getElementById('clickButton');
            button.style.transform = 'scale(0.9)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 100);

            // G√®re le CPS (Clicks Per Second) - optionnel ici car l'envoi est temporel, 
            // mais on pourrait l'utiliser pour des am√©liorations futures.
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            
            sidebar.classList.toggle('hidden');
            if (sidebar.classList.contains('hidden')) {
                toggleBtn.textContent = '‚ò∞';
            } else {
                toggleBtn.textContent = '‚úñ';
            }
        }

        // --- INITIALISATION DU JEU ---
        
        function initGame() {
            // S'assure qu'un username existe dans le localStorage
            if (!localStorage.getItem("username")) {
                localStorage.setItem("username", username);
            }
            
            // √âv√©nements du bouton de clic
            document.getElementById('clickButton').addEventListener('click', handleButtonClick);

            // √âv√©nements de la barre lat√©rale
            document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('closeBtn').addEventListener('click', toggleSidebar);

            // √âv√©nement du bouton "Rejoindre/Changer" pour la version desktop
            document.getElementById('joinButton').addEventListener('click', () => handleJoinSession('joinInput'));
            
            // Ajout du listener pour l'input desktop (touche Entr√©e)
            document.getElementById('joinInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleJoinSession('joinInput');
                }
            });

            // Affichage des contr√¥les mobiles si n√©cessaire
            if (window.innerWidth <= 768) {
                document.getElementById('joinButtonMobile').style.display = 'block';
                document.getElementById('joinInputMobile').style.display = 'block';
                // Ajout du listener pour l'input mobile (touche Entr√©e)
                document.getElementById('joinInputMobile').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleJoinSession('joinInputMobile');
                    }
                });
            }

            // D√©marrage du processus de connexion/cr√©ation de session
            checkAndLoadSession();
        }
    </script>
</body>
</html>