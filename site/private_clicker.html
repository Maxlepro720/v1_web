<!DOCTYPE html>
<html lang="fr">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Private Clicker Game</title>
Â  Â  <style>
Â  Â  * { margin: 0; padding: 0; box-sizing: border-box; }
Â  Â  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #232323; overflow: hidden; }

Â  Â  .container { display: flex; width: 100vw; height: 100vh; position: relative; overflow: hidden; }

Â  Â  .main-area { flex: 1; background: #1b1b1b; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; min-width: 0; }

Â  Â  .title { color: #ffffff; font-size: clamp(32px, 6vw, 60px); font-weight: bold; margin-bottom: 15px; text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); }

Â  Â  .score-counter { color: #ffffff; font-size: clamp(20px, 3vw, 32px); font-weight: bold; margin-bottom: 10px; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); background: rgba(255, 255, 255, 0.1); padding: 8px 25px; border-radius: 20px; backdrop-filter: blur(10px); }

Â  Â  .to-send { color: #ffffff; font-size: clamp(14px, 2vw, 20px); margin-bottom: 30px; opacity: 0.9; }

Â  Â  .click-button { width: min(30vh, 30vw, 220px); height: min(30vh, 30vw, 220px); max-width: 220px; max-height: 220px; aspect-ratio: 1/1; border-radius: 50%; background: linear-gradient(145deg, #ffd966, #ffb84d); border: 6px solid #ff6b35; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4); position: relative; overflow: hidden; flex-shrink: 0; }

Â  Â  .click-button::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 85%; border-radius: 50%; background-size: cover; background-position: center; }

Â  Â  .click-button:hover { transform: scale(1.1); box-shadow: 0 15px 40px rgba(255, 107, 53, 0.6); }

Â  Â  .click-button:active { transform: scale(0.95); box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3); }

Â  Â  .timer-counter { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #FFFFFF; font-size: clamp(12px, 1.5vw, 16px); font-weight: bold; background: rgba(0, 0, 0, 0.3); padding: 10px 25px; border-radius: 30px; backdrop-filter: blur(10px); min-width: 200px; max-width: 90%; text-align: center; }

Â  Â  .timer-bar { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: min(250px, 80%); height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; overflow: hidden; }

Â  Â  .timer-bar-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); border-radius: 2px; transition: width 0.1s linear; }

Â  Â  .status-label { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: #FFFFFF; font-size: clamp(11px, 1.5vw, 14px); padding: 6px 14px; border-radius: 8px; background: rgba(0, 0, 0, 0.5); max-width: 90%; text-align: center; }

Â  Â  .sidebar { width: clamp(280px, 30vw, 350px); max-width: 100vw; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); padding: 20px; position: absolute; right: 0; top: 0; height: 100vh; transform: translateX(0); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; overflow-y: auto; box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3); }

Â  Â  .sidebar.hidden { transform: translateX(100%); }

Â  Â  .toggle-sidebar-btn { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; width: clamp(40px, 6vw, 50px); height: clamp(40px, 6vw, 50px); border-radius: 50%; cursor: pointer; font-size: clamp(18px, 3vw, 24px); z-index: 101; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); display: flex; align-items: center; justify-content: center; }

Â  Â  .toggle-sidebar-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }

Â  Â  .close-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; width: clamp(35px, 5vw, 40px); height: clamp(35px, 5vw, 40px); border-radius: 12px; cursor: pointer; font-size: clamp(18px, 3vw, 24px); font-weight: bold; position: absolute; top: 20px; right: 20px; transition: all 0.2s ease; box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3); display: flex; align-items: center; justify-content: center; }

Â  Â  .close-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5); }

Â  Â  .close-btn:disabled { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); cursor: not-allowed; opacity: 0.6; }

Â  Â  .sidebar-title { color: #f8fafc; font-size: clamp(20px, 3vw, 28px); font-weight: bold; margin-bottom: 25px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }

Â  Â  .section-title { color: #cbd5e1; font-size: clamp(11px, 1.5vw, 13px); font-weight: bold; margin-top: 20px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

Â  Â  .session-code { color: #60a5fa; font-size: clamp(22px, 3.5vw, 32px); font-weight: bold; margin-bottom: 18px; text-shadow: 0 2px 8px rgba(96, 165, 250, 0.3); word-break: break-all; }

Â  Â  .username-label, .player-count { color: #f8fafc; font-size: clamp(14px, 2vw, 16px); margin-bottom: 10px; }

Â  Â  .player-item { color: #10b981; font-size: clamp(13px, 1.8vw, 15px); margin: 8px 0; padding: 8px 12px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border-left: 3px solid #10b981; transition: all 0.3s ease; word-break: break-word; }

Â  Â  .player-item:hover { background: rgba(16, 185, 129, 0.2); transform: translateX(5px); }

Â  Â  .player-item.waiting { color: #64748b; background: rgba(100, 116, 139, 0.1); border-left: 3px solid #64748b; }

Â  Â  .join-input { width: 100%; height: clamp(40px, 5vh, 45px); border-radius: 12px; border: 2px solid #475569; background: rgba(51, 65, 85, 0.6); color: #f8fafc; padding: 0 14px; font-size: clamp(13px, 1.8vw, 15px); margin-top: 10px; transition: all 0.3s ease; backdrop-filter: blur(5px); }

Â  Â  .join-input:focus { outline: none; border-color: #60a5fa; background: rgba(51, 65, 85, 0.8); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2); }

Â  Â  .join-input::placeholder { color: #94a3b8; }

Â  Â  .join-button { width: 100%; height: clamp(42px, 5.5vh, 48px); border-radius: 12px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-size: clamp(13px, 1.8vw, 15px); font-weight: bold; cursor: pointer; margin-top: 12px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }

Â  Â  .join-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }

Â  Â  .join-button:active { transform: translateY(0); }
Â  Â  
Â  Â  /* NOUVEAU STYLE POUR LE BOUTON AMÃ‰LIORATIONS (MAINTENANT ROUGE) */
Â  Â  .upgrade-button { 
Â  Â  Â  Â  width: 100%; 
Â  Â  Â  Â  height: clamp(42px, 5.5vh, 48px); 
Â  Â  Â  Â  border-radius: 12px; 
Â  Â  Â  Â  border: none; 
Â  Â  Â  Â  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); /* Couleurs rouges */
Â  Â  Â  Â  color: white; 
Â  Â  Â  Â  font-size: clamp(13px, 1.8vw, 15px); 
Â  Â  Â  Â  font-weight: bold; 
Â  Â  Â  Â  cursor: pointer; 
Â  Â  Â  Â  margin-top: 12px; 
Â  Â  Â  Â  transition: all 0.3s ease; 
Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3); 
Â  Â  }

Â  Â  .upgrade-button:hover { 
Â  Â  Â  Â  transform: translateY(-2px); 
Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5); 
Â  Â  }

Â  Â  .upgrade-button:active { 
Â  Â  Â  Â  transform: translateY(0); 
Â  Â  }
Â  Â  /* FIN NOUVEAU STYLE */

Â  Â  .sidebar-status { color: #94a3b8; font-size: clamp(11px, 1.5vw, 12px); margin-top: 10px; min-height: 20px; word-break: break-word; }

Â  Â  .back-btn { position: absolute; top: 20px; left: 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; width: clamp(40px, 6vw, 50px); height: clamp(40px, 6vw, 50px); border-radius: 50%; cursor: pointer; font-size: clamp(18px, 3vw, 24px); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); transition: all 0.3s ease; z-index: 102; }

Â  Â  .back-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }

Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  .sidebar { width: 85vw; }
Â  Â  Â  Â  .main-area { padding: 15px; }
Â  Â  Â  Â  .click-button { width: min(40vw, 40vh, 200px); height: min(40vw, 40vh, 200px); }
Â  Â  }

Â  Â  @media (max-width: 480px) {
Â  Â  Â  Â  .sidebar { width: 90vw; }
Â  Â  Â  Â  .click-button { width: min(50vw, 45vh, 180px); height: min(50vw, 45vh, 180px); }
Â  Â  }
</style>

</head>
<body>
Â  Â  <div class="container">
Â  Â  Â  Â  <div class="main-area">
Â  Â  Â  Â  Â  Â  <button class="back-btn" onclick="handleBackButton()">â†</button>

Â  Â  Â  Â  Â  Â  <div class="title">Clicker</div>
Â  Â  Â  Â  Â  Â  <div class="score-counter" id="scoreCounter">0</div> 
Â  Â  Â  Â  Â  Â  <div class="to-send" id="toSend">-- 0 --</div>
Â  Â  Â  Â  Â  Â  <button class="click-button" id="clickButton"></button>
Â  Â  Â  Â  Â  Â  <div class="timer-bar">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="timer-bar-fill" id="timerBarFill"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="timer-counter" id="timerCounter">RafraÃ®chissement : lancement</div>
Â  Â  Â  Â  Â  Â  <div class="status-label" id="statusLabel"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button class="toggle-sidebar-btn" id="toggleSidebar">â˜°</button>

Â  Â  Â  Â  <div class="sidebar" id="sidebar">
Â  Â  Â  Â  Â  Â  <button class="close-btn" id="closeBtn">Ã—</button>
Â  Â  Â  Â  Â  Â  <div class="sidebar-title">Session</div>

Â  Â  Â  Â  Â  Â  <div class="section-title">Code de session</div>
Â  Â  Â  Â  Â  Â  <div class="session-code" id="sessionCode">Chargement...</div>

Â  Â  Â  Â  Â  Â  <div class="section-title">Utilisateur</div>
Â  Â  Â  Â  Â  Â  <div class="username-label" id="usernameLabel">Utilisateur</div>

Â  Â  Â  Â  Â  Â  <div class="section-title">Joueurs prÃ©sents</div>
Â  Â  Â  Â  Â  Â  <div class="player-count" id="playerCount">1/5</div>

Â  Â  Â  Â  Â  Â  <div id="playersList">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-item" id="player1">ğŸ‘¤ Vous</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-item waiting" id="player2">âšª En attente...</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-item waiting" id="player3">âšª En attente...</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-item waiting" id="player4">âšª En attente...</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="player-item waiting" id="player5">âšª En attente...</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="section-title">Rejoindre une session</div>
Â  Â  Â  Â  Â  Â  <input type="text" class="join-input" id="joinInput" placeholder="Entrer un code ou /cha [Nom]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="join-button" id="joinButton">Rejoindre / Changer Nom</button>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <button class="upgrade-button" id="upgradeButton">AmÃ©liorations</button>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="sidebar-status" id="sidebarStatus"></div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  const API_URL = "https://project-3-api-2bgb.onrender.com";
Â  Â  let clickCount = 0;
Â  Â  let lastClickTime = 0;
Â  Â  let clickIntervals = [];
Â  Â  let sidebarVisible = true;

Â  Â  let username = localStorage.getItem("username");

Â  Â  console.log("Username rÃ©cupÃ©rÃ© du localStorage:", username);

Â  Â  // VÃ©rification de l'existence du nom d'utilisateur (redirection non incluse ici)
Â  Â  if (!username || username.trim() === "") {
Â  Â  Â  Â  // Demande un nom d'utilisateur s'il n'est pas dÃ©fini (sÃ©curitÃ©)
Â  Â  Â  Â  const inputName = prompt("Veuillez entrer votre nom d'utilisateur pour jouer :");
Â  Â  Â  Â  if (inputName && inputName.trim() !== "") {
Â  Â  Â  Â  Â  Â  username = inputName.trim();
Â  Â  Â  Â  Â  Â  localStorage.setItem("username", username);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  username = "JoueurAnonyme_" + Math.random().toString(36).substring(2, 8);
Â  Â  Â  Â  Â  Â  console.warn("âš ï¸ Nom d'utilisateur non dÃ©fini. Utilisation d'un nom anonyme par dÃ©faut.");
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const clickButton = document.getElementById('clickButton');
Â  Â  const scoreCounter = document.getElementById('scoreCounter'); 
Â  Â  const toSend = document.getElementById('toSend');
Â  Â  const timerCounter = document.getElementById('timerCounter');
Â  Â  const statusLabel = document.getElementById('statusLabel');
Â  Â  const sessionCode = document.getElementById('sessionCode');
Â  Â  const usernameLabel = document.getElementById('usernameLabel');
Â  Â  const playerCount = document.getElementById('playerCount');
Â  Â  const joinInput = document.getElementById('joinInput');
Â  Â  const joinButton = document.getElementById('joinButton');
Â  Â  const closeBtn = document.getElementById('closeBtn');
Â  Â  const sidebarStatus = document.getElementById('sidebarStatus');
Â  Â  const sidebar = document.getElementById('sidebar');
Â  Â  const toggleSidebar = document.getElementById('toggleSidebar');
Â  Â  const timerBarFill = document.getElementById('timerBarFill');
Â  Â  const upgradeButton = document.getElementById('upgradeButton'); 

Â  Â  usernameLabel.textContent = username;

Â  Â  toggleSidebar.addEventListener('click', () => { 
Â  Â  Â  Â  sidebarVisible = !sidebarVisible; 
Â  Â  Â  Â  sidebar.classList.toggle('hidden'); 
Â  Â  });

Â  Â  clickButton.addEventListener('click', onClickerClick);
Â  Â  
Â  Â  // GESTIONNAIRE D'Ã‰VÃ‰NEMENT POUR LE NOUVEAU BOUTON (fonctionnalitÃ© OK)
Â  Â  upgradeButton.addEventListener('click', openUpgradeWindow);
Â  Â  // FIN GESTIONNAIRE D'Ã‰VÃ‰NEMENT

Â  Â  window.addEventListener('beforeunload', async (e) => {
Â  Â  Â  Â  await leaveSessionSilently();
Â  Â  });

Â  Â  async function handleBackButton() {
Â  Â  Â  Â  await leaveSessionSilently();
Â  Â  Â  Â  // window.location.href = "menu.html"; // DÃ©commenter si vous avez une page de menu
Â  Â  }

Â  Â  // NOUVELLE FONCTION POUR OUVRIR LA FENÃŠTRE D'AMÃ‰LIORATION (fonctionnalitÃ© OK)
Â  Â  function openUpgradeWindow() {
Â  Â  Â  Â  // Ouvre la page 'upgrade.html' dans une nouvelle fenÃªtre/onglet
Â  Â  Â  Â  window.open("upgrade.html", "_blank", "width=500,height=700,scrollbars=yes");
Â  Â  }
Â  Â  // FIN NOUVELLE FONCTION

Â  Â  async function leaveSessionSilently() {
Â  Â  Â  Â  const code = sessionCode.textContent;
Â  Â  Â  Â  if (code === "Chargement..." || code === "Aucune session" || code === "Erreur") {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const data = JSON.stringify({ code: code, id: username });
Â  Â  Â  Â  Â  Â  if (navigator.sendBeacon) {
Â  Â  Â  Â  Â  Â  Â  Â  // Utilisation de sendBeacon pour garantir l'envoi lors de la fermeture de l'onglet
Â  Â  Â  Â  Â  Â  Â  Â  navigator.sendBeacon(`${API_URL}/leave`, data);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  await fetch(`${API_URL}/leave`, { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' }, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: data,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  keepalive: true // Maintient la requÃªte mÃªme si l'onglet se ferme
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Erreur lors de la dÃ©connexion:", e);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function onClickerClick() {
Â  Â  Â  Â  const now = Date.now() / 1000;
Â  Â  Â  Â  let freq = 0;
Â  Â  Â  Â  if (lastClickTime !== 0) {
Â  Â  Â  Â  Â  Â  const interval = now - lastClickTime;
Â  Â  Â  Â  Â  Â  clickIntervals.push(interval);
Â  Â  Â  Â  Â  Â  if (clickIntervals.length > 5) clickIntervals.shift();
Â  Â  Â  Â  Â  Â  const avg = clickIntervals.reduce((a, b) => a + b, 0) / clickIntervals.length;
Â  Â  Â  Â  Â  Â  freq = avg > 0 ? 1 / avg : 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  lastClickTime = now;

Â  Â  Â  Â  if (freq > 20) {
Â  Â  Â  Â  Â  Â  statusLabel.textContent = "âš ï¸ Autoclicker dÃ©tectÃ© âš ï¸";
Â  Â  Â  Â  Â  Â  statusLabel.style.color = "#f87171";
Â  Â  Â  Â  Â  Â  setTimeout(() => { statusLabel.textContent = ""; }, 1000);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  clickCount++;
Â  Â  Â  Â  toSend.textContent = `-- ${clickCount} --`;
Â  Â  }

Â  Â  async function sendClicks() {
Â  Â  Â  Â  const code = sessionCode.textContent;
Â  Â  Â  Â  if (code === "Chargement..." || code === "Aucune session" || code === "Erreur") {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  const toSendValue = clickCount;
Â  Â  Â  Â  clickCount = 0;
Â  Â  Â  Â  toSend.textContent = "-- 0 --";
Â  Â  Â  Â  
Â  Â  Â  Â  if (toSendValue === 0) return;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  statusLabel.textContent = `Envoi de ${toSendValue} points...`; 
Â  Â  Â  Â  Â  Â  statusLabel.style.color = "#3b82f6";

Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/poire`, { 
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', 
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' }, 
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ session: code, click: toSendValue, id: username }) 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  if (data.status !== "success") {
Â  Â  Â  Â  Â  Â  Â  Â  statusLabel.textContent = `Erreur envoi: ${data.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  statusLabel.style.color = "#ef4444";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  statusLabel.textContent = "Score envoyÃ© !"; 
Â  Â  Â  Â  Â  Â  Â  Â  statusLabel.style.color = "#10b981";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  statusLabel.textContent = "âŒ Erreur rÃ©seau envoi";
Â  Â  Â  Â  Â  Â  statusLabel.style.color = "#ef4444";
Â  Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  // FONCTION EXPLICITE DE CRÃ‰ATION DE SESSION (utilisÃ©e uniquement par loadMySession)
Â  Â  async function createSession() {
Â  Â  Â  Â  sessionCode.textContent = "CrÃ©ation...";
Â  Â  Â  Â  sidebarStatus.textContent = "â³ CrÃ©ation d'une nouvelle session...";
Â  Â  Â  Â  sidebarStatus.style.color = "#f59e0b";

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/create`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ id: username })
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  if (data.status === "success" && data.session_name) {
Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = data.session_name;
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "ğŸ‰ Session crÃ©Ã©e ! Code : " + data.session_name;
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#10b981";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = "Erreur";
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âŒ Erreur lors de la crÃ©ation de session : " + (data.message || "Inconnue");
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  sessionCode.textContent = "Erreur";
Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âŒ Erreur rÃ©seau lors de la crÃ©ation";
Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444";
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // GÃˆRE LE CHARGEMENT OU LA CRÃ‰ATION AUTOMATIQUE (Logique principale de crÃ©ation)
Â  Â  async function loadMySession() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/session?user=${encodeURIComponent(username)}`);
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (data.status === "success" && data.code) {
Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = data.code;
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âœ… Session chargÃ©e";
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#10b981";
Â  Â  Â  Â  Â  Â  } else if (data.status === "error" && (data.message.includes("not in any session") || data.message.includes("not found"))) {
Â  Â  Â  Â  Â  Â  Â  Â  // CrÃ©ation automatique si l'utilisateur n'est dans aucune session.
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Utilisateur non trouvÃ© dans une session. CrÃ©ation automatique...");
Â  Â  Â  Â  Â  Â  Â  Â  await createSession(); 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = "Aucune session";
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "â„¹ï¸ Aucune session trouvÃ©e";
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#94a3b8";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  sessionCode.textContent = "Erreur";
Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âŒ Erreur rÃ©seau";
Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444";
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function fetchGameData() {
Â  Â  Â  Â  const code = sessionCode.textContent;
Â  Â  Â  Â  if (code === "Chargement..." || code === "Aucune session" || code === "Erreur") {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // RÃ©cupÃ©ration du score
Â  Â  Â  Â  Â  Â  const scoreResponse = await fetch(`${API_URL}/get_poires?session=${encodeURIComponent(code)}`);
Â  Â  Â  Â  Â  Â  const scoreData = await scoreResponse.json();

Â  Â  Â  Â  Â  Â  if (scoreData.status === "success") {
Â  Â  Â  Â  Â  Â  Â  Â  scoreCounter.textContent = scoreData.poires || 0; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // RÃ©cupÃ©ration des joueurs
Â  Â  Â  Â  Â  Â  const playersResponse = await fetch(`${API_URL}/verify_session?id=${encodeURIComponent(username)}`);
Â  Â  Â  Â  Â  Â  const playersData = await playersResponse.json();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (playersData.status === "success") {
Â  Â  Â  Â  Â  Â  Â  Â  updatePlayersList(playersData.players, playersData.creator);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Erreur lors du rafraÃ®chissement des donnÃ©es:", e);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function updatePlayersList(players, creator) {
Â  Â  Â  Â  const playerSlots = [document.getElementById('player1'), document.getElementById('player2'), document.getElementById('player3'), document.getElementById('player4'), document.getElementById('player5')];

Â  Â  Â  Â  let activePlayers = [];
Â  Â  Â  Â  if (creator) {
Â  Â  Â  Â  Â  Â  activePlayers.push(creator);
Â  Â  Â  Â  }
Â  Â  Â  Â  players.forEach(p => {
Â  Â  Â  Â  Â  Â  if (p !== creator) {
Â  Â  Â  Â  Â  Â  Â  Â  activePlayers.push(p);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  const uniqueActivePlayers = [...new Set(activePlayers)];

Â  Â  Â  Â  playerCount.textContent = `${uniqueActivePlayers.length}/5`;

Â  Â  Â  Â  playerSlots.forEach((slot, index) => {
Â  Â  Â  Â  Â  Â  const player = uniqueActivePlayers[index];
Â  Â  Â  Â  Â  Â  if (player) {
Â  Â  Â  Â  Â  Â  Â  Â  let displayString = "";
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (player === username) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (player === creator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayString = `ğŸ‘‘ ğŸ‘¤ Vous`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayString = `ğŸ‘¤ Vous`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (player === creator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayString = `ğŸ‘‘ ${player}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayString = `â€¢ ${player}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  slot.textContent = displayString;
Â  Â  Â  Â  Â  Â  Â  Â  slot.classList.remove('waiting');
Â  Â  Â  Â  Â  Â  Â  Â  slot.style.color = player === username ? '#ffd966' : '#10b981';
Â  Â  Â  Â  Â  Â  Â  Â  slot.style.borderLeft = player === username ? '3px solid #ffb84d' : '3px solid #10b981';


Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  slot.textContent = "âšª En attente...";
Â  Â  Â  Â  Â  Â  Â  Â  slot.classList.add('waiting');
Â  Â  Â  Â  Â  Â  Â  Â  slot.style.color = '#64748b';
Â  Â  Â  Â  Â  Â  Â  Â  slot.style.borderLeft = '3px solid #64748b';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }


Â  Â  function resetPlayersList() {
Â  Â  Â  Â  const playerSlots = [document.getElementById('player1'), document.getElementById('player2'), document.getElementById('player3'), document.getElementById('player4'), document.getElementById('player5')];
Â  Â  Â  Â  playerCount.textContent = `0/5`;
Â  Â  Â  Â  playerSlots.forEach((slot, index) => {
Â  Â  Â  Â  Â  Â  if (index === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  slot.textContent = "ğŸ‘¤ Vous (DÃ©connectÃ©)";
Â  Â  Â  Â  Â  Â  Â  Â  slot.classList.remove('waiting');
Â  Â  Â  Â  Â  Â  Â  Â  slot.style.color = '#ffd966'; 
Â  Â  Â  Â  Â  Â  Â  Â  slot.style.borderLeft = '3px solid #ffb84d';
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  slot.textContent = "âšª En attente...";
Â  Â  Â  Â  Â  Â  Â  Â  slot.classList.add('waiting');
Â  Â  Â  Â  Â  Â  Â  Â  slot.style.color = '#64748b';
Â  Â  Â  Â  Â  Â  Â  Â  slot.style.borderLeft = '3px solid #64748b';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  closeBtn.addEventListener('click', async () => {
Â  Â  Â  Â  const code = sessionCode.textContent;
Â  Â  Â  Â  if (code === "Chargement..." || code === "Aucune session") { 
Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âš ï¸ Pas de session active"; 
Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#f59e0b"; 
Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  closeBtn.disabled = true;
Â  Â  Â  Â  
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/leave`, { 
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', 
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' }, 
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ code: code, id: username }) 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  if (data.status === "success") { 
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âœ… Session quittÃ©e"; 
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#10b981"; 
Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = "Aucune session"; 
Â  Â  Â  Â  Â  Â  Â  Â  resetPlayersList(); 
Â  Â  Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `âŒ Impossible de quitter : ${data.message}`; 
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444"; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) { 
Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âŒ Erreur rÃ©seau"; 
Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444"; 
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  closeBtn.disabled = false;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // LOGIQUE MODIFIÃ‰E DU BOUTON REJOINDRE/CHANGER NOM
Â  Â  joinButton.addEventListener('click', async () => {
Â  Â  Â  Â  let input = joinInput.value.trim();
Â  Â  Â  Â  
Â  Â  Â  Â  joinButton.disabled = true;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (input.toLowerCase().startsWith("/cha ")) {
Â  Â  Â  Â  Â  Â  Â  Â  // Logique pour changer le nom de session
Â  Â  Â  Â  Â  Â  Â  Â  const newSessionName = input.substring(5).trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (!newSessionName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âš ï¸ Nom de session manquant";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#f59e0b";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return; // Sortie prÃ©coce
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `Changement du nom en '${newSessionName}'...`;
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/change_session`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ id: username, new_session_name: newSessionName })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (data.status === "success") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `âœ… ${data.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#10b981";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = newSessionName;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `âŒ Erreur changement : ${data.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  joinInput.value = "";
Â  Â  Â  Â  Â  Â  } else if (!input) {
Â  Â  Â  Â  Â  Â  Â  Â  // Si l'entrÃ©e est vide (il n'y a plus de crÃ©ation ici)
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âš ï¸ Veuillez entrer un code de session pour rejoindre.";
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#f59e0b";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Si l'entrÃ©e n'est pas vide (l'utilisateur veut rejoindre)
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `Tentative de rejoindre la session '${input}'...`;
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/join`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ code: input, id: username })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (data.status === "success") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `âœ… Session '${input}' rejointe!`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#10b981";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = input;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `âŒ Erreur : ${data.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  joinInput.value = "";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âŒ Erreur rÃ©seau / Commande non valide";
Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444";
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  joinButton.disabled = false;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- LOGIQUE DE SYNCHRONISATION UTC ---

Â  Â  const REFRESH_PERIOD_SECONDS = 5;
Â  Â  let timerInterval;

Â  Â  function getWaitTime() {
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  const utcSeconds = now.getUTCSeconds(); 
Â  Â  Â  Â  
Â  Â  Â  Â  const elapsed = utcSeconds % REFRESH_PERIOD_SECONDS;
Â  Â  Â  Â  const waitTimeSeconds = REFRESH_PERIOD_SECONDS - elapsed;
Â  Â  Â  Â  
Â  Â  Â  Â  return waitTimeSeconds * 1000;
Â  Â  }

Â  Â  function updateDisplay(timeLeft) {
Â  Â  Â  Â  timerBarFill.style.width = `${((REFRESH_PERIOD_SECONDS - timeLeft) / REFRESH_PERIOD_SECONDS) * 100}%`;
Â  Â  Â  Â  timerCounter.textContent = `RafraÃ®chissement dans ${timeLeft}s`;
Â  Â  }

Â  Â  async function gameCycle() {
Â  Â  Â  Â  await sendClicks();
Â  Â  Â  Â  await fetchGameData();
Â  Â  Â  Â  startInterval();
Â  Â  }

Â  Â  function startInterval() {
Â  Â  Â  Â  clearInterval(timerInterval);

Â  Â  Â  Â  let timeLeft = REFRESH_PERIOD_SECONDS; 

Â  Â  Â  Â  timerInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  timeLeft--;
Â  Â  Â  Â  Â  Â  updateDisplay(timeLeft);

Â  Â  Â  Â  Â  Â  if (timeLeft === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timerInterval);
Â  Â  Â  Â  Â  Â  Â  Â  gameCycle(); 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  }, 1000); 
Â  Â  }

Â  Â  // Lancement et synchronisation
Â  Â  loadMySession().then(() => {
Â  Â  Â  Â  fetchGameData(); 

Â  Â  Â  Â  const waitTime = getWaitTime();
Â  Â  Â  Â  
Â  Â  Â  Â  updateDisplay(Math.ceil(waitTime / 1000));
Â  Â  Â  Â  timerCounter.textContent = `Synchronisation dans ${Math.ceil(waitTime / 1000)}s`;

Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  gameCycle(); 
Â  Â  Â  Â  }, waitTime);
Â  Â  });
</script>
</body>
</html>