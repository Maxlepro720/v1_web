<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Clicker Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #232323; overflow: hidden; }
        .container { display: flex; width: 100vw; height: 100vh; position: relative; overflow: hidden; }
        .main-area { flex: 1; background: #1b1b1b; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; position: relative; min-width: 0; }
        .title { color: #ffffff; font-size: clamp(32px, 6vw, 60px); font-weight: bold; margin-bottom: 15px; text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); }
        .score-counter { color: #ffffff; font-size: clamp(20px, 3vw, 32px); font-weight: bold; margin-bottom: 10px; opacity: 0.9; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); background: rgba(255, 255, 255, 0.1); padding: 8px 25px; border-radius: 20px; backdrop-filter: blur(10px); }
        .to-send { color: #ffffff; font-size: clamp(14px, 2vw, 20px); margin-bottom: 30px; opacity: 0.9; }
        .click-button { width: min(30vh, 30vw, 220px); height: min(30vh, 30vw, 220px); max-width: 220px; max-height: 220px; aspect-ratio: 1/1; border-radius: 50%; background: linear-gradient(145deg, #ffd966, #ffb84d); border: 6px solid #ff6b35; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4); position: relative; overflow: hidden; flex-shrink: 0; }
        .click-button::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 85%; border-radius: 50%; background-size: cover; background-position: center; }
        .click-button:hover { transform: scale(1.1); box-shadow: 0 15px 40px rgba(255, 107, 53, 0.6); }
        .click-button:active { transform: scale(0.95); box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3); }
        .timer-counter { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: #FFFFFF; font-size: clamp(12px, 1.5vw, 16px); font-weight: bold; background: rgba(0, 0, 0, 0.3); padding: 10px 25px; border-radius: 30px; backdrop-filter: blur(10px); min-width: 200px; max-width: 90%; text-align: center; }
        .timer-bar { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: min(250px, 80%); height: 4px; background: rgba(255, 255, 255, 0.2); border-radius: 2px; overflow: hidden; }
        .timer-bar-fill { height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6); border-radius: 2px; transition: width 0.1s linear; }
        .status-label { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: #FFFFFF; font-size: clamp(11px, 1.5vw, 14px); padding: 6px 14px; border-radius: 8px; background: rgba(0, 0, 0, 0.5); max-width: 90%; text-align: center; }
        .sidebar { width: clamp(280px, 30vw, 350px); max-width: 100vw; background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%); padding: 20px; position: absolute; right: 0; top: 0; height: 100vh; transform: translateX(0); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; overflow-y: auto; box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3); }
        .sidebar.hidden { transform: translateX(100%); }
        .toggle-sidebar-btn { position: absolute; top: 20px; left: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; width: clamp(40px, 6vw, 50px); height: clamp(40px, 6vw, 50px); border-radius: 50%; cursor: pointer; font-size: clamp(18px, 3vw, 24px); z-index: 101; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); display: flex; align-items: center; justify-content: center; }
        .toggle-sidebar-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6); }
        .close-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; width: clamp(35px, 5vw, 40px); height: clamp(35px, 5vw, 40px); border-radius: 12px; cursor: pointer; font-size: clamp(18px, 3vw, 24px); font-weight: bold; position: absolute; top: 20px; right: 20px; transition: all 0.2s ease; box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3); display: flex; align-items: center; justify-content: center; line-height: 1; }
        .close-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5); }
        .close-btn:disabled { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); cursor: not-allowed; opacity: 0.6; }
        .sidebar-title { color: #f8fafc; font-size: clamp(20px, 3vw, 28px); font-weight: bold; margin-bottom: 25px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .section-title { color: #cbd5e1; font-size: clamp(11px, 1.5vw, 13px); font-weight: bold; margin-top: 20px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .session-code { color: #60a5fa; font-size: clamp(22px, 3.5vw, 32px); font-weight: bold; margin-bottom: 18px; text-shadow: 0 2px 8px rgba(96, 165, 250, 0.3); word-break: break-all; }
        .username-label, .player-count { color: #f8fafc; font-size: clamp(14px, 2vw, 16px); margin-bottom: 10px; }
        .player-item { color: #10b981; font-size: clamp(13px, 1.8vw, 15px); margin: 8px 0; padding: 8px 12px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border-left: 3px solid #10b981; transition: all 0.3s ease; word-break: break-word; }
        .player-item:hover { background: rgba(16, 185, 129, 0.2); transform: translateX(5px); }
        .player-item.waiting { color: #64748b; background: rgba(100, 116, 139, 0.1); border-left: 3px solid #64748b; }
        .join-input { width: 100%; height: clamp(40px, 5vh, 45px); border-radius: 12px; border: 2px solid #475569; background: rgba(51, 65, 85, 0.6); color: #f8fafc; padding: 0 14px; font-size: clamp(13px, 1.8vw, 15px); margin-top: 10px; transition: all 0.3s ease; backdrop-filter: blur(5px); }
        .join-input:focus { outline: none; border-color: #60a5fa; background: rgba(51, 65, 85, 0.8); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2); }
        .join-input::placeholder { color: #94a3b8; }
        .join-button { width: 100%; height: clamp(42px, 5.5vh, 48px); border-radius: 12px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-size: clamp(13px, 1.8vw, 15px); font-weight: bold; cursor: pointer; margin-top: 12px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .join-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
        .join-button:active { transform: translateY(0); }
        .upgrade-button { width: 100%; height: clamp(42px, 5.5vh, 48px); border-radius: 12px; border: none; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: clamp(13px, 1.8vw, 15px); font-weight: bold; cursor: pointer; margin-top: 12px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3); }
        .upgrade-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4); background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
        .upgrade-button:active { transform: translateY(0); }
        .sidebar-status { color: #94a3b8; font-size: clamp(11px, 1.5vw, 12px); margin-top: 10px; min-height: 20px; word-break: break-word; }
        .back-btn { position: absolute; top: 20px; left: 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; width: clamp(40px, 6vw, 50px); height: clamp(40px, 6vw, 50px); border-radius: 50%; cursor: pointer; font-size: clamp(18px, 3vw, 24px); display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); transition: all 0.3s ease; z-index: 102; }
        .back-btn:hover { transform: scale(1.1); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }
        .player-item { padding: 8px; margin-bottom: 5px; border-radius: 4px; background-color: #374151; border-left: 3px solid #10b981; transition: all 0.2s ease-in-out; }
        .player-item.waiting { color: #64748b; background: #1f2937; border-left: 3px solid #64748b; }
        .player-item-me { font-weight: bold; color: #fcd34d; border-left: 3px solid #fcd34d; background: #3f3f46; }
        .player-item-creator { color: #ff6b35; border-left: 3px solid #ff6b35; background: rgba(255, 107, 53, 0.15); }
        @media (max-width: 768px) {
            .sidebar { width: 85vw; }
            .main-area { padding: 15px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; }
            .click-button { width: min(40vw, 40vh, 200px); height: min(40vw, 40vh, 200px); flex-shrink: 0; }
            #joinButtonMobile { display: block; width: 90%; height: 50px; margin: 10px auto; order: 3; border-radius: 12px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-size: 15px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); transition: all 0.3s ease; }
            #joinButtonMobile:hover { transform: translateY(-2px); }
            #joinButtonMobile:active { transform: translateY(0); }
            #joinInputMobile { display: block; width: 90%; height: 45px; margin: 0 auto; order: 4; border-radius: 12px; border: 2px solid #475569; background: rgba(51, 65, 85, 0.6); color: #f8fafc; padding: 0 14px; font-size: 15px; margin-bottom: 20px; }
            #joinInputMobile::placeholder { color: #94a3b8; }
            #joinInputMobile:focus { outline: none; border-color: #60a5fa; background: rgba(51, 65, 85, 0.8); box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2); }
            .score-counter { order: 1; margin-bottom: 30px; margin-top: 50px; }
            .click-button { order: 2; margin: 30px 0; }
            .join-input, .join-button, .upgrade-button { display: none !important; }
            .back-btn { top: 10px; left: 10px; }
            .toggle-sidebar-btn { top: 10px; left: 70px; }
            .title { order: -2; margin-top: 0; }
            .to-send { order: -1; margin-bottom: 0; }
            .timer-bar, .timer-counter, .status-label { display: none !important; }
        }
        @media (max-width: 480px) {
            .sidebar { width: 90vw; }
            .click-button { width: min(50vw, 45vh, 180px); height: min(50vw, 45vh, 180px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-area">
            <a href="menu.html"><button class="back-btn">‚Üê</button></a>
            <button class="toggle-sidebar-btn" id="toggleSidebar">‚ò∞</button>
            <div class="title">Clicker</div>
            <div class="score-counter" id="scoreCounter">0</div>
            <div class="to-send" id="toSend">-- 0 --</div>
            <button class="click-button" id="clickButton"></button>
            <button class="join-button" id="joinButtonMobile" style="display:none;">Rejoindre</button>
            <input type="text" class="join-input" id="joinInputMobile" placeholder="Entrer un code ou /cha code" style="display:none;">
            <div class="timer-bar">
                <div class="timer-bar-fill" id="timerBarFill"></div>
            </div>
            <div class="timer-counter" id="timerCounter">Rafra√Æchissement : lancement</div>
            <div class="status-label" id="statusLabel"></div>
        </div>
        <div class="sidebar hidden" id="sidebar">
            <button class="close-btn" id="closeBtn">√ó</button>
            <div class="sidebar-title">Session</div>
            <div class="section-title">Code de session</div>
            <div class="session-code" id="sessionCode">Chargement...</div>
            <div class="section-title">Utilisateur</div>
            <div class="username-label" id="usernameLabel">Utilisateur</div>
            <div class="section-title">Joueurs pr√©sents</div>
            <div class="player-count" id="playerCount">1/5</div>
            <div id="playersList">
                <div class="player-item" id="player1">üë§ Vous</div>
                <div class="player-item waiting" id="player2">‚ö™ En attente...</div>
                <div class="player-item waiting" id="player3">‚ö™ En attente...</div>
                <div class="player-item waiting" id="player4">‚ö™ En attente...</div>
                <div class="player-item waiting" id="player5">‚ö™ En attente...</div>
            </div>
            <div class="section-title">Rejoindre / Changer nom</div>
            <input type="text" class="join-input" id="joinInput" placeholder="Entrer un code ou /cha code">
            <button class="join-button" id="joinButton">Rejoindre/Changer</button>
            <a href="upgrade.html" target="_blank"><button class="upgrade-button" id="upgradeButton">‚ö° Am√©lioration</button></a>
            <div class="sidebar-status" id="sidebarStatus"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://project-3-api-2bgb.onrender.com";
        const SCORE_REFRESH_PERIOD_SECONDS = 10;
        const CLICKS_MIN_SECONDS = 4;
        const CLICKS_MAX_SECONDS = 8;
        
        let clickCount = 0;
        let lastClickTime = 0;
        let clickIntervals = [];
        let username = localStorage.getItem("username");
        let isRedirecting = false;
        let timerInterval;
        let clicksTimeout;
        
        // Stocke les infos de session actuelle
        let currentSessionData = {
            code: null,
            creator: null,
            players: []
        };

        function stopAllCycles() {
            clearInterval(timerInterval);
            clearTimeout(clicksTimeout);
        }

        function stopClicksInterval() {
            clearTimeout(clicksTimeout);
        }

        function startClicksInterval() {
            stopClicksInterval();
            const duration = Math.floor(Math.random() * (CLICKS_MAX_SECONDS - CLICKS_MIN_SECONDS + 1)) + CLICKS_MIN_SECONDS;
            clicksTimeout = setTimeout(sendClicksRandomly, duration * 1000);
            console.log(`[CLICS] Prochain envoi dans : ${duration}s`);
        }

        function updateDisplay(timeLeft) {
            const timerCounter = document.getElementById('timerCounter');
            const timerBarFill = document.getElementById('timerBarFill');
            if (timerCounter) timerCounter.textContent = `Rafra√Æchissement dans : ${timeLeft}s`;
            if (timerBarFill) timerBarFill.style.width = `${(timeLeft / SCORE_REFRESH_PERIOD_SECONDS) * 100}%`;
        }

        function startScoreInterval(initialWaitTime = SCORE_REFRESH_PERIOD_SECONDS) {
            clearInterval(timerInterval);
            let timeLeft = initialWaitTime;
            updateDisplay(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    gameCycle();
                }
            }, 1000);
        }

        async function gameCycle() {
            const sessionCode = document.getElementById('sessionCode').textContent;
            if (["Aucune session", "Erreur", "Chargement...", "Cr√©ation..."].includes(sessionCode)) {
                console.warn("[SCORE] Session invalide.");
                startScoreInterval();
                return;
            }
            console.log(`[SCORE] Rafra√Æchissement pour : ${sessionCode}`);
            const counterElement = document.getElementById('timerCounter');
            if (counterElement) counterElement.textContent = "‚è≥";
            await sendClicksRandomly();
            await fetchGameData();
            startClicksInterval();
            startScoreInterval();
        }

        async function getPlayerSessionInfo() {
            try {
                const response = await fetch(`${API_URL}/verify_session?id=${encodeURIComponent(username)}`);
                const data = await response.json();
                return data.status === "success" ? data : null;
            } catch (e) {
                console.error("Erreur getPlayerSessionInfo:", e);
                return null;
            }
        }

        // =====================================================
        // NOUVELLE FONCTION: Rafra√Æchit les joueurs avec retry
        // 3 tentatives √† 2 secondes d'intervalle
        // =====================================================
        async function fetchPlayersWithRetry(maxRetries = 3, intervalMs = 2000) {
            for (let i = 0; i < maxRetries; i++) {
                console.log(`[FETCH_PLAYERS_RETRY] Tentative ${i + 1}/${maxRetries}`);
                await fetchPlayers();
                
                // V√©rifie si on a bien r√©cup√©r√© des joueurs
                if (currentSessionData.players.length > 0 || currentSessionData.creator) {
                    console.log(`[FETCH_PLAYERS_RETRY] Succ√®s √† la tentative ${i + 1}`);
                    return true;
                }
                
                // Attend avant la prochaine tentative (sauf pour la derni√®re)
                if (i < maxRetries - 1) {
                    console.log(`[FETCH_PLAYERS_RETRY] Attente de ${intervalMs}ms...`);
                    await new Promise(resolve => setTimeout(resolve, intervalMs));
                }
            }
            console.warn("[FETCH_PLAYERS_RETRY] √âchec apr√®s toutes les tentatives");
            return false;
        }

        async function logoutSilently(shouldLogout, shouldRedirect) {
            if (isRedirecting && shouldRedirect) return;
            console.log(`[LOGOUT] D√©connexion silencieuse (Logout: ${shouldLogout ? 'Oui' : 'Non'})...`);
            stopAllCycles();
            if (shouldRedirect) isRedirecting = true;

            const sessionCode = document.getElementById('sessionCode').textContent;
            let isCreator = currentSessionData.creator === username;
            let isInGroup = currentSessionData.code === sessionCode && !isCreator;

            if (!["Aucune session", "Erreur", "Chargement...", "Cr√©ation..."].includes(sessionCode)) {
                if (isInGroup || (!shouldLogout && currentSessionData.code)) {
                    console.log(`[LOGOUT] Envoi de /leave pour ${sessionCode}`);
                    try {
                        await fetch(`${API_URL}/leave`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: sessionCode, id: username })
                        });
                    } catch (e) {
                        console.error("Erreur /leave:", e);
                    }
                }
            }

            if (shouldLogout) {
                const logoutData = JSON.stringify({ id: username });
                if (navigator.sendBeacon) {
                    navigator.sendBeacon(`${API_URL}/logout`, new Blob([logoutData], { type: 'application/json' }));
                } else {
                    try {
                        const xhr = new XMLHttpRequest();
                        xhr.open("POST", `${API_URL}/logout`, false);
                        xhr.setRequestHeader("Content-Type", "application/json");
                        xhr.send(logoutData);
                    } catch (e) {
                        console.error("Erreur /logout:", e);
                    }
                }
            }
            if (shouldRedirect) window.location.href = 'index.html';
        }

        async function handleBackButton() {
            logoutSilently(true, true);
        }

        function handleLogoutOnClose(event) {
            if (isRedirecting) return;
            logoutSilently(true, false);
        }

        async function handleLeaveSession() {
            const sessionCode = document.getElementById('sessionCode').textContent;
            const sidebarStatus = document.getElementById('sidebarStatus');
            const closeBtn = document.getElementById('closeBtn');

            if (["Chargement...", "Aucune session", "Erreur", "Cr√©ation..."].includes(sessionCode)) {
                sidebarStatus.textContent = "‚ö†Ô∏è Pas de session active √† quitter.";
                sidebarStatus.style.color = "#f59e0b";
                return;
            }

            const isCreator = currentSessionData.creator === username;
            const isInGroup = currentSessionData.code === sessionCode && !isCreator;

            if (isCreator) {
                sidebarStatus.textContent = "‚ùå Cr√©ateur : utilisez ‚Üê pour vous d√©connecter.";
                sidebarStatus.style.color = "#ef4444";
                return;
            }

            if (!isInGroup) {
                sidebarStatus.textContent = "‚ö†Ô∏è Vous √™tes dans votre session solo.";
                sidebarStatus.style.color = "#f59e0b";
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('toggleSidebar').style.display = 'flex';
                return;
            }

            try {
                closeBtn.disabled = true;
                sidebarStatus.textContent = `Quitter ${sessionCode}...`;
                sidebarStatus.style.color = "#f59e0b";

                const response = await fetch(`${API_URL}/leave`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: sessionCode, id: username })
                });
                const data = await response.json();

                if (data.status === "success") {
                    sidebarStatus.textContent = "‚úÖ Session quitt√©e.";
                    sidebarStatus.style.color = "#10b981";
                    stopAllCycles();
                    await loadMySession();
                    await fetchGameData();
                    launchGameCycle();
                } else {
                    sidebarStatus.textContent = `‚ùå ${data.message}`;
                    sidebarStatus.style.color = "#ef4444";
                }
            } catch (e) {
                sidebarStatus.textContent = "‚ùå Erreur r√©seau.";
                sidebarStatus.style.color = "#ef4444";
            } finally {
                checkCloseButtonState();
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('toggleSidebar').style.display = 'flex';
            }
        }

        async function handleJoinSession(inputId = 'joinInput') {
            const joinInput = document.getElementById(inputId);
            const sessionCodeElement = document.getElementById('sessionCode');
            const sidebarStatus = document.getElementById('sidebarStatus');
            const joinButton = document.getElementById('joinButton');
            const joinButtonMobile = document.getElementById('joinButtonMobile');

            const input_value = joinInput.value.trim();
            if (!input_value) {
                sidebarStatus.textContent = "‚ö†Ô∏è Veuillez entrer un code.";
                sidebarStatus.style.color = "#f59e0b";
                return;
            }

            if (joinButton) joinButton.disabled = true;
            if (joinButtonMobile) joinButtonMobile.disabled = true;

            sidebarStatus.textContent = `Traitement...`;
            sidebarStatus.style.color = "#60a5fa";

            const isChangeCommand = input_value.toLowerCase().startsWith('/cha ');
            const newCode = isChangeCommand ? input_value.substring(5).trim() : '';
            let isSuccessful = false;

            if (isChangeCommand) {
                if (newCode.length < 3) {
                    sidebarStatus.textContent = "‚ùå Min 3 caract√®res.";
                    sidebarStatus.style.color = "#ef4444";
                } else {
                    try {
                        const response = await fetch(`${API_URL}/change_session`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: username, new_session_name: newCode })
                        });
                        const data = await response.json();

                        if (data.status === "success" && data.new_code === newCode) {
                            stopAllCycles();
                            sessionCodeElement.textContent = newCode;
                            currentSessionData.code = newCode;
                            await fetchGameData();
                            sidebarStatus.textContent = `‚úÖ Session: ${newCode}`;
                            sidebarStatus.style.color = "#10b981";
                            launchGameCycle();
                            isSuccessful = true;
                        } else {
                            sidebarStatus.textContent = `‚ùå ${data.message || 'Erreur'}`;
                            sidebarStatus.style.color = "#ef4444";
                        }
                    } catch (e) {
                        sidebarStatus.textContent = "‚ùå Erreur r√©seau.";
                        sidebarStatus.style.color = "#ef4444";
                    }
                }
                if (isSuccessful) joinInput.value = "";
            } else {
                const codeToJoin = input_value;
                console.log(`[JOIN] Rejoindre: ${codeToJoin}`);
                let joinedSuccessfully = false;

                await logoutSilently(false, false);

                try {
                    const response = await fetch(`${API_URL}/join`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code: codeToJoin, id: username })
                    });
                    const data = await response.json();

                    if (data.status === "success") {
                        stopAllCycles();
                        sessionCodeElement.textContent = codeToJoin;
                        
                        // Mise √† jour imm√©diate avec les donn√©es du /join
                        currentSessionData.code = codeToJoin;
                        if (data.players) {
                            currentSessionData.players = data.players;
                        }

                        sidebarStatus.textContent = `‚úÖ Rejoint: ${codeToJoin}. Sync joueurs...`;
                        sidebarStatus.style.color = "#10b981";

                        // =====================================================
                        // CORRECTION: 3 tentatives √† 2s d'intervalle pour r√©cup√©rer
                        // les joueurs car l'API met du temps √† stocker
                        // =====================================================
                        await fetchPlayersWithRetry(3, 2000);
                        
                        await fetchGameData();
                        sidebarStatus.textContent = `‚úÖ Session rejointe: ${codeToJoin}`;
                        launchGameCycle();
                        joinedSuccessfully = true;
                    } else {
                        sidebarStatus.textContent = `‚ùå ${data.message || 'Code invalide'}`;
                        sidebarStatus.style.color = "#ef4444";
                        console.log("[JOIN FAIL] Retour session perso.");
                        stopAllCycles();
                        await loadMySession();
                        await fetchGameData();
                        launchGameCycle();
                    }
                } catch (e) {
                    sidebarStatus.textContent = "‚ùå Erreur r√©seau.";
                    sidebarStatus.style.color = "#ef4444";
                    console.error("Erreur /join:", e);
                    stopAllCycles();
                    await loadMySession();
                    await fetchGameData();
                    launchGameCycle();
                }

                if (joinedSuccessfully) joinInput.value = "";
            }

            if (joinButton) joinButton.disabled = false;
            if (joinButtonMobile) joinButtonMobile.disabled = false;
            checkCloseButtonState();
        }

        function handleJoinSessionMobile() {
            handleJoinSession('joinInputMobile');
        }

        function onCLickerClick() {
            const statusLabel = document.getElementById('statusLabel');
            const toSend = document.getElementById('toSend');
            const now = Date.now() / 1000;
            let freq = 0;

            if (lastClickTime !== 0) {
                const interval = now - lastClickTime;
                clickIntervals.push(interval);
                if (clickIntervals.length > 5) clickIntervals.shift();
                const avg = clickIntervals.reduce((a, b) => a + b, 0) / clickIntervals.length;
                freq = avg > 0 ? 1 / avg : 0;
            }
            lastClickTime = now;

            if (freq > 20) {
                if (statusLabel) {
                    statusLabel.textContent = "‚ö†Ô∏è Autoclicker d√©tect√© ‚ö†Ô∏è";
                    statusLabel.style.color = "#f87171";
                    setTimeout(() => { statusLabel.textContent = ""; statusLabel.style.color = "#FFFFFF"; }, 1000);
                }
                return;
            }

            clickCount++;
            if (toSend) toSend.textContent = `-- ${clickCount} --`;
        }

        async function sendClicksRandomly() {
            const sessionCode = document.getElementById('sessionCode').textContent;
            if (["Chargement...", "Aucune session", "Erreur", "Cr√©ation..."].includes(sessionCode)) return;

            const toSendValue = clickCount;
            try {
                if (toSendValue > 0) {
                    console.log(`[CLICS] Envoi de ${toSendValue} clics`);
                    const response = await fetch(`${API_URL}/poire`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session: sessionCode, click: toSendValue, id: username })
                    });
                    if (response.ok) {
                        clickCount = 0;
                        const toSend = document.getElementById('toSend');
                        if (toSend) toSend.textContent = "-- 0 --";
                    }
                }
            } catch (e) {
                const statusLabel = document.getElementById('statusLabel');
                if (statusLabel) {
                    statusLabel.textContent = "‚ùå Erreur envoi";
                    statusLabel.style.color = "#ef4444";
                }
            } finally {
                if (!timerInterval) startClicksInterval();
            }
        }

        async function fetchPlayers() {
            const sessionCodeElement = document.getElementById('sessionCode');
            const currentDisplayedCode = sessionCodeElement.textContent;

            if (["Chargement...", "Aucune session", "Erreur", "Cr√©ation..."].includes(currentDisplayedCode)) return;

            console.log(`[FETCH_PLAYERS] R√©cup√©ration pour: ${currentDisplayedCode}`);

            try {
                // Utilise /verify_session qui retourne la session o√π le joueur se trouve
                const response = await fetch(`${API_URL}/verify_session?id=${encodeURIComponent(username)}`);
                const data = await response.json();

                if (data.status === "success" && data.session_code) {
                    // V√©rifie que c'est bien la session affich√©e
                    if (data.session_code === currentDisplayedCode) {
                        currentSessionData = {
                            code: data.session_code,
                            creator: data.creator,
                            players: data.players || []
                        };
                        console.log(`[FETCH_PLAYERS] Joueurs:`, currentSessionData.players, `Cr√©ateur:`, currentSessionData.creator);
                        updatePlayersList(currentSessionData.players, currentSessionData.creator);
                        checkCloseButtonState();
                    } else {
                        console.warn(`[FETCH_PLAYERS] D√©sync: API=${data.session_code}, Affich√©=${currentDisplayedCode}`);
                        // Force la mise √† jour du code affich√© si diff√©rent
                        sessionCodeElement.textContent = data.session_code;
                        currentSessionData = {
                            code: data.session_code,
                            creator: data.creator,
                            players: data.players || []
                        };
                        updatePlayersList(currentSessionData.players, currentSessionData.creator);
                        checkCloseButtonState();
                    }
                }
            } catch (e) {
                console.error("Erreur fetchPlayers:", e);
            }
        }

        async function fetchGameData() {
            const sessionCode = document.getElementById('sessionCode').textContent;
            const scoreCounter = document.getElementById('scoreCounter');

            if (["Chargement...", "Aucune session", "Erreur", "Cr√©ation..."].includes(sessionCode)) return;

            try {
                const scoreResponse = await fetch(`${API_URL}/get_poires?session=${encodeURIComponent(sessionCode)}`);
                const scoreData = await scoreResponse.json();

                if (scoreData.status === "success" && scoreCounter) {
                    const currentScore = parseInt(scoreCounter.textContent) || 0;
                    const newScore = scoreData.poires || 0;
                    const steps = 10;
                    const diff = newScore - currentScore;
                    const stepValue = diff / steps;
                    for (let i = 1; i <= steps; i++) {
                        const value = Math.round(currentScore + stepValue * i);
                        setTimeout(() => { scoreCounter.textContent = value; }, i * 100);
                    }
                }

                await fetchPlayers();
            } catch (e) {
                console.error("Erreur fetchGameData:", e);
            }
        }

        function checkCloseButtonState() {
            const sessionCode = document.getElementById('sessionCode').textContent;
            const closeBtn = document.getElementById('closeBtn');

            if (["Chargement...", "Aucune session", "Erreur", "Cr√©ation..."].includes(sessionCode)) {
                closeBtn.disabled = true;
                closeBtn.style.backgroundColor = "#6b7280";
                closeBtn.style.cursor = "not-allowed";
                closeBtn.textContent = "√ó";
                return;
            }

            const isCreator = currentSessionData.creator === username;
            const isInGroup = currentSessionData.code === sessionCode && !isCreator && 
                             (currentSessionData.players.length > 0 || currentSessionData.creator !== username);

            if (isCreator) {
                closeBtn.disabled = true;
                closeBtn.style.backgroundColor = "#6b7280";
                closeBtn.style.cursor = "not-allowed";
            } else if (isInGroup) {
                closeBtn.disabled = false;
                closeBtn.style.backgroundColor = "#ef4444";
                closeBtn.style.cursor = "pointer";
            } else {
                closeBtn.disabled = true;
                closeBtn.style.backgroundColor = "#6b7280";
                closeBtn.style.cursor = "not-allowed";
            }
            closeBtn.textContent = "√ó";
        }

        function updatePlayersList(players, creator) {
            const playerCount = document.getElementById('playerCount');
            const playerSlots = [
                document.getElementById('player1'),
                document.getElementById('player2'),
                document.getElementById('player3'),
                document.getElementById('player4'),
                document.getElementById('player5')
            ];
            if (!playerCount || !playerSlots[0]) return;

            let uniqueActivePlayers = [];

            // Ajoute le cr√©ateur en premier
            if (creator && !uniqueActivePlayers.includes(creator)) {
                uniqueActivePlayers.push(creator);
            }

            // Ajoute les autres joueurs
            if (players) {
                players.forEach(p => {
                    if (!uniqueActivePlayers.includes(p)) {
                        uniqueActivePlayers.push(p);
                    }
                });
            }

            // S'assure que l'utilisateur courant est dans la liste
            if (username && !uniqueActivePlayers.includes(username)) {
                uniqueActivePlayers.push(username);
            }

            uniqueActivePlayers = [...new Set(uniqueActivePlayers)].slice(0, 5);
            playerCount.textContent = `${uniqueActivePlayers.length}/5`;

            playerSlots.forEach((slot, index) => {
                const player = uniqueActivePlayers[index];
                if (slot) {
                    slot.className = 'player-item';

                    if (player) {
                        const isCreatorPlayer = player === creator;
                        const isMe = player === username;
                        let displayString = "";

                        if (isMe) {
                            displayString = isCreatorPlayer ? `üëë üë§ Vous` : `üë§ Vous`;
                            slot.classList.add('player-item-me');
                            if (isCreatorPlayer) slot.classList.add('player-item-creator');
                        } else {
                            displayString = isCreatorPlayer ? `üëë ${player}` : `ü§ñ ${player}`;
                            if (isCreatorPlayer) slot.classList.add('player-item-creator');
                        }
                        slot.textContent = displayString;
                    } else {
                        slot.textContent = '‚ö™ En attente...';
                        slot.classList.add('waiting');
                    }
                }
            });
        }

        async function createSession(sessionCode) {
            const sessionCodeElement = document.getElementById('sessionCode');
            const sidebarStatus = document.getElementById('sidebarStatus');
            sessionCodeElement.textContent = "Cr√©ation...";
            sidebarStatus.textContent = `Cr√©ation: ${sessionCode}...`;
            sidebarStatus.style.color = "#60a5fa";

            try {
                const response = await fetch(`${API_URL}/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: sessionCode, id: username })
                });
                const data = await response.json();

                if (data.status === "success") {
                    console.log(`[INIT] Session cr√©√©e: ${data.session_name}`);
                    sessionCodeElement.textContent = data.session_name;
                    currentSessionData = {
                        code: data.session_name,
                        creator: username,
                        players: [username]
                    };
                    sidebarStatus.textContent = "‚úÖ Session pr√™te.";
                    sidebarStatus.style.color = "#10b981";
                    return true;
                } else {
                    sessionCodeElement.textContent = "Erreur";
                    sidebarStatus.textContent = `‚ùå ${data.message}`;
                    sidebarStatus.style.color = "#ef4444";
                    return false;
                }
            } catch (e) {
                sessionCodeElement.textContent = "Erreur";
                sidebarStatus.textContent = "‚ùå Erreur r√©seau.";
                sidebarStatus.style.color = "#ef4444";
                return false;
            }
        }

        async function loadMySession() {
            const sessionCodeElement = document.getElementById('sessionCode');
            const sidebarStatus = document.getElementById('sidebarStatus');
            sessionCodeElement.textContent = "Chargement...";
            sidebarStatus.textContent = "Recherche session...";
            sidebarStatus.style.color = "#94a3b8";

            try {
                const sessionInfo = await getPlayerSessionInfo();

                if (sessionInfo && sessionInfo.session_code) {
                    console.log(`[INIT] Session trouv√©e: ${sessionInfo.session_code}`);
                    sessionCodeElement.textContent = sessionInfo.session_code;
                    currentSessionData = {
                        code: sessionInfo.session_code,
                        creator: sessionInfo.creator,
                        players: sessionInfo.players || [username]
                    };
                    sidebarStatus.textContent = "‚úÖ Session charg√©e.";
                    sidebarStatus.style.color = "#10b981";
                    return true;
                }

                sessionCodeElement.textContent = "Aucune session";
                return await createSession(username);
            } catch (e) {
                sessionCodeElement.textContent = "Erreur";
                sidebarStatus.textContent = "‚ùå Erreur critique.";
                sidebarStatus.style.color = "#ef4444";
                return false;
            }
        }

        function launchGameCycle() {
            startScoreInterval(3);
            startClicksInterval();
        }

        function init() {
            if (!username) {
                console.error("Username non trouv√©. Redirection.");
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('usernameLabel').textContent = `üë§ ${username}`;
            document.getElementById('clickButton').addEventListener('click', onCLickerClick);
            document.getElementById('joinButton').addEventListener('click', () => handleJoinSession('joinInput'));
            document.getElementById('closeBtn').addEventListener('click', handleLeaveSession);
            document.getElementById('joinButtonMobile').addEventListener('click', () => handleJoinSession('joinInputMobile'));
            document.getElementById('joinInputMobile').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleJoinSession('joinInputMobile'); });
            document.getElementById('joinInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') handleJoinSession('joinInput'); });

            document.getElementById('toggleSidebar').addEventListener('click', () => {
                const sidebar = document.getElementById('sidebar');
                const toggleBtn = document.getElementById('toggleSidebar');
                const isHidden = sidebar.classList.toggle('hidden');
                toggleBtn.textContent = isHidden ? '‚ò∞' : '√ó';
                toggleBtn.style.left = isHidden ? '80px' : 'calc(100vw - 30px)';
                toggleBtn.style.transform = isHidden ? 'none' : 'translateX(-100%)';
            });

            window.addEventListener('beforeunload', handleLogoutOnClose);

            loadMySession().then(success => {
                if (success) {
                    launchGameCycle();
                } else {
                    stopAllCycles();
                }
            });
        }

        init();
    </script>
</body>
</html>