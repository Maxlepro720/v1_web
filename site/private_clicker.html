<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Clicker Game</title>
    <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #232323; overflow: hidden; }

    .container {
        display: flex;
        width: 100vw;
        height: 100vh;
        position: relative;
        overflow: hidden;
    }

    .main-area {
        flex: 1;
        background: #1b1b1b;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        position: relative;
        min-width: 0;
    }

    .title {
        color: #ffffff;
        font-size: clamp(32px, 6vw, 60px);
        font-weight: bold;
        margin-bottom: 15px;
        text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    .poires-counter {
        color: #ffffff;
        font-size: clamp(20px, 3vw, 32px);
        font-weight: bold;
        margin-bottom: 10px;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 25px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
    }

    .to-send {
        color: #ffffff;
        font-size: clamp(14px, 2vw, 20px);
        margin-bottom: 30px;
        opacity: 0.9;
    }

    .click-button {
        width: min(30vh, 30vw, 220px);
        height: min(30vh, 30vw, 220px);
        max-width: 220px;
        max-height: 220px;
        aspect-ratio: 1/1;
        border-radius: 50%;
        background: linear-gradient(145deg, #ffd966, #ffb84d);
        border: 6px solid #ff6b35;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
    }

    /* avant il y avait une image ici â†’ supprimÃ©e */
    .click-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 85%;
        height: 85%;
        border-radius: 50%;
        background-size: cover;
        background-position: center;
    }

    .click-button:hover {
        transform: scale(1.1);
        box-shadow: 0 15px 40px rgba(255, 107, 53, 0.6);
    }

    .click-button:active {
        transform: scale(0.95);
        box-shadow: 0 5px 20px rgba(255, 107, 53, 0.3);
    }

    .timer-counter {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: #FFFFFF;
        font-size: clamp(12px, 1.5vw, 16px);
        font-weight: bold;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px 25px;
        border-radius: 30px;
        backdrop-filter: blur(10px);
        min-width: 200px;
        max-width: 90%;
        text-align: center;
    }

    .timer-bar {
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        width: min(250px, 80%);
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
    }

    .timer-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #3b82f6);
        border-radius: 2px;
        transition: width 0.1s linear;
    }

    .status-label {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        color: #FFFFFF;
        font-size: clamp(11px, 1.5vw, 14px);
        padding: 6px 14px;
        border-radius: 8px;
        background: rgba(0, 0, 0, 0.5);
        max-width: 90%;
        text-align: center;
    }

    /* Sidebar */
    .sidebar {
        width: clamp(280px, 30vw, 350px);
        max-width: 100vw;
        background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        padding: 20px;
        position: absolute;
        right: 0;
        top: 0;
        height: 100vh;
        transform: translateX(0);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 100;
        overflow-y: auto;
        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
    }

    .sidebar.hidden { transform: translateX(100%); }

    .toggle-sidebar-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        width: clamp(40px, 6vw, 50px);
        height: clamp(40px, 6vw, 50px);
        border-radius: 50%;
        cursor: pointer;
        font-size: clamp(18px, 3vw, 24px);
        z-index: 101;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toggle-sidebar-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .close-btn {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
        width: clamp(35px, 5vw, 40px);
        height: clamp(35px, 5vw, 40px);
        border-radius: 12px;
        cursor: pointer;
        font-size: clamp(18px, 3vw, 24px);
        font-weight: bold;
        position: absolute;
        top: 20px;
        right: 20px;
        transition: all 0.2s ease;
        box-shadow: 0 2px 10px rgba(239, 68, 68, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.5);
    }

    .close-btn:disabled {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        cursor: not-allowed;
        opacity: 0.6;
    }

    .sidebar-title {
        color: #f8fafc;
        font-size: clamp(20px, 3vw, 28px);
        font-weight: bold;
        margin-bottom: 25px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .section-title {
        color: #cbd5e1;
        font-size: clamp(11px, 1.5vw, 13px);
        font-weight: bold;
        margin-top: 20px;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .session-code {
        color: #60a5fa;
        font-size: clamp(22px, 3.5vw, 32px);
        font-weight: bold;
        margin-bottom: 18px;
        text-shadow: 0 2px 8px rgba(96, 165, 250, 0.3);
        word-break: break-all;
    }

    .username-label,
    .player-count {
        color: #f8fafc;
        font-size: clamp(14px, 2vw, 16px);
        margin-bottom: 10px;
    }

    .player-item {
        color: #10b981;
        font-size: clamp(13px, 1.8vw, 15px);
        margin: 8px 0;
        padding: 8px 12px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: 10px;
        border-left: 3px solid #10b981;
        transition: all 0.3s ease;
        word-break: break-word;
    }

    .player-item:hover {
        background: rgba(16, 185, 129, 0.2);
        transform: translateX(5px);
    }

    .player-item.waiting {
        color: #64748b;
        background: rgba(100, 116, 139, 0.1);
        border-left: 3px solid #64748b;
    }

    .join-input {
        width: 100%;
        height: clamp(40px, 5vh, 45px);
        border-radius: 12px;
        border: 2px solid #475569;
        background: rgba(51, 65, 85, 0.6);
        color: #f8fafc;
        padding: 0 14px;
        font-size: clamp(13px, 1.8vw, 15px);
        margin-top: 10px;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .join-input:focus {
        outline: none;
        border-color: #60a5fa;
        background: rgba(51, 65, 85, 0.8);
        box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
    }

    .join-input::placeholder { color: #94a3b8; }

    .join-button {
        width: 100%;
        height: clamp(42px, 5.5vh, 48px);
        border-radius: 12px;
        border: none;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        font-size: clamp(13px, 1.8vw, 15px);
        font-weight: bold;
        cursor: pointer;
        margin-top: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .join-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .join-button:active { transform: translateY(0); }

    .sidebar-status {
        color: #94a3b8;
        font-size: clamp(11px, 1.5vw, 12px);
        margin-top: 10px;
        min-height: 20px;
        word-break: break-word;
    }

    .back-btn {
        position: absolute;
        top: 20px;
        left: 20px;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border: none;
        width: clamp(40px, 6vw, 50px);
        height: clamp(40px, 6vw, 50px);
        border-radius: 50%;
        cursor: pointer;
        font-size: clamp(18px, 3vw, 24px);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
        transition: all 0.3s ease;
        z-index: 102;
    }

    .back-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6);
    }

    @media (max-width: 768px) {
        .sidebar { width: 85vw; }
        .main-area { padding: 15px; }
        .click-button {
            width: min(40vw, 40vh, 200px);
            height: min(40vw, 40vh, 200px);
        }
    }

    @media (max-width: 480px) {
        .sidebar { width: 90vw; }
        .click-button {
            width: min(50vw, 45vh, 180px);
            height: min(50vw, 45vh, 180px);
        }
    }
</style>

</head>
<body>
    <div class="container">
        <div class="main-area">
            <button class="back-btn" onclick="handleBackButton()">â†</button>

            <div class="title">Clicker</div>
            <div class="poires-counter" id="poiresCounter">0</div>
            <div class="to-send" id="toSend">-- 0 --</div>
            <button class="click-button" id="clickButton"></button>
            <div class="timer-bar">
                <div class="timer-bar-fill" id="timerBarFill"></div>
            </div>
            <div class="timer-counter" id="timerCounter">RafraÃ®chissement : lancement</div>
            <div class="status-label" id="statusLabel"></div>
        </div>

        <button class="toggle-sidebar-btn" id="toggleSidebar">â˜°</button>

        <div class="sidebar" id="sidebar">
            <button class="close-btn" id="closeBtn">Ã—</button>
            <div class="sidebar-title">Session</div>

            <div class="section-title">Code de session</div>
            <div class="session-code" id="sessionCode">Chargement...</div>

            <div class="section-title">Utilisateur</div>
            <div class="username-label" id="usernameLabel">Utilisateur</div>

            <div class="section-title">Joueurs prÃ©sents</div>
            <div class="player-count" id="playerCount">1/5</div>

            <div id="playersList">
                <div class="player-item" id="player1">ğŸ‘¤ Vous</div>
                <div class="player-item waiting" id="player2">âšª En attente...</div>
                <div class="player-item waiting" id="player3">âšª En attente...</div>
                <div class="player-item waiting" id="player4">âšª En attente...</div>
                <div class="player-item waiting" id="player5">âšª En attente...</div>
            </div>

            <div class="section-title">Rejoindre une session</div>
            <input type="text" class="join-input" id="joinInput" placeholder="Entrer un code">
            <button class="join-button" id="joinButton">Rejoindre</button>

            <div class="sidebar-status" id="sidebarStatus"></div>
        </div>
    </div>

    <script>
const API_URL = "https://project-3-api-2bgb.onrender.com";
let clickCount = 0;
let lastClickTime = 0;
let clickIntervals = [];
let sidebarVisible = true;

// ğŸ”¹ RÃ©cupÃ©ration du username depuis localStorage
let username = localStorage.getItem("username");

// Debug : afficher le username rÃ©cupÃ©rÃ©
console.log("Username rÃ©cupÃ©rÃ© du localStorage:", username);

// Si pas de username, redirection vers le menu
if (!username || username.trim() === "") {
Â  Â  alert("âš ï¸ Aucun nom d'utilisateur trouvÃ©. Veuillez vous connecter.");
Â  Â  window.location.href = "menu.html";
}

// ğŸ”„ VÃ©rification toutes les 3 secondes du username dans localStorage
setInterval(() => {
Â  Â  let currentUsername = localStorage.getItem("username");
Â  Â  if (!currentUsername || currentUsername.trim() === "") {
Â  Â  Â  Â  alert("âš ï¸ Votre session a expirÃ©. Veuillez vous reconnecter.");
Â  Â  Â  Â  window.location.href = "menu.html";
Â  Â  }
}, 3000);


const clickButton = document.getElementById('clickButton');
const poiresCounter = document.getElementById('poiresCounter');
const toSend = document.getElementById('toSend');
const timerCounter = document.getElementById('timerCounter');
const statusLabel = document.getElementById('statusLabel');
const sessionCode = document.getElementById('sessionCode');
const usernameLabel = document.getElementById('usernameLabel');
const playerCount = document.getElementById('playerCount');
const joinInput = document.getElementById('joinInput');
const joinButton = document.getElementById('joinButton');
const closeBtn = document.getElementById('closeBtn');
const sidebarStatus = document.getElementById('sidebarStatus');
const sidebar = document.getElementById('sidebar');
const toggleSidebar = document.getElementById('toggleSidebar');
const timerBarFill = document.getElementById('timerBarFill');

usernameLabel.textContent = username;

// Toggle sidebar
toggleSidebar.addEventListener('click', () => { 
Â  Â  sidebarVisible = !sidebarVisible; 
Â  Â  sidebar.classList.toggle('hidden'); 
});

// Load session (MODIFIÃ‰ : Ne se lance plus seul, startApp() s'en charge)
// loadMySession(); 
clickButton.addEventListener('click', onClickerClick);

// ğŸ”¹ Quitter la session automatiquement lors de la fermeture de la page
window.addEventListener('beforeunload', async (e) => {
Â  Â  await leaveSessionSilently();
});

// ğŸ”¹ Quitter la session lors du retour au menu
async function handleBackButton() {
Â  Â  await leaveSessionSilently();
Â  Â  window.location.href = "menu.html";
}

// ğŸ”¹ Fonction pour quitter la session silencieusement
async function leaveSessionSilently() {
Â  Â  const code = sessionCode.textContent;
Â  Â  if (code === "Chargement..." || code === "Aucune session" || code === "Erreur") {
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  try {
Â  Â  Â  Â  const data = JSON.stringify({ code: code, id: username });
Â  Â  Â  Â  if (navigator.sendBeacon) {
Â  Â  Â  Â  Â  Â  navigator.sendBeacon(`${API_URL}/leave`, data);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  await fetch(`${API_URL}/leave`, { 
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', 
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' }, 
Â  Â  Â  Â  Â  Â  Â  Â  body: data,
Â  Â  Â  Â  Â  Â  Â  Â  keepalive: true
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erreur lors de la dÃ©connexion:", e);
Â  Â  }
}

// ---------------- CLICKER ----------------
function onClickerClick() {
Â  Â  const now = Date.now() / 1000;
Â  Â  let freq = 0;
Â  Â  if (lastClickTime !== 0) {
Â  Â  Â  Â  const interval = now - lastClickTime;
Â  Â  Â  Â  clickIntervals.push(interval);
Â  Â  Â  Â  if (clickIntervals.length > 5) clickIntervals.shift();
Â  Â  Â  Â  const avg = clickIntervals.reduce((a, b) => a + b, 0) / clickIntervals.length;
Â  Â  Â  Â  freq = avg > 0 ? 1 / avg : 0;
Â  Â  }
Â  Â  lastClickTime = now;

Â  Â  if (freq > 20) {
Â  Â  Â  Â  statusLabel.textContent = "âš ï¸ Autoclicker dÃ©tectÃ© âš ï¸";
Â  Â  Â  Â  statusLabel.style.color = "#f87171";
Â  Â  Â  Â  setTimeout(() => { statusLabel.textContent = ""; }, 1000);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  clickCount++;
Â  Â  toSend.textContent = `-- ${clickCount} --`;
}

// ---------------- ENVOI DES POIRES ----------------
async function sendClicks() {
Â  Â  const code = sessionCode.textContent;
Â  Â  if (code === "Chargement..." || code === "Aucune session") {
Â  Â  Â  Â  statusLabel.textContent = "âš ï¸ Session non disponible";
Â  Â  Â  Â  statusLabel.style.color = "#f59e0b";
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  // MODIFIÃ‰ : On envoie les clics et on rÃ©initialise
Â  Â  const toSendValue = clickCount;
Â  Â  clickCount = 0; // RÃ©initialise le compteur
Â  Â  toSend.textContent = "-- 0 --"; // RÃ©initialise l'UI
Â  Â  
Â  Â  if (toSendValue === 0) return; // Ne pas envoyer si 0

Â  Â  try {
Â  Â  Â  Â  statusLabel.textContent = `Envoi de ${toSendValue} poires...`;
Â  Â  Â  Â  statusLabel.style.color = "#3b82f6";

Â  Â  Â  Â  const response = await fetch(`${API_URL}/poire`, { 
Â  Â  Â  Â  Â  Â  method: 'POST', 
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' }, 
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ session: code, click: toSendValue, id: username }) 
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  if (data.status !== "success") {
Â  Â  Â  Â  Â  Â  statusLabel.textContent = `Erreur envoi: ${data.message}`;
Â  Â  Â  Â  Â  Â  statusLabel.style.color = "#ef4444";
Â  Â  Â  Â  Â  Â  // Remettre les clics si l'envoi a Ã©chouÃ© ?
Â  Â  Â  Â  Â  Â  // clickCount += toSendValue; 
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  statusLabel.textContent = "Poires envoyÃ©es !";
Â  Â  Â  Â  Â  Â  statusLabel.style.color = "#10b981";
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  statusLabel.textContent = "âŒ Erreur rÃ©seau envoi";
Â  Â  Â  Â  statusLabel.style.color = "#ef4444";
Â  Â  }
}

// ---------------- SESSION ----------------
async function loadMySession() {
Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`${API_URL}/session?user=${encodeURIComponent(username)}`);
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  if (data.status === "success" && data.code) {
Â  Â  Â  Â  Â  Â  sessionCode.textContent = data.code;
Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âœ… Session chargÃ©e";
Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#10b981";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  sessionCode.textContent = "Aucune session";
Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "â„¹ï¸ Aucune session trouvÃ©e";
Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#94a3b8";
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  sessionCode.textContent = "Erreur";
Â  Â  Â  Â  sidebarStatus.textContent = "âŒ Erreur rÃ©seau";
Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444";
Â  Â  }
}

// ---------------- QUITTER / REJOINDRE ----------------
closeBtn.addEventListener('click', async () => {
Â  Â  const code = sessionCode.textContent;
Â  Â  if (code === "Chargement..." || code === "Aucune session") { 
Â  Â  Â  Â  sidebarStatus.textContent = "âš ï¸ Pas de session active"; 
Â  Â  Â  Â  sidebarStatus.style.color = "#f59e0b"; 
Â  Â  Â  Â  return; 
Â  Â  }
Â  Â  
Â  Â  closeBtn.disabled = true;
Â  Â  
Â  Â  try {
Â  Â  Â  Â  const response = await fetch(`${API_URL}/leave`, { 
Â  Â  Â  Â  Â  Â  method: 'POST', 
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' }, 
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ code: code, id: username }) 
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  if (data.status === "success") { 
Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âœ… Session quittÃ©e"; 
Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#10b981"; 
Â  Â  Â  Â  Â  Â  sessionCode.textContent = "Aucune session"; 
Â  Â  Â  Â  Â  Â  resetPlayersList(); 
Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `âŒ Impossible de quitter : ${data.message}`; 
Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444"; 
Â  Â  Â  Â  }
Â  Â  } catch (e) { 
Â  Â  Â  Â  sidebarStatus.textContent = "âŒ Erreur rÃ©seau"; 
Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444"; 
Â  Â  } finally {
Â  Â  Â  Â  closeBtn.disabled = false;
Â  Â  }
});

joinButton.addEventListener('click', async () => {
Â  Â  let input = joinInput.value.trim();
Â  Â  if (!input) { 
Â  Â  Â  Â  sidebarStatus.textContent = "âš ï¸ Veuillez entrer un code ou une commande"; 
Â  Â  Â  Â  sidebarStatus.style.color = "#f59e0b"; 
Â  Â  Â  Â  return; 
Â  Â  }

Â  Â  joinButton.disabled = true;

Â  Â  try {
Â  Â  Â  Â  if (input.toLowerCase().startsWith("/cha ")) {
Â  Â  Â  Â  Â  Â  const newSessionName = input.substring(5).trim();
Â  Â  Â  Â  Â  Â  if (!newSessionName) {
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âš ï¸ Veuillez indiquer un nom aprÃ¨s /cha";
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#f59e0b";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/change_session`, { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' }, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ id: username, new_session_name: newSessionName }) 
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (data.status === "success") { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `âœ… Nom de session changÃ© : ${newSessionName}`; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#10b981"; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = newSessionName;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  joinInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `âŒ ${data.message || 'Erreur'}`; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444"; 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const response = await fetch(`${API_URL}/join`, { 
Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST', 
Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' }, 
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ code: input, id: username }) 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  if (data.status === "success") { 
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = "âœ… Session rejointe"; 
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#10b981"; 
Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = input;
Â  Â  Â  Â  Â  Â  Â  Â  joinInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  // Forcer la mise Ã  jour des donnÃ©es aprÃ¨s avoir rejoint
Â  Â  Â  Â  Â  Â  Â  Â  fetchGameData();
Â  Â  Â  Â  Â  Â  } else { 
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.textContent = `âŒ ${data.message || 'Code introuvable'}`; 
Â  Â  Â  Â  Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444"; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } catch (e) { 
Â  Â  Â  Â  sidebarStatus.textContent = "âŒ Erreur rÃ©seau"; 
Â  Â  Â  Â  sidebarStatus.style.color = "#ef4444"; 
Â  Â  } finally {
Â  Â  Â  Â  joinButton.disabled = false;
Â  Â  }
});

// MODIFIÃ‰ : GÃ¨re 'player1' comme Ã©tant toujours 'vous'
function resetPlayersList() { 
Â  Â  const player1 = document.getElementById('player1');
Â  Â  player1.textContent = `ğŸ‘¤ ${username} (Vous)`;
Â  Â  player1.className = "player-item";
Â  Â  player1.style.color = "#10b981";
Â  Â  player1.style.borderColor = "#10b981";

Â  Â  for (let i = 2; i <= 5; i++) { 
Â  Â  Â  Â  const player = document.getElementById(`player${i}`); 
Â  Â  Â  Â  player.textContent = "âšª En attente..."; 
Â  Â  Â  Â  player.className = "player-item waiting"; 
Â  Â  } 
Â  Â  playerCount.textContent = "1/5"; 
}


// --- ğŸŒŸ NOUVELLES FONCTIONS DE SYNCHRONISATION ğŸŒŸ ---

const SYNC_INTERVAL_MS = 5000; // 5 secondes
let hasSentClicksThisCycle = false;
let isFetchingData = false;
let serverWakeUpAttempted = false;

/**
 * ğŸ”¹ [NOUVEAU] RÃ©cupÃ¨re l'Ã©tat du jeu (score, joueurs) depuis l'API
 */
async function fetchGameData() {
Â  Â  if (isFetchingData) return; // EmpÃªche les appels en double
Â  Â  
Â  Â  const code = sessionCode.textContent;
Â  Â  if (code === "Chargement..." || code === "Aucune session" || code === "Erreur") {
Â  Â  Â  Â  return; // Pas de session, on ne fait rien
Â  Â  }

Â  Â  isFetchingData = true;

Â  Â  // GÃ¨re le rÃ©veil du serveur (pour la premiÃ¨re tentative)
Â  Â  if (!serverWakeUpAttempted) {
Â  Â  Â  Â  serverWakeUpAttempted = true;
Â  Â  Â  Â  statusLabel.textContent = "RÃ©veil du serveur...";
Â  Â  Â  Â  statusLabel.style.color = "#60a5fa";
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  // â— HYPOTHÃˆSE: Tu dois crÃ©er cet endpoint cÃ´tÃ© API
Â  Â  Â  Â  // Il doit renvoyer { status: "success", poires_total: 123, players: ["user1", "user2"] }
Â  Â  Â  Â  const response = await fetch(`${API_URL}/session_data?code=${encodeURIComponent(code)}`); 
Â  Â  Â  Â  
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`Erreur HTTP: ${response.status}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  if (data.status === "success") {
Â  Â  Â  Â  Â  Â  // Mettre Ã  jour le compteur total
Â  Â  Â  Â  Â  Â  poiresCounter.textContent = data.poires_total || 0; 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Mettre Ã  jour la liste des joueurs
Â  Â  Â  Â  Â  Â  updatePlayersList(data.players || []);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Effacer le statut (sauf si un envoi est en cours)
Â  Â  Â  Â  Â  Â  if (statusLabel.textContent === "RÃ©veil du serveur...") {
Â  Â  Â  Â  Â  Â  Â  Â  statusLabel.textContent = ""; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  statusLabel.textContent = data.message || "Erreur donnÃ©es session";
Â  Â  Â  Â  Â  Â  statusLabel.style.color = "#ef4444";
Â  Â  Â  Â  Â  Â  if (data.message === "Session not found") {
Â  Â  Â  Â  Â  Â  Â  Â  sessionCode.textContent = "Aucune session";
Â  Â  Â  Â  Â  Â  Â  Â  resetPlayersList();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Erreur fetchGameData:", e);
Â  Â  Â  Â  statusLabel.textContent = "âŒ Erreur de synchro rÃ©seau";
Â  Â  Â  Â  statusLabel.style.color = "#ef4444";
Â  Â  } finally {
Â  Â  Â  Â  isFetchingData = false; // Autorise le prochain fetch
Â  Â  }
}

/**
 * ğŸ”¹ [NOUVEAU] Met Ã  jour l'UI de la liste des joueurs
 */
function updatePlayersList(players) {
Â  Â  playerCount.textContent = `${players.length}/5`;
Â  Â  let playerFound = false;
Â  Â  const playerElements = [
Â  Â  Â  Â  document.getElementById('player1'),
Â  Â  Â  Â  document.getElementById('player2'),
Â  Â  Â  Â  document.getElementById('player3'),
Â  Â  Â  Â  document.getElementById('player4'),
Â  Â  Â  Â  document.getElementById('player5')
Â  Â  ];

Â  Â  // D'abord, trouver 'vous'
Â  Â  let selfElement = playerElements[0];
Â  Â  selfElement.textContent = `ğŸ‘¤ ${username} (Vous)`;
Â  Â  selfElement.className = "player-item";
Â  Â  selfElement.style.color = "#10b981";
Â  Â  selfElement.style.borderColor = "#10b981";
Â  Â  playerFound = players.includes(username);

Â  Â  // Ensuite, les autres joueurs
Â  Â  let otherPlayers = players.filter(p => p !== username);
Â  Â  for (let i = 0; i < 4; i++) { // i=0 correspond Ã  playerElements[1]
Â  Â  Â  Â  const playerElement = playerElements[i + 1];
Â  Â  Â  Â  const playerName = otherPlayers[i];

Â  Â  Â  Â  if (playerName) {
Â  Â  Â  Â  Â  Â  playerElement.textContent = `ğŸ‘¤ ${playerName}`;
Â  Â  Â  Â  Â  Â  playerElement.className = "player-item";
Â  Â  Â  Â  Â  Â  playerElement.style.color = "#60a5fa"; // Couleur autre joueur
Â  Â  Â  Â  Â  Â  playerElement.style.borderColor = "#60a5fa";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  playerElement.textContent = "âšª En attente...";
Â  Â  Â  Â  Â  Â  playerElement.className = "player-item waiting";
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (!playerFound && players.length > 0) {
Â  Â  Â  Â  console.warn("Vous n'Ãªtes pas dans la liste des joueurs !");
Â  Â  Â  Â  // Peut-Ãªtre recharger la session si vous Ãªtes Ã©jectÃ©
Â  Â  Â  Â  // loadMySession(); 
Â  Â  }
}


/**
 * ğŸ”¹ [NOUVEAU] Boucle de jeu principale, s'exÃ©cute 10x/sec
 */
function globalTimerTick() {
Â  Â  const now = Date.now();
Â  Â  const timeSinceLastSync = now % SYNC_INTERVAL_MS;
Â  Â  const timeUntilNextSync = SYNC_INTERVAL_MS - timeSinceLastSync;
Â  Â  const secondsUntilNextSync = (timeUntilNextSync / 1000).toFixed(1);

Â  Â  // 1. Mettre Ã  jour l'UI du timer
Â  Â  const progressPercentage = (timeSinceLastSync / SYNC_INTERVAL_MS) * 100;
Â  Â  timerBarFill.style.width = `${progressPercentage}%`;
Â  Â  timerCounter.textContent = `Synchro dans : ${secondsUntilNextSync}s`;

Â  Â  // 2. GÃ©rer l'ENVOI (Objectif: 1 sec avant synchro)
Â  Â  // Si on est dans la derniÃ¨re seconde (ex: timeUntilNextSync < 1000ms)
Â  Â  // et qu'on n'a pas encore envoyÃ© les clics pour ce cycle
Â  Â  if (timeUntilNextSync <= 1000 && !hasSentClicksThisCycle) {
Â  Â  Â  Â  hasSentClicksThisCycle = true;
Â  Â  Â  Â  sendClicks(); // La fonction 'sendClicks' gÃ¨re elle-mÃªme le reset de clickCount
Â  Â  }

Â  Â  // 3. GÃ©rer la SYNCHRONISATION (Objectif: toutes les 5 sec)
Â  Â  // Si on vient de passer le "tick" de 5 secondes (ex: < 150ms aprÃ¨s)
Â  Â  // (150ms de fenÃªtre pour Ãªtre sÃ»r de l'attraper)
Â  Â  if (timeSinceLastSync < 150) { 
Â  Â  Â  Â  // Si on est au dÃ©but d'un cycle, on rÃ©initialise le flag d'envoi
Â  Â  Â  Â  if (hasSentClicksThisCycle) {
Â  Â  Â  Â  Â  Â  hasSentClicksThisCycle = false;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // On lance le fetch des donnÃ©es (la fonction a un verrou 'isFetchingData')
Â  Â  Â  Â  fetchGameData();
Â  Â  }
}

/**
 * ğŸ”¹ [NOUVEAU] Fonction de dÃ©marrage de l'application
 */
async function startApp() {
Â  Â  // 1. Charger la session de l'utilisateur pour connaÃ®tre le code
Â  Â  await loadMySession();
Â  Â  
Â  Â  // 2. Lancer le timer global (10x par seconde)
Â  Â  setInterval(globalTimerTick, 100); 

Â  Â  // 3. Premier fetch immÃ©diat (pour rÃ©veiller le serveur et charger les donnÃ©es)
Â  Â  fetchGameData();
}

// ğŸš€ DÃ‰MARRAGE DE L'APPLICATION
startApp();

</script>

</body>
</html>