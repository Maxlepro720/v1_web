<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Syst√®me d'Am√©lioration - Clash Royale</title>

<!-- FONT CLEAN -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%);
    color: #fff;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 30%, rgba(255,193,7,0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(33,150,243,0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
}

.container {
    display: flex;
    padding: 20px;
    gap: 20px;
    min-height: 100vh;
    position: relative;
    z-index: 1;
}

/* PANNEAUX */
.sidebar {
    width: 280px;
    background: linear-gradient(145deg, #2d3561 0%, #1f2547 100%);
    padding: 20px;
    border-radius: 16px;
    border: 3px solid #4a5788;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.1);
}

.sidebar h2 {
    font-size: 1.3em;
    font-weight: 700;
    margin-bottom: 15px;
    padding-bottom: 12px;
    border-bottom: 3px solid;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.sidebar-left h2 { 
    border-color: #4CAF50;
    color: #66ff66;
}
.sidebar-right h2 { 
    border-color: #ff4081;
    color: #ff6b9d;
}

/* LISTES UPGRADE */
.upgrades-container {
    max-height: 350px;
    overflow-y: auto;
    padding-right: 5px;
}

/* BOUTONS UPGRADE */
.upgrade-btn {
    width: 100%;
    background: linear-gradient(145deg, #3d4a7a 0%, #2d3561 100%);
    border: 2px solid #5a6ba8;
    color: white;
    padding: 14px;
    margin-bottom: 12px;
    font-size: 13px;
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1);
    position: relative;
    overflow: hidden;
}

.upgrade-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.upgrade-btn:hover::before {
    left: 100%;
}

.upgrade-btn.clicked {
    background: linear-gradient(145deg, #66bb6a 0%, #4caf50 100%) !important;
    color: #fff;
    border-color: #81c784;
    box-shadow: 0 0 20px rgba(76,175,80,0.6),
                0 4px 12px rgba(0,0,0,0.3) !important;
    transform: scale(1.05);
}

.upgrade-btn.disabled {
    background: linear-gradient(145deg, #37474f 0%, #263238 100%) !important;
    color: #607d8b !important;
    border-color: #455a64 !important;
    cursor: not-allowed;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important;
    opacity: 0.6;
}

.sidebar-left .upgrade-btn:hover:not(.disabled) { 
    border-color: #66ff66;
    box-shadow: 0 0 16px rgba(102,255,102,0.4),
                0 4px 12px rgba(0,0,0,0.3);
    transform: translateY(-2px);
}

.sidebar-right .upgrade-btn:hover:not(.disabled) { 
    border-color: #ff6b9d;
    box-shadow: 0 0 16px rgba(255,107,157,0.4),
                0 4px 12px rgba(0,0,0,0.3);
    transform: translateY(-2px);
}

/* BOUTON AFFICHER + / - */
.toggle-btn {
    width: 100%;
    background: linear-gradient(145deg, #5a6ba8 0%, #4a5788 100%);
    color: white;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    border: 2px solid #6a7bb8;
    border-radius: 10px;
    margin-top: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.toggle-btn:hover { 
    background: linear-gradient(145deg, #6a7bc8 0%, #5a6ba8 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
}

/* INPUT QUANTIT√â */
.quantity-input {
    width: 100%;
    padding: 14px;
    margin-bottom: 12px;
    font-size: 16px;
    font-weight: 700;
    border-radius: 10px;
    border: 2px solid #5a6ba8;
    background: linear-gradient(145deg, #2d3561 0%, #1f2547 100%);
    color: #fff;
    text-align: center;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
}

.quantity-input:focus {
    outline: none;
    border-color: #ffc107;
    box-shadow: 0 0 12px rgba(255,193,7,0.5),
                inset 0 2px 8px rgba(0,0,0,0.3);
}

/* CENTRE */
.center {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 30px;
}

.boost-session,
.boost-personnel {
    background: linear-gradient(145deg, #2d3561 0%, #1f2547 100%);
    padding: 30px;
    border-radius: 20px;
    width: 340px;
    text-align: center;
    border: 3px solid #4a5788;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.1);
    position: relative;
}

.boost-session::before,
.boost-personnel::before {
    content: '';
    position: absolute;
    top: -3px;
    left: -3px;
    right: -3px;
    bottom: -3px;
    border-radius: 20px;
    background: linear-gradient(145deg, #4a5788, #2d3561);
    z-index: -1;
}

.boost-session h3,
.boost-session h1,
.boost-personnel h2 {
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 700;
    text-shadow: 0 2px 8px rgba(0,0,0,0.5);
}

.money-value {
    font-size: 2.4em;
    font-weight: 800;
    margin-top: 12px;
    color: #ffc107;
    text-shadow: 0 0 20px rgba(255,193,7,0.6),
                 0 4px 8px rgba(0,0,0,0.5);
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.boost-value { 
    font-size: 2.6em; 
    font-weight: 800; 
    color: #66ff66;
    text-shadow: 0 0 20px rgba(102,255,102,0.6),
                 0 4px 8px rgba(0,0,0,0.5);
}

.boost-personnel .value { 
    font-size: 2.4em;
    font-weight: 800; 
    color: #ff6b9d;
    text-shadow: 0 0 20px rgba(255,107,157,0.6),
                 0 4px 8px rgba(0,0,0,0.5);
}

/* SCROLLBAR MINIMAL */
::-webkit-scrollbar { width: 10px; }
::-webkit-scrollbar-track { 
    background: rgba(0,0,0,0.3); 
    border-radius: 10px;
}
::-webkit-scrollbar-thumb { 
    background: linear-gradient(145deg, #5a6ba8 0%, #4a5788 100%); 
    border-radius: 10px;
    border: 2px solid rgba(0,0,0,0.3);
}
::-webkit-scrollbar-thumb:hover { 
    background: linear-gradient(145deg, #6a7bc8 0%, #5a6ba8 100%); 
}

/* RESPONSIVE */
@media (max-width: 1024px) {
    .container { flex-direction: column; }
    .sidebar { width: 100%; }
    .boost-session, .boost-personnel { width: 100%; }
}
</style>
</head>

<body>
<audio id="clickSound" preload="auto"></audio>

<div class="container">

    <div class="sidebar sidebar-left">
        <h2>Am√©liorations Collectives</h2>
        <input type="number" min="1" max="1000" value="1" id="quantitySelector" class="quantity-input">
        <div class="upgrades-container" id="leftUpgrades"></div>
        <button class="toggle-btn" id="leftToggle" onclick="toggleUpgrades('left')">‚ñº Afficher plus</button>
    </div>

    <div class="center">
        <div class="boost-session">
            <h3>Total</h3>
            <div class="money-value" id="moneyValue">...</div>

            <h1 style="margin-top:20px;">Par Click</h1>
            <div class="boost-value" id="sessionBoostValue">x1.0</div>
        </div>

        <div class="boost-personnel">
            <h2>Boost Personnel</h2>
            <div class="value" id="personalBoostValue">x1.0</div>
        </div>

        <p style="font-size:0.85em; opacity:0.7;">
            Session: <span id="sessionCodeDisplay">...</span> |
            Joueur: <span id="playerIdDisplay">...</span>
        </p>
    </div>

    <div class="sidebar sidebar-right">
        <h2>Am√©liorations Personnelles</h2>
        <input type="number" min="1" max="1000" value="1" id="quantitySelectorRight" class="quantity-input">
        <div class="upgrades-container" id="rightUpgrades"></div>
        <button class="toggle-btn" id="rightToggle" onclick="toggleUpgrades('right')">‚ñº Afficher plus</button>
    </div>
</div>

<script>
const API_URL = "https://project-3-api-2bgb.onrender.com"; 
let PLAYER_ID = null, SESSION_CODE = null, money = 0;
let upgradeQueue = {}, upgradeTimeout = null;
const BATCHING_DELAY = 1000, MAX_VISIBLE_UPGRADES = 4;
const upgradePricesNumeric = {};

const COLLECTIVE_UPGRADES = [
    { id: 'upgrade1', name: 'upgrade1', label: 'üíÄ SQUELETTE  |  +0.1 par click', type: 'add', upgrade: 0.1, price: 10, color: '#B0BEC5' },
    { id: 'upgrade2', name: 'upgrade2', label: 'üî• FIRE SPIRIT  |  +1 par click', type: 'add', upgrade: 1.0, price: 100, color: '#FF5722' },
    { id: 'upgrade3', name: 'upgrade3', label: '‚ö° E-SPIRIT  |  +5 par click', type: 'add', upgrade: 5.0, price: 1000, color: '#FFD700' },
    { id: 'upgrade4', name: 'upgrade4', label: '‚ùÑÔ∏è ICE SPIRIT  |  +10 par click', type: 'add', upgrade: 10.0, price: 2500, color: '#64B5F6' },
    { id: 'upgrade5', name: 'upgrade5', label: 'üíö HEALING SPIRIT  |  +15 par click ', type: 'add', upgrade: 15.0, price: 25000, color: '#66BB6A' },
    { id: 'upgrade6', name: 'upgrade6', label: 'üë∫ GOBLIN LANCE  |  +50 par click', type: 'add', upgrade: 50.0, price: 150000, color: '#8BC34A' },
    { id: 'upgrade7', name: 'upgrade7', label: 'üí£ BOMBARDIER  |  +100 par click', type: 'add', upgrade: 100.0, price:450000, color: '#FF9800' },
    { id: 'upgrade8', name: 'upgrade8', label: 'ü¶á CHAUVE SOURIS  |  +500 par click', type: 'add', upgrade: 500.0, price:1000000, color: '#9C27B0' },
    { id: 'upgrade9', name: 'upgrade9', label: '‚ö° ZAP  |  x1,1 multiplier', type: 'multiply', upgrade: 1.1, price:10000000, color: '#00BCD4' },
    { id: 'upgrade10', name: 'upgrade10', label: 'üóø ICE GOLEM  |  +10k par click', type: 'add', upgrade: 10000.0, price:25000000, color: '#B3E5FC' },
    { id: 'upgrade11', name: 'upgrade11', label: '‚õÑ SNOWBALL  |  x1,5 par click', type: 'multiply', upgrade: 1.5, price:500000000, color: '#E1F5FE' },
    { id: 'upgrade12', name: 'upgrade12', label: 'ü™ì BERSERKER  |  +100k par click', type: 'add', upgrade: 100000.0, price:1000000000, color: '#F44336' },
    { id: 'upgrade13', name: 'upgrade13', label: 'üõ¢Ô∏è FUT BA BARBARE  |  +500k par click', type: 'add', upgrade: 500000.0, price:5500000000, color: '#FF6F00' },
    { id: 'upgrade14', name: 'upgrade14', label: 'ü™µ BUCHE  |  x2 multiplier', type: 'multiply', upgrade: 2.0, price:25000000000, color: '#795548' },
    { id: 'upgrade15', name: 'upgrade15', label: '‚õèÔ∏è SAPEURS  |  1m par click', type: 'add', upgrade: 1000000.0, price:500000000000, color: '#607D8B' },
    { id: 'upgrade16', name: 'upgrade16', label: 'üåø SUSPICIOUS BUSH  |  +10m par click', type: 'add', upgrade: 10000000.0, price:1000000000000000, color: '#4CAF50' },
    { id: 'upgrade17', name: 'upgrade17', label: 'üò° RAGE  |  x2.25 multiplier', type: 'multiply', upgrade: 2.25, price:1500000000000000, color: '#E91E63' },
    { id: 'upgrade18', name: 'upgrade18', label: 'üîÆ MALEDICTION  |  x2.5 par click', type: 'multiply', upgrade: 2.5, price:100000000000000, color: '#9C27B0' },
    { id: 'upgrade19', name: 'upgrade19', label: 'üõ°Ô∏è CHEVALIER  |  +1B par click', type: 'add', upgrade: 1000000000.0, price:500000000000000, color: '#757575' },
    { id: 'upgrade20', name: 'upgrade20', label: 'üèπ ARCHERE  |  +100B par click', type: 'add', upgrade: 100000000000.0, price:1000000000000000, color: '#EC407A' },
    { id: 'upgrade21', name: 'upgrade21', label: 'üëø GARGOUILLE  |  +5T par click', type: 'add', upgrade: 5000000000000.0, price:10000000000000000, color: '#424242' },
    { id: 'upgrade22', name: 'upgrade22', label: 'üèπ FLECHE  |  x5 multiplier', type: 'multiply', upgrade: 5.0, price:100000000000000000000, color: '#00BCD4' },
];

const PERSONAL_UPGRADES = [
    { id: 'PERSO_0_1', label: 'üíé +0.1 Perso', upgrade: 0.1, price: 200000000000 },
    { id: 'PERSO_0_5', label: 'üíé +0.5 Perso', upgrade: 0.5, price: 800000000000 },
    { id: 'PERSO_1_0', label: 'üíé +1.0 Perso', upgrade: 1.0, price: 1500000000000 },
    { id: 'PERSO_2_0', label: 'üíé +2.0 Perso', upgrade: 2.0, price: 2500000000000 },
    { id: 'PERSO_5_0', label: 'üíé +5.0 Perso', upgrade: 5.0, price: 5000000000000 },
    { id: 'PERSO_10_0', label: 'üíé +10.0 Perso', upgrade: 10.0, price: 10000000000000 },
    { id: 'PERSO_50_0', label: 'üíé +50.0 Perso', upgrade: 50.0, price: 400000000000000 },
];

async function fetchData(endpoint, options={}) {
    try {
        const response = await fetch(`${API_URL}${endpoint}`, options);
        const text = await response.text();
        try { return JSON.parse(text); } 
        catch(e){ console.error(`Erreur parsing JSON [${endpoint}]:`, text); return null; }
    } catch(err){ console.error(`Erreur r√©seau [${endpoint}]:`, err); return null;}
}

async function initUserData() {
    PLAYER_ID = localStorage.getItem("username");
    document.getElementById('playerIdDisplay').textContent = PLAYER_ID || "Non connect√©";
    if(!PLAYER_ID){ alert("ID joueur non trouv√©."); return false;}
    const sessionData = await fetchData(`/verify_session?id=${encodeURIComponent(PLAYER_ID)}`);
    if(sessionData && sessionData.session_code){
        SESSION_CODE = sessionData.session_code;
        document.getElementById('sessionCodeDisplay').textContent = SESSION_CODE;
        return true;
    } else { alert("Session active non trouv√©e."); return false;}
}

function handleUpgradeClick(id){
    const btn = document.querySelector(`button[onclick="handleUpgradeClick('${id}')"]`);
    if(btn && btn.classList.contains('disabled')) return;

    let quantity = 1;
    if(COLLECTIVE_UPGRADES.find(u => u.id === id)) {
        quantity = parseInt(document.getElementById('quantitySelector').value) || 1;
    } else if(PERSONAL_UPGRADES.find(u => u.id === id)) {
        quantity = parseInt(document.getElementById('quantitySelectorRight').value) || 1;
    }

    upgradeQueue[id] = (upgradeQueue[id]||0) + quantity;

    if(btn) btn.classList.add('clicked');
    setTimeout(()=>{if(btn) btn.classList.remove('clicked');},150);

    if(upgradeTimeout) clearTimeout(upgradeTimeout);
    upgradeTimeout = setTimeout(processUpgradeBatch, BATCHING_DELAY);
}

async function processUpgradeBatch(){
    if(Object.keys(upgradeQueue).length===0) return;
    const batch = {...upgradeQueue}; upgradeQueue={};
    for(const id in batch){
        const quantity = batch[id];
        let item = COLLECTIVE_UPGRADES.find(u=>u.id===id);
        let isPersonal=false;
        if(!item){ item=PERSONAL_UPGRADES.find(u=>u.id===id); isPersonal=true;}
        if(!item) continue;

        let success=false;
        if(isPersonal) success = await upgradePersonal(item.upgrade,item.price,quantity);
        else if(item.type==='add') success = await upgradeSessionAdd(item.upgrade,item.price,quantity,item.name);
        else if(item.type==='multiply') success = await upgradeSessionMultiply(item.upgrade,item.price,quantity,item.name);
        if(!success) console.warn(`Achat √©chou√© pour ${item.label} x${quantity}`);
    }
    await updateUI();
}

function formatNumber(num){
    if(num>=1_000_000_000) return (num/1_000_000_000).toFixed(2)+'B';
    if(num>=1_000_000) return (num/1_000_000).toFixed(2)+'M';
    if(num>=1_000) return (num/1_000).toFixed(2)+'K';
    return num.toFixed(0);
}

function toggleUpgrades(side){
    const container=document.getElementById(side+'Upgrades');
    const toggleBtn=document.getElementById(side+'Toggle');
    const upgrades=Array.from(container.children);
    if(toggleBtn.dataset.expanded==='true'){
        upgrades.forEach((btn,i)=>{if(i>=MAX_VISIBLE_UPGRADES) btn.style.display='none';});
        toggleBtn.textContent='‚ñº Afficher plus'; toggleBtn.dataset.expanded='false';
    }else{
        upgrades.forEach(btn=>btn.style.display='block');
        toggleBtn.textContent='‚ñ≤ Afficher moins'; toggleBtn.dataset.expanded='true';
    }
}

function generateUpgradeButtons(){
    const leftContainer=document.getElementById('leftUpgrades');
    const rightContainer=document.getElementById('rightUpgrades');

    leftContainer.innerHTML = COLLECTIVE_UPGRADES.map((item,index)=>{
        upgradePricesNumeric[item.id] = item.price;
        const bgColor = item.color || '#3d4a7a';
        return `<button class="upgrade-btn" onclick="handleUpgradeClick('${item.id}')"
        style="${index>=MAX_VISIBLE_UPGRADES?'display:none;':''}background: linear-gradient(145deg, ${bgColor}, ${bgColor}dd);">${item.label} (<span id="${item.id}_price">${formatNumber(item.price)}</span>)</button>`;
    }).join('');

    rightContainer.innerHTML = PERSONAL_UPGRADES.map((item,index)=>{
        upgradePricesNumeric[item.id] = item.price;
        return `<button class="upgrade-btn" onclick="handleUpgradeClick('${item.id}')"
        style="${index>=MAX_VISIBLE_UPGRADES?'display:none;':''}">${item.label} (<span id="${item.id}_price">${formatNumber(item.price)}</span>)</button>`;
    }).join('');

    document.getElementById('leftToggle').dataset.expanded='false';
    document.getElementById('rightToggle').dataset.expanded='false';
}

function updateUpgradeButtonsState() {
    const allUpgrades = [...COLLECTIVE_UPGRADES, ...PERSONAL_UPGRADES];
    const quantityLeft = parseInt(document.getElementById('quantitySelector').value) || 1;
    const quantityRight = parseInt(document.getElementById('quantitySelectorRight').value) || 1;

    allUpgrades.forEach(u=>{
        const btn = document.querySelector(`button[onclick="handleUpgradeClick('${u.id}')"]`);
        if(!btn) return;
        const numericPrice = upgradePricesNumeric[u.id];
        const quantity = COLLECTIVE_UPGRADES.find(c=>c.id===u.id) ? quantityLeft : quantityRight;
        if(numericPrice * quantity > money) btn.classList.add('disabled');
        else btn.classList.remove('disabled');
    });
}

async function updateUI(){
    if(!SESSION_CODE||!PLAYER_ID) return;

    const poiresData = await fetchData(`/get_poires?session=${encodeURIComponent(SESSION_CODE)}`);
    if(poiresData){ money = poiresData.poires; document.getElementById('moneyValue').textContent=formatNumber(money);}

    const sessionMultiData = await fetchData(`/get_session_multiplier?session=${encodeURIComponent(SESSION_CODE)}`);
    if(sessionMultiData){ const multi=sessionMultiData.by_click_multiplier.toFixed(2);
        document.getElementById('sessionBoostValue').textContent=`x${multi}`;}

    const personalBoostData = await fetchData(`/get_personnel_boost?id=${encodeURIComponent(PLAYER_ID)}`);
    if(personalBoostData){ const boost=personalBoostData.personnel_boost.toFixed(2);
        document.getElementById('personalBoostValue').textContent=`x${boost}`;}

    updateUpgradeButtonsState();
}

async function upgradeSessionAdd(upgradeValue, price, quantity, upgrade_name){
    const data = await fetchData('/upgrade_add', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ session: SESSION_CODE, upgrade: upgradeValue, price, quantity, upgrade_name })
    });
    return !!data;
}

async function upgradeSessionMultiply(upgradeMultiplier, price, quantity, upgrade_name){
    const data = await fetchData('/upgrade_multiply', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ session: SESSION_CODE, upgrade: upgradeMultiplier, price, quantity, upgrade_name })
    });
    return !!data;
}

async function upgradePersonal(boostValue, price, quantity){
    const data = await fetchData('/personnel_boost', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: PLAYER_ID, boost: boostValue, price, quantity })
    });
    return !!data;
}

async function fullSync() {
    if (!PLAYER_ID) return;

    const sessionData = await fetchData(`/verify_session?id=${encodeURIComponent(PLAYER_ID)}`);
    if (sessionData && sessionData.session_code) {
        SESSION_CODE = sessionData.session_code;
        document.getElementById('sessionCodeDisplay').textContent = SESSION_CODE;
        await updateUI();
    }

    if (SESSION_CODE) {
        const basePrices = {};
        [...COLLECTIVE_UPGRADES, ...PERSONAL_UPGRADES].forEach(u => {
            basePrices[u.id] = u.price;
        });

        const upgradesPriceData = await fetchData('/upgrades_price', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ session: SESSION_CODE, base_prices: basePrices })
        });

        if (upgradesPriceData && upgradesPriceData.upgrades_price) {
            for (const upgradeName in upgradesPriceData.upgrades_price) {
                const elem = document.getElementById(upgradeName+'_price');
                if (elem) {
                    const numeric = Number(upgradesPriceData.upgrades_price[upgradeName]);
                    upgradePricesNumeric[upgradeName] = numeric;
                    elem.textContent = formatNumber(numeric);
                }
            }
            updateUpgradeButtonsState();
        } else {
            console.warn("Aucune donn√©e upgrades_price re√ßue ou format incorrect");
        }
    }
}

async function initializeApp(){
    generateUpgradeButtons();
    const initialized = await initUserData();
    if(initialized){
        await updateUI();
        setInterval(fullSync,3000);
    } else { document.getElementById('moneyValue').textContent='Connexion requise'; }

    const clickSound = document.getElementById('clickSound');
    document.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
            try { clickSound.currentTime = 0; clickSound.play(); } catch(err){ console.warn("Son non jou√©:", err);}
        });
    });

    document.getElementById('quantitySelector').addEventListener('input', updateUpgradeButtonsState);
    document.getElementById('quantitySelectorRight').addEventListener('input', updateUpgradeButtonsState);
}

initializeApp();
</script>

</body>
</html>