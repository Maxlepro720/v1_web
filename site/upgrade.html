<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me d'Am√©lioration</title>

    <!-- FONT CLEAN -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: #1F1F1F;
            color: #eee;
            min-height: 100vh;
        }

        .container {
            display: flex;
            padding: 20px;
            gap: 20px;
            min-height: 100vh;
        }

        /* PANNEAUX */
        .sidebar {
            width: 280px;
            background: #2A2A2A;
            padding: 20px;
            border-radius: 10px;
        }

        .sidebar h2 {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3A3A3A;
        }

        .sidebar-left h2 { border-color: #4CAF50; }
        .sidebar-right h2 { border-color: #E91E63; }

        /* LISTES UPGRADE */
        .upgrades-container {
            max-height: 350px;
            overflow-y: auto;
        }

        /* BOUTONS UPGRADE */
        .upgrade-btn {
            width: 100%;
            background: #3A3A3A;
            border: 2px solid transparent;
            color: white;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.15s;
            text-align: left;
        }

        .sidebar-left .upgrade-btn:hover { border-color: #4CAF50; }
        .sidebar-right .upgrade-btn:hover { border-color: #E91E63; }

        /* BOUTON AFFICHER + / - */
        .toggle-btn {
            width: 100%;
            background: #3A3A3A;
            color: white;
            padding: 10px;
            font-size: 14px;
            border: none;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
            transition: 0.15s;
        }

        .toggle-btn:hover { background: #444; }

        /* CENTRE */
        .center {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }

        .boost-session,
        .boost-personnel {
            background: #2A2A2A;
            padding: 25px;
            border-radius: 10px;
            width: 320px;
            text-align: center;
        }

        .money-value {
            font-size: 2em;
            font-weight: 700;
            margin-top: 10px;
            color: #4CAF50;
        }

        .boost-value { font-size: 2.2em; font-weight: 700; color: #4CAF50; }
        .boost-personnel .value { font-size: 2em; color: #E91E63; }

        /* SCROLLBAR MINIMAL */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #3A3A3A; border-radius: 5px; }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .container { flex-direction: column; }
            .sidebar { width: 100%; }
            .boost-session, .boost-personnel { width: 100%; }
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- COLLECTIVES -->
        <div class="sidebar sidebar-left">
            <h2>Am√©liorations Collectives</h2>
            <div class="upgrades-container" id="leftUpgrades"></div>
            <button class="toggle-btn" id="leftToggle" onclick="toggleUpgrades('left')">‚ñº Afficher plus</button>
        </div>

        <!-- CENTRE -->
        <div class="center">
            <div class="boost-session">
                <h3>üí∞ Poires Totales</h3>
                <div class="money-value" id="moneyValue">...</div>

                <h1 style="margin-top:20px;">Boost de Session</h1>
                <div class="boost-value" id="sessionBoostValue">x1.0</div>
            </div>

            <div class="boost-personnel">
                <h2>Boost Personnel</h2>
                <div class="value" id="personalBoostValue">x1.0</div>
            </div>

            <p style="font-size:0.85em; opacity:0.7;">
                Session: <span id="sessionCodeDisplay">...</span> |
                Joueur: <span id="playerIdDisplay">...</span>
            </p>
        </div>

        <!-- PERSONNELLES -->
        <div class="sidebar sidebar-right">
            <h2>Am√©liorations Personnelles</h2>
            <div class="upgrades-container" id="rightUpgrades"></div>
            <button class="toggle-btn" id="rightToggle" onclick="toggleUpgrades('right')">‚ñº Afficher plus</button>
        </div>
    </div>
    <script>
        // ====================================================================
        // === API SETUP & CONSTANTS ===
        // ====================================================================
        
        const API_URL = "https://project-3-api-2bgb.onrender.com"; 
        
        let PLAYER_ID = null;    // R√©cup√©r√© depuis localStorage
        let SESSION_CODE = null; // R√©cup√©r√© depuis /verify_session
        
        let money = 0; 
        let isUpdateScheduled = false;

        // Variables pour le Batching (attendre 1s avant d'envoyer la requ√™te)
        let upgradeQueue = {}; // { 'upgradeId': quantity }
        let upgradeTimeout = null;
        const BATCHING_DELAY = 1000; // 1 seconde

        // ====================================================================
        // === CATALOGUES D'AM√âLIORATIONS (JSON) ===
        // ====================================================================
        
        const COLLECTIVE_UPGRADES = [
            { id: 'ADD_0_1', label: '+0.1 par click', type: 'add', upgrade: 0.1, price: 100 },
            { id: 'ADD_0_5', label: '+0.5 par click', type: 'add', upgrade: 1.0, price: 100 },
            { id: 'MUL_1_1', label: 'x1.1 Multi (200 poires)', type: 'multiply', upgrade: 1.1, price: 200 },
            { id: 'MUL_1_5', label: 'x1.5 Multi (500 poires)', type: 'multiply', upgrade: 1.5, price: 500 },
            { id: 'ADD_10_0', label: '+10.0 By Click (800 poires)', type: 'add', upgrade: 10.0, price: 800 },
            { id: 'ADD_50_0', label: '+50.0 By Click (3K poires)', type: 'add', upgrade: 50.0, price: 3000 },
            { id: 'MUL_2_0', label: 'x2.0 Multi (5K poires)', type: 'multiply', upgrade: 2.0, price: 5000 },
        ];
        
        const PERSONAL_UPGRADES = [
            { id: 'PERSO_0_1', label: '+0.1 Perso (20 poires)', upgrade: 0.1, price: 20 },
            { id: 'PERSO_0_5', label: '+0.5 Perso (80 poires)', upgrade: 0.5, price: 80 },
            { id: 'PERSO_1_0', label: '+1.0 Perso (150 poires)', upgrade: 1.0, price: 150 },
            { id: 'PERSO_2_0', label: '+2.0 Perso (250 poires)', upgrade: 2.0, price: 250 },
            { id: 'PERSO_5_0', label: '+5.0 Perso (500 poires)', upgrade: 5.0, price: 500 },
            { id: 'PERSO_10_0', label: '+10.0 Perso (1K poires)', upgrade: 10.0, price: 1000 },
            { id: 'PERSO_50_0', label: '+50.0 Perso (4K poires)', upgrade: 50.0, price: 4000 },
        ];

        // ====================================================================
        // === CORE LOGIC & API UTILITIES ===
        // ====================================================================

        async function initUserData() {
            PLAYER_ID = localStorage.getItem("username");
            document.getElementById('playerIdDisplay').textContent = PLAYER_ID || "Non connect√©";

            if (!PLAYER_ID) {
                alert("Erreur: ID joueur (username) non trouv√© dans localStorage. Connectez-vous d'abord.");
                return false;
            }

            // R√©cup√©rer le code de session actif
            const sessionData = await fetchData(`/verify_session?id=${encodeURIComponent(PLAYER_ID)}`);
            if (sessionData && sessionData.session_code) {
                SESSION_CODE = sessionData.session_code;
                document.getElementById('sessionCodeDisplay').textContent = SESSION_CODE;
                return true;
            } else {
                alert("Erreur: Session active non trouv√©e pour ce joueur.");
                return false;
            }
        }

        async function fetchData(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_URL}${endpoint}`, options);
                const data = await response.json();
                
                if (data.status === 'error') {
                    console.error(`Erreur API [${endpoint}]:`, data.message);
                    // alert(`Erreur: ${data.message}`); // D√©sactiv√© pour le batching
                    return null;
                }
                console.log(`Succ√®s API [${endpoint}]:`, data);
                return data;
            } catch (error) {
                console.error(`Erreur r√©seau/parsing [${endpoint}]:`, error);
                alert('Erreur de communication avec le serveur.');
                return null;
            }
        }

        // ====================================================================
        // === BATCHING LOGIC ===
        // ====================================================================

        /**
         * Met en file d'attente un achat d'am√©lioration et d√©clenche l'envoi group√© apr√®s BATCHING_DELAY.
         * @param {string} id - ID unique de l'am√©lioration (du catalogue JSON).
         */
        function handleUpgradeClick(id) {
            upgradeQueue[id] = (upgradeQueue[id] || 0) + 1;
            console.log(`Clic sur ${id}. Quantit√© en file: ${upgradeQueue[id]}`);

            if (upgradeTimeout) {
                clearTimeout(upgradeTimeout);
            }
            
            // R√©initialiser le timer pour regrouper tous les clics dans la BATCHING_DELAY
            upgradeTimeout = setTimeout(processUpgradeBatch, BATCHING_DELAY);
        }

        /**
         * Traite la file d'attente d'achats group√©s et envoie les requ√™tes au serveur.
         */
        async function processUpgradeBatch() {
            if (Object.keys(upgradeQueue).length === 0) return;

            const batchToProcess = { ...upgradeQueue };
            upgradeQueue = {}; // R√©initialiser la file d'attente imm√©diatement

            console.log("--- Traitement du Batch d'Upgrades ---", batchToProcess);
            
            for (const id in batchToProcess) {
                const quantity = batchToProcess[id];
                
                // 1. D√©terminer si c'est un boost collectif ou personnel
                let item = COLLECTIVE_UPGRADES.find(u => u.id === id);
                let isPersonal = false;

                if (!item) {
                    item = PERSONAL_UPGRADES.find(u => u.id === id);
                    isPersonal = true;
                }

                if (!item) {
                    console.error(`ID d'am√©lioration inconnu: ${id}`);
                    continue;
                }

                // 2. D√©terminer la fonction d'achat
                let success = false;
                if (isPersonal) {
                    success = await upgradePersonal(item.upgrade, item.price, quantity);
                } else if (item.type === 'add') {
                    success = await upgradeSessionAdd(item.upgrade, item.price, quantity);
                } else if (item.type === 'multiply') {
                    success = await upgradeSessionMultiply(item.upgrade, item.price, quantity);
                }

                if (!success) {
                    console.warn(`Achat √©chou√© pour ${item.label} (Quantit√©: ${quantity}). Le solde est insuffisant ou autre erreur.`);
                }
            }

            // Mettre √† jour l'UI une seule fois apr√®s tout le batch
            await updateUI();
        }


        // ====================================================================
        // === UI & DISPLAY UTILITIES & SYNCHRONIZATION ===
        // ====================================================================

        function formatNumber(num) {
            if (num >= 1000000000) {
                return (num / 1000000000).toFixed(2) + 'B';
            } else if (num >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num.toFixed(0);
        }

        function toggleUpgrades(side) {
            const container = document.getElementById(side + 'Upgrades');
            const button = document.getElementById(side + 'Toggle');

            if (container.classList.contains('collapsed')) {
                container.classList.remove('collapsed');
                button.innerHTML = '‚ñ≤ Afficher moins';
            } else {
                container.classList.add('collapsed');
                button.innerHTML = '‚ñº Afficher plus';
            }
        }
        
        function generateUpgradeButtons() {
            const leftContainer = document.getElementById('leftUpgrades');
            const rightContainer = document.getElementById('rightUpgrades');

            // Collective Upgrades
            leftContainer.innerHTML = COLLECTIVE_UPGRADES.map(item => {
                const totalCost = item.price; // Le co√ªt total sera calcul√© dans le batching
                const label = `${item.label} (Cout: ${formatNumber(totalCost)})`;
                return `<button class="upgrade-btn" onclick="handleUpgradeClick('${item.id}')">${label}</button>`;
            }).join('');

            // Personal Upgrades
            rightContainer.innerHTML = PERSONAL_UPGRADES.map(item => {
                const totalCost = item.price;
                 const label = `${item.label} (Cout: ${formatNumber(totalCost)})`;
                return `<button class="upgrade-btn" onclick="handleUpgradeClick('${item.id}')">${label}</button>`;
            }).join('');
        }

        /**
         * R√©cup√®re toutes les donn√©es n√©cessaires depuis l'API et met √† jour l'UI.
         */
        async function updateUI() {
            if (!SESSION_CODE || !PLAYER_ID) return; // Ne fait rien si la session n'est pas initialis√©e

            // 1. R√©cup√©rer le score (Poires)
            const poiresData = await fetchData(`/get_poires?session=${encodeURIComponent(SESSION_CODE)}`);
            if (poiresData) {
                money = poiresData.poires; 
                document.getElementById('moneyValue').textContent = formatNumber(money);
            }

            // 2. R√©cup√©rer le Multiplicateur de Session
            const sessionMultiData = await fetchData(`/get_session_multiplier?session=${encodeURIComponent(SESSION_CODE)}`);
            if (sessionMultiData) {
                const multi = sessionMultiData.by_click_multiplier.toFixed(2);
                document.getElementById('sessionBoostValue').textContent = `x${multi}`;
            }

            // 3. R√©cup√©rer le Boost Personnel
            const personalBoostData = await fetchData(`/get_personnel_boost?id=${encodeURIComponent(PLAYER_ID)}`);
            if (personalBoostData) {
                const boost = personalBoostData.personnel_boost.toFixed(2);
                document.getElementById('personalBoostValue').textContent = `x${boost}`;
            }
        }

        // Simule l'ajout de poires (clic ou autre √©v√©nement)
        async function addPoires(clickCount) {
            const data = await fetchData('/poire', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: PLAYER_ID,
                    session: SESSION_CODE,
                    click: clickCount 
                })
            });

            if (data) {
                await updateUI(); 
            }
        }

        // Fonction appel√©e toutes les 10 secondes pour synchroniser l'affichage
        function syncWithSystemClock() {
            if (!SESSION_CODE || !PLAYER_ID) return; 

            const now = new Date();
            const seconds = now.getSeconds();
            
            if (seconds % 10 === 0 && !isUpdateScheduled) {
                updateUI(); 
                isUpdateScheduled = true;
            } else if (seconds % 10 !== 0) {
                isUpdateScheduled = false;
            }
        }
        
        // ====================================================================
        // === UPGRADE API CALL FUNCTIONS ===
        // ====================================================================

        async function upgradeSessionAdd(upgradeValue, price, quantity) {
            const data = await fetchData('/upgrade_add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session: SESSION_CODE,
                    upgrade: upgradeValue,
                    price: price,
                    quantity: quantity
                })
            });
            return !!data;
        }
        
        async function upgradeSessionMultiply(upgradeMultiplier, price, quantity) {
            const data = await fetchData('/upgrade_multiply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session: SESSION_CODE,
                    upgrade: upgradeMultiplier,
                    price: price,
                    quantity: quantity
                })
            });
            return !!data;
        }
        
        async function upgradePersonal(boostValue, price, quantity) {
            const data = await fetchData('/personnel_boost', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: PLAYER_ID,
                    boost: boostValue,
                    price: price,
                    quantity: quantity
                })
            });
            return !!data;
        }

        // ====================================================================
        // === INITIALIZATION ===
        // ====================================================================

        async function initializeApp() {
            generateUpgradeButtons();
            const initialized = await initUserData();
            
            if (initialized) {
                await updateUI(); 
                setInterval(syncWithSystemClock, 1000); 
            } else {
                // Afficher un √©tat d'erreur ou de non-connexion
                document.getElementById('moneyValue').textContent = 'Connexion requise';
            }
        }
        
        initializeApp();

    </script>
</body>
</html>